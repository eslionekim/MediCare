<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

  <title>수납 결제</title>
  <link rel="stylesheet" th:href="@{/css/staff-base.css}">
  <style>
    .content-area { padding:10px; }
    .layout { display:grid; grid-template-columns:420px 1fr 340px; gap:12px; padding:10px; box-sizing:border-box; align-items:start; }
    .left-panel { display:flex; flex-direction:column; gap:10px; }
    .center-panel { display:flex; flex-direction:column; gap:10px; }
    .right-panel { display:flex; flex-direction:column; gap:10px; }
    .box { background:#fff; border:1px solid #b0b7c7; border-radius:4px; }
    .box-header { padding:6px 10px; background:var(--ui-panel-title); color:#fff; font-weight:600; font-size:13px; display:flex; justify-content:space-between; align-items:center; }
    .box-body { padding:10px; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; }
    th { background:#f3f6ff; }
    .waiting-table th, .waiting-table td { font-size:12px; padding:4px; }
    .scroll { max-height:520px; overflow:auto; }
    .btn-xs { padding:4px 10px; font-size:12px; border-radius:4px; border:1px solid #7B7B7B; background:#D5DDED; cursor:pointer; }
    .form-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; font-size:13px; }
    .form-row label { width:90px; font-weight:600; color:#444; }
    .form-row input, .form-row select { flex:1; padding:6px; border-radius:4px; border:1px solid #cbd2e1; font-size:13px; }
    .summary-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .summary-grid .form-row { margin-bottom:0; }
    .pay-btn { padding:8px 16px; border:1px solid #7B7B7B; border-radius:6px; background: var(--ui-panel-title); color:#fff; cursor:pointer; font-weight:600; }
    .pay-btn[disabled] { opacity:.5; cursor:not-allowed; }
    .hint { font-size:12px; color:#666; margin-top:6px; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal { background:#fff; border:1px solid #b0b7c7; border-radius:8px; width:360px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
    .modal-header { padding:8px 12px; background:var(--ui-panel-title); color:#fff; font-weight:600; font-size:13px; display:flex; justify-content:space-between; align-items:center; }
    .modal-body { padding:12px; display:flex; flex-direction:column; gap:10px; }
    .modal-actions { display:flex; justify-content:flex-end; gap:6px; }
  </style>
  <link rel="stylesheet" th:href="@{/css/common-base.css}">
</head>
<body>
<div class="erp-page">
  <div th:replace="~{fragments/staff-header :: header(title='수납 결제', activeTab='payments')}"></div>

  <div class="content-area">
    <div class="layout">

      <!-- 왼쪽: 금일 수납 대기 리스트 -->
      <section class="left-panel">
        <div class="box">
          <div class="box-header">
            <span>금일 수납 대기</span>
            <span style="font-weight:500; font-size:12px;">(클릭 시 해당 방문 정보 표시)</span>
          </div>
          <div class="box-body scroll">
            <table class="waiting-table">
              <thead>
              <tr>
                <th>시간</th>
                <th>방문ID</th>
                <th>환자ID</th>
                <th>환자명</th>
                <th>진료과</th>
                <th>의사</th>
                <th>상태</th>
                <th>선택</th>
              </tr>
              </thead>
              <tbody>
              <tr th:each="v : ${todayVisits}">
                <td th:text="${#temporals.format(v.visit_datetime,'HH:mm')}">09:00</td>
                <td th:text="${v.visit_id}">1</td>
                <td th:text="${v.patient != null ? v.patient.patient_id : ''}">1</td>
                <td th:text="${v.patient != null ? v.patient.name : ''}">환자명</td>
                <td th:text="${v.department != null ? v.department.name : v.department_code}">진료과</td>
                <td th:text="${v.user_account != null ? v.user_account.name : v.user_id}">의사</td>
                <td th:text="${paymentStatusByVisitId != null ? paymentStatusByVisitId[v.visit_id] : '미결제'}">상태</td>
                <td>
                  <button class="btn-xs"
                          th:onclick="|location.href='@{/payments(visitId=${v.visit_id})}'|">선택</button>
                </td>
              </tr>
              <tr th:if="${todayVisits == null or #lists.isEmpty(todayVisits)}">
                <td colspan="8">&nbsp;</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- 가운데: 청구항목 + 금액요약 -->
      <section class="center-panel">
        <div class="box" th:if="${claimItems != null}">
          <div class="box-header">
            <span>청구항목</span>
            <button class="btn-xs" type="button" id="add-claim-row"
                    th:disabled="${visit == null or paymentCompleted}">추가</button>
          </div>
          <div class="box-body scroll" style="max-height:260px;">
            <form th:action="@{/payments/claim-items}" method="post">
              <input type="hidden" name="visitId" th:value="${visit != null ? visit.visit_id : ''}">
              <select id="fee-item-select-template" style="display:none;">
                <option value="">선택</option>
                <option th:each="f : ${feeItems}"
                        th:value="${f.fee_item_code}"
                        th:text="${f.fee_item_code + ' - ' + f.name}"
                        th:attr="data-name=${f.name},data-category=${f.category},data-price=${f.base_price},data-covered=${f.is_active()}">
                </option>
              </select>
              <table>
                <thead>
                <tr>
                  <th>수가코드</th>
                  <th>항목명</th>
                  <th>구분</th>
                  <th>단가</th>
                  <th>수량</th>
                  <th>할인</th>
                  <th>합계</th>
                  <th>삭제</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="ci : ${claimItems}">
                  <td th:text="${ci.fee_item != null ? ci.fee_item.fee_item_code : ''}">F001</td>
                  <td th:text="${ci.fee_item != null ? ci.fee_item.name : ''}">항목</td>
                  <td th:text="${ci.fee_item != null && ci.fee_item.is_active() ? '급여' : '비급여'}">구분</td>
                  <td th:text="${ci.unit_price}">0</td>
                  <td>
                    <input type="hidden" name="itemId" th:value="${ci.claim_item_id}">
                    <input type="number" name="quantity" min="1" th:value="${ci.quantity}"
                           th:disabled="${paymentCompleted}">
                  </td>
                  <td th:text="${ci.discount}">0</td>
                  <td th:text="${ci.total}">0</td>
                  <td>
                    <input type="checkbox" name="deleteIds" th:value="${ci.claim_item_id}"
                           th:disabled="${paymentCompleted}">
                  </td>
                </tr>
                <tr th:if="${claimItems == null or #lists.isEmpty(claimItems)}">
                  <td colspan="8">&nbsp;</td>
                </tr>
                </tbody>
                <tbody id="claim-new-rows"></tbody>
              </table>
              <div style="text-align:right; margin-top:6px;">
                <button class="btn-xs" type="submit"
                        th:disabled="${visit == null or paymentCompleted}">저장</button>
              </div>
              <div class="hint" th:if="${paymentCompleted}">결제 완료 후 수정 불가</div>
            </form>
          </div>
        </div>

        <div class="modal-backdrop" id="claim-modal">
          <div class="modal" role="dialog" aria-modal="true" aria-labelledby="claim-modal-title">
            <div class="modal-header">
              <span id="claim-modal-title">청구항목 추가</span>
              <button class="btn-xs" type="button" id="claim-modal-close">닫기</button>
            </div>
            <div class="modal-body">
              <label>수가항목</label>
              <input type="text" id="claim-modal-search" placeholder="코드/항목명 검색">
              <select id="claim-modal-fee"></select>
              <label>수량</label>
              <input type="number" id="claim-modal-qty" min="1" value="1">
              <div class="modal-actions">
                <button class="btn-xs" type="button" id="claim-modal-add">추가</button>
              </div>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="box-header"><span>금액 요약 (보험 할인 포함)</span></div>
          <div class="box-body">
            <div class="summary-grid">
              <div class="form-row">
                <label>진료비총계</label>
                <input readonly th:value="${totalAmount}">
              </div>
              <div class="form-row">
                <label>항목 할인</label>
                <input readonly th:value="${baseDiscount}">
              </div>
              <div class="form-row">
                <label>보험 할인</label>
                <input readonly th:value="${insuranceDiscount}">
              </div>
              <div class="form-row">
                <label>총 할인</label>
                <input readonly th:value="${discountAmount}">
              </div>
              <div class="form-row" style="grid-column:1 / span 2;">
                <label>최종 결제</label>
                <input readonly th:value="${finalAmount}">
              </div>
            </div>
            <div class="hint">보험 할인은 보험코드(discount_rate) 기준으로 자동 적용됩니다.</div>
          </div>
        </div>
      </section>

      <!-- 오른쪽: 방문 정보 + 결제 -->
      <section class="right-panel">

        <!-- 방문 정보 -->
        <div class="box">
          <div class="box-header"><span>방문 정보</span></div>
          <div class="box-body">

            <div class="form-row">
              <label>방문ID</label>
              <input readonly th:value="${visit != null ? visit.visit_id : ''}">
            </div>

            <div class="form-row">
              <label>환자</label>
              <input readonly th:value="${visit != null && visit.patient != null ? visit.patient.name + ' (ID:' + visit.patient.patient_id + ')' : ''}">
            </div>

            <div class="form-row">
              <label>진료과</label>
              <input readonly th:value="${visit != null && visit.department != null ? visit.department.name : ''}">
            </div>

            <div class="form-row">
              <label>의사</label>
              <input readonly th:value="${visit != null && visit.user_account != null ? visit.user_account.name + ' (' + visit.user_account.user_id + ')' : ''}">
            </div>

            <div class="form-row">
              <label>방문일시</label>
              <input readonly th:value="${visit != null ? #temporals.format(visit.visit_datetime,'yyyy-MM-dd HH:mm') : ''}">
            </div>

            <div class="form-row">
              <label>보험</label>
              <input readonly th:value="${visit != null && visit.insurance_code != null ? visit.insurance_code.name + ' (' + visit.insurance_code.insurance_code + ')' : '없음'}">
            </div>

            <div class="form-row">
              <label>결제상태</label>
              <input readonly th:value="${paymentStatusName}">
            </div>

          </div>
        </div>

        <!-- 결제 -->
        <div class="box">
          <div class="box-header"><span>결제</span></div>
          <div class="box-body">
            <form th:action="@{/payments/pay}" method="post">
              <input type="hidden" name="visitId" th:value="${visit != null ? visit.visit_id : ''}">

              <div class="form-row">
                <label>결제수단</label>
                <select name="paymentMethodCode" required>
                  <option value="">선택</option>
                  <option th:each="pm : ${paymentMethods}"
                          th:value="${pm.payment_method_code}"
                          th:text="${pm.name}">
                  </option>
                </select>
              </div>

              <div class="form-row">
                <label>결제금액</label>
                <input name="amountView" readonly th:value="${finalAmount}">
              </div>

              <div style="text-align:right;">
                <button class="pay-btn" type="submit"
                        th:disabled="${visit == null or !claimReady or paymentCompleted}">결제</button>
              </div>
              <div class="hint" th:if="${!claimReady}">청구/청구항목이 없습니다. 차트에서 청구를 생성한 뒤 결제해 주세요.</div>
            </form>
            <form th:action="@{/payments/refund}" method="post" style="margin-top:8px; text-align:right;">
              <input type="hidden" name="visitId" th:value="${visit != null ? visit.visit_id : ''}">
              <button class="pay-btn" type="submit"
                      th:disabled="${visit == null or !paymentCompleted}"
                      style="background:#D5DDED; color:#333;">환불</button>
            </form>
          </div>
        </div>

      </section>
    </div>
  </div>
</div>
<script>
(function() {
  const addBtn = document.getElementById("add-claim-row");
  const tbody = document.getElementById("claim-new-rows");
  const template = document.getElementById("fee-item-select-template");
  const modal = document.getElementById("claim-modal");
  const modalClose = document.getElementById("claim-modal-close");
  const modalAdd = document.getElementById("claim-modal-add");
  const modalFee = document.getElementById("claim-modal-fee");
  const modalQty = document.getElementById("claim-modal-qty");
  const modalSearch = document.getElementById("claim-modal-search");
  if (!addBtn || !tbody || !template) return;

  function updateRow(row) {
    const select = row.querySelector("select");
    const qtyInput = row.querySelector("input[name=\"newQuantity\"]");
    const nameCell = row.querySelector(".new-name");
    const coveredCell = row.querySelector(".new-covered");
    const priceCell = row.querySelector(".new-price");
    const totalCell = row.querySelector(".new-total");
    if (!select || !qtyInput) return;
    const opt = select.options[select.selectedIndex];
    const price = opt ? parseInt(opt.dataset.price || "0", 10) : 0;
    const qty = parseInt(qtyInput.value || "0", 10);
    if (nameCell) nameCell.textContent = opt ? (opt.dataset.name || "") : "";
    if (coveredCell) coveredCell.textContent =
      opt && (opt.dataset.covered === "true" || opt.dataset.covered === "1")
        ? "급여"
        : "비급여";
    if (priceCell) priceCell.textContent = isNaN(price) ? "" : price;
    if (totalCell) totalCell.textContent = isNaN(price) || isNaN(qty) ? "" : (price * qty);
  }

  function addRow() {
    const row = document.createElement("tr");
    const select = template.cloneNode(true);
    select.removeAttribute("id");
    select.style.display = "";
    select.name = "newFeeItemCode";
    if (modalFee && modalFee.value) {
      select.value = modalFee.value;
    }
    row.appendChild(document.createElement("td")).appendChild(select);
    row.appendChild(document.createElement("td")).className = "new-name";
    row.appendChild(document.createElement("td")).className = "new-covered";
    row.appendChild(document.createElement("td")).className = "new-price";
    const qtyTd = document.createElement("td");
    const qtyInput = document.createElement("input");
    qtyInput.type = "number";
    qtyInput.name = "newQuantity";
    qtyInput.min = "1";
    qtyInput.value = modalQty && modalQty.value ? modalQty.value : "1";
    qtyTd.appendChild(qtyInput);
    row.appendChild(qtyTd);
    row.appendChild(document.createElement("td")).textContent = "0";
    row.appendChild(document.createElement("td")).className = "new-total";
    const removeTd = document.createElement("td");
    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.className = "btn-xs";
    removeBtn.textContent = "삭제";
    removeBtn.addEventListener("click", function() { row.remove(); });
    removeTd.appendChild(removeBtn);
    row.appendChild(removeTd);
    tbody.appendChild(row);
    select.addEventListener("change", function() { updateRow(row); });
    qtyInput.addEventListener("input", function() { updateRow(row); });
    updateRow(row);
  }

  function openModal() {
    if (!modal || !modalFee) {
      addRow();
      return;
    }
    modalFee.innerHTML = template.innerHTML;
    modalFee.value = "";
    if (modalQty) modalQty.value = "1";
    if (modalSearch) modalSearch.value = "";
    modal.style.display = "flex";
  }

  function closeModal() {
    if (modal) modal.style.display = "none";
  }

  addBtn.addEventListener("click", openModal);
  if (modalClose) modalClose.addEventListener("click", closeModal);
  if (modal) modal.addEventListener("click", function(e) { if (e.target === modal) closeModal(); });
  if (modalAdd) {
    modalAdd.addEventListener("click", function() {
      addRow();
      closeModal();
    });
  }

  if (modalSearch && modalFee) {
    modalSearch.addEventListener("input", function() {
      const keyword = (modalSearch.value || "").toLowerCase();
      const options = modalFee.options;
      for (let i = 0; i < options.length; i++) {
        const opt = options[i];
        const text = (opt.textContent || "").toLowerCase();
        opt.hidden = keyword !== "" && !text.includes(keyword);
      }
      if (modalFee.selectedOptions.length && modalFee.selectedOptions[0].hidden) {
        modalFee.value = "";
      }
    });
  }
})();
</script>
</body>
</html>

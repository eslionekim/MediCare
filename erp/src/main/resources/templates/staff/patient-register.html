<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>환자 등록/수정</title>
    <style>
        body { margin:0; padding:0; font-family:'Inter','맑은 고딕',sans-serif; background:#D5DDED; }
        .erp-page { width:1280px; margin:24px auto; background:#fff; box-shadow:0 4px 8px rgba(0,0,0,0.15); }
        .top-bar { display:flex; justify-content:space-between; align-items:center; padding:5px 15px; background:#fff; font-size:14px; }
        .user-info { color:#555; }
        .action-buttons { display:flex; gap:5px; }
        .action-buttons button, .btn-logout { padding:4px 12px; border-radius:4px; cursor:pointer; font-size:13px; font-weight:500; border:1px solid #7B7B7B; }
        .btn-logout { background:#FF4B4B; color:#fff; }
        .time-in { background:#879BD5; color:#fff; }
        .time-out { background:#D5DDED; }
        .nav-tabs { background:#D5DDED; padding:0 10px; }
        .tab-list { list-style:none; display:flex; padding:0; margin:0; }
        .tab-item a { display:block; padding:8px 15px; text-decoration:none; color:#333; font-size:14px; }
        .tab-item.active a { font-weight:600; }
        .sub-menu { background:#BACCFF; padding:5px 15px; font-size:14px; color:#555; font-weight:530; }
        .content-area { padding:10px; }
        .layout-two-column { display:flex; gap:12px; padding:10px; box-sizing:border-box; }
        .left-panel { flex:2.5; display:flex; flex-direction:column; gap:10px; }
        .right-panel { flex:1.2; display:flex; flex-direction:column; gap:10px; }
        .search-row { display:flex; gap:8px; }
        .search-box { flex:1; display:flex; align-items:center; background:#fff; border-radius:999px; border:1px solid #b0b7c7; padding:4px 10px; }
        .search-box input { border:none; outline:none; font-size:13px; flex:1; background:transparent; }
        .btn-small { padding:5px 12px; font-size:13px; border-radius:4px; border:1px solid #7B7B7B; background:#879BD5; color:#fff; cursor:pointer; }
        .patient-table-box { background:#fff; border:1px solid #b0b7c7; border-radius:4px; height:520px; overflow-y:auto; }
        .patient-table-box table { width:100%; border-collapse:collapse; font-size:13px; }
        .patient-table-box th, .patient-table-box td { border:1px solid #ccc; padding:6px; }
        .patient-table-box th { background:#f3f6ff; }
        .btn-xs { padding:4px 10px; font-size:12px; border-radius:4px; border:1px solid #7B7B7B; background:#D5DDED; cursor:pointer; }
        .card { border:1px solid #b0b7c7; border-radius:4px; background:#f7f9ff; }
        .card-header { display:flex; justify-content:space-between; align-items:center; padding:6px 10px; font-size:13px; font-weight:600; background:#879BD5; color:#fff; }
        .card-body { background:#fff; padding:10px; }
        .form-row { display:flex; gap:6px; margin-bottom:8px; font-size:13px; }
        .form-row label { width:70px; font-weight:500; }
        .form-row input, .form-row select { flex:1; padding:5px; border-radius:4px; border:1px solid #cbd2e1; font-size:13px; }
        .btn-new { align-self:flex-end; padding:6px 14px; background:#879BD5; color:#fff; border-radius:4px; border:1px solid #7B7B7B; cursor:pointer; }
        .quick-buttons { display:flex; gap:6px; }
        .card-body table { width:100%; border-collapse:collapse; font-size:12px; }
        .card-body th, .card-body td { border:1px solid #ccc; padding:4px 6px; }
        .card-body th { background:#f3f6ff; }
    </style>
</head>
<body>
<div class="erp-page">
    <div th:replace="~{fragments/staff-header :: header(title='환자 등록/수정', activeTab='patients')}"></div>

    <div class="content-area">
        <div class="layout-two-column">
            <!-- 왼쪽: 리스트 -->
            <section class="left-panel">
                <form class="search-row" th:action="@{/patients}" method="get">
                    <div class="search-box">
                        <span>검색</span>
                        <input type="text" name="keyword" placeholder="환자 검색" th:value="${keyword}">
                    </div>
                    <button class="btn-small" type="submit">조회</button>
                </form>

                <div class="patient-table-box">
                    <table>
                        <thead>
                        <tr>
                            <th>환자ID</th>
                            <th>환자명</th>
                            <th>성별</th>
                            <th>생년월일</th>
                            <th>최종 내원일</th>
                            <th>메모</th>
                            <th>전화번호</th>
                            <th>상태</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="p : ${patients}">
                            <td th:text="${p.patient_id}"></td>
                            <td th:text="${p.name}"></td>
                            <td th:text="${p.gender}"></td>
                            <td th:text="${p.birth_date}"></td>
                            <td th:text="${lastVisitMap[p.patient_id] != null ? lastVisitMap[p.patient_id] : '없음'}"></td>
                            <td th:text="${p.note}"></td>
                            <td th:text="${p.phone}"></td>
                            <td>
                                <span>당일 방문</span>
                                <button class="btn-xs"
                                        th:onclick="|location.href='@{/patients(patientId=${p.patient_id})}'|">
                                    상세보기
                                </button>
                            </td>
                        </tr>
                        <tr th:if="${patients == null or #lists.isEmpty(patients)}">
                            <td colspan="8">&nbsp;</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 오른쪽: 상세/등록 -->
            <section class="right-panel">
                <button class="btn-new" type="button"
                        th:onclick="|location.href='@{/patients/register}'|">신규 등록</button>

                <form th:action="@{/patients/save}" method="post">
                    <section class="card">
                        <div class="card-header">
                            <span>환자 정보</span>
                            <button class="btn-xs" type="submit"
                                    th:text="${mode == 'detail' ? '수정' : '등록'}"></button>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <label>환자ID</label>
                                <input type="text" name="patientId" th:value="${selected != null ? selected.patient_id : ''}" readonly />
                            </div>
                            <div class="form-row">
                                <label>이름</label>
                                <input type="text" name="name" th:value="${selected != null ? selected.name : ''}" />
                            </div>
                            <div class="form-row">
                                <label>주민번호</label>
                                <input type="text" name="rrn" th:value="${selected != null ? selected.rrn : ''}" />
                            </div>
                            <div class="form-row">
                                <label>성별</label>
                                <select name="gender">
                                    <option value="" th:selected="${selected == null or selected.gender == null}">선택</option>
                                    <option value="M" th:selected="${selected != null and selected.gender == 'M'}">남</option>
                                    <option value="F" th:selected="${selected != null and selected.gender == 'F'}">여</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <label>생년월일</label>
                                <input type="text" name="birth_date" placeholder="YYYY-MM-DD" th:value="${selected != null ? selected.birth_date : ''}" />
                            </div>
                            <div class="form-row">
                                <label>전화번호</label>
                                <input type="text" name="phone" th:value="${selected != null ? selected.phone : ''}" />
                            </div>
                            <div class="form-row">
                                <label>이메일</label>
                                <input type="email" name="email" th:value="${selected != null ? selected.email : ''}" />
                            </div>
                            <div class="form-row">
                                <label>주소1</label>
                                <input type="text" name="address1" th:value="${selected != null ? selected.address1 : ''}" />
                            </div>
                            <div class="form-row">
                                <label>주소2</label>
                                <input type="text" name="address2" th:value="${selected != null ? selected.address2 : ''}" />
                            </div>
                            <div class="form-row">
                                <label>메모</label>
                                <input type="text" name="note" th:value="${selected != null ? selected.note : ''}" />
                            </div>
                        </div>
                    </section>
                </form>

                <div class="quick-buttons">
                    <button class="btn-small"
                            th:if="${selected != null}"
                            th:onclick="|location.href='@{/reservations(patientId=${selected.patient_id})}'|">
                        예약 바로가기
                    </button>

                    <button class="btn-small"
                        th:if="${selected != null}"
                        th:onclick="|location.href='@{/receptions(patientId=${selected.patient_id})}'|">
                        접수 바로가기
                    </button>
                </div>

                <section class="card">
                    <div class="card-header">외래 history 정보</div>
                    <div class="card-body">
                        <table>
                            <thead>
                            <tr>
                                <th>내원일자</th>
                                <th>진료의사</th>
                                <th>초/재진</th>
                                <th>증상</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="h : ${outHistories}">
                                <td th:text="${h.visitDate}"></td>
                                <td th:text="${h.doctorName}"></td>
                                <td th:text="${h.firstOrReturn}"></td>
                                <td th:text="${h.symptom}"></td>
                            </tr>
                            <tr th:if="${outHistories == null or #lists.isEmpty(outHistories)}">
                                <td colspan="4">&nbsp;</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <section class="card">
                    <div class="card-header">입원 history 정보</div>
                    <div class="card-body">
                        <table>
                            <thead>
                            <tr>
                                <th>입원일자</th>
                                <th>퇴원일자</th>
                                <th>진료의사</th>
                                <th>증상</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="h : ${inHistories}">
                                <td th:text="${h.admissionDate}"></td>
                                <td th:text="${h.dischargeDate}"></td>
                                <td th:text="${h.doctorName}"></td>
                                <td th:text="${h.symptom}"></td>
                            </tr>
                            <tr th:if="${inHistories == null or #lists.isEmpty(inHistories)}">
                                <td colspan="4">&nbsp;</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

            </section>
        </div>
    </div>
</div>
</body>
</html>

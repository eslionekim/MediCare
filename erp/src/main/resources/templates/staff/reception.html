<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

    <title>접수</title>
    <link rel="stylesheet" th:href="@{/css/staff-base.css}">
    <style>
        .content-area { padding:10px; }
        .layout-two-column { display:flex; gap:12px; padding:10px; box-sizing:border-box; }
        .left-panel { flex:1.1; display:flex; flex-direction:column; gap:10px; }
        .right-panel { flex:1.9; display:flex; flex-direction:column; gap:10px; }
        .card { border:1px solid #b0b7c7; border-radius:4px; background:#f7f9ff; }
        .card-header { display:flex; justify-content:space-between; align-items:center; padding:6px 10px; font-size:13px; font-weight:600; background:var(--ui-panel-title); color:#fff; }
        .card-body { background:#fff; padding:10px; }
        .form-row { display:flex; gap:6px; margin-bottom:6px; font-size:13px; align-items:center; }
        .form-row label { width:70px; font-weight:500; }
        .form-row input, .form-row select, .form-row textarea { flex:1; padding:5px; border-radius:4px; border:1px solid #cbd2e1; font-size:13px; }
        .form-row textarea { min-height:60px; resize:vertical; }
        .history-table { width:100%; border-collapse:collapse; font-size:12px; }
        .history-table th, .history-table td { border:1px solid #ccc; padding:4px 5px; text-align:center; }
        .history-table th { background:#f3f6ff; }
        .tabs-small { display:flex; border-bottom:1px solid #b0b7c7; background:#f0f3ff; }
        .tabs-small div { padding:6px 12px; font-size:13px; cursor:pointer; }
        .tabs-small .active { background:#ffffff; border-left:1px solid #b0b7c7; border-right:1px solid #b0b7c7; border-top:2px solid var(--ui-panel-title); font-weight:600; }
        .discount-row { display:flex; gap:4px; margin-top:6px; font-size:12px; }
        .discount-row div { flex:1; border:1px solid #cbd2e1; padding:4px 5px; text-align:center; }
        .summary-bar { font-size:13px; text-align:right; }
        .waiting-box { border:1px solid #b0b7c7; border-radius:4px; background:#ffffff; height:260px; overflow-y:auto; padding:6px; font-size:12px; }
        .waiting-header { display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px; }
        .waiting-item { padding:3px 4px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; }

        /* 예약 선택 모달 */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:9999; }
        .modal-overlay.open { display:flex; }
        .modal { width:min(920px, calc(100% - 48px)); background:#fff; border-radius:8px; box-shadow:0 12px 30px rgba(0,0,0,0.25); overflow:hidden; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:var(--ui-panel-title); color:#fff; font-weight:600; }
        .modal-body { padding:12px; }
        .modal-footer { display:flex; justify-content:flex-end; gap:8px; padding:10px 12px; border-top:1px solid #e6e6e6; background:#fafbff; }
        .btn { padding:6px 12px; border:1px solid #7B7B7B; border-radius:6px; cursor:pointer; font-size:13px; background:#D5DDED; }
        .btn-primary { background:var(--ui-panel-title); color:#fff; }
        .btn-secondary { background:#fff; }
    
    </style>
	
<link rel="stylesheet" th:href="@{/css/common-base.css}">
</head>
<body>
<div class="erp-page">
    <div th:replace="~{fragments/staff-header :: header(title='접수', activeTab='receptions')}"></div>

    <div class="content-area">
        <div class="layout-two-column">

            <section class="left-panel">
                <section class="card">
                    <div class="card-header"><span>환자 정보</span></div>
                    <div class="card-body">
                        <form class="form-row" th:action="@{/receptions}" method="get">
                            <label>환자검색</label>
                            <input type="text" name="patientKeyword" placeholder="이름/전화/주민번호"
                                   th:value="${patientKeyword != null ? patientKeyword : ''}">
                            <input type="hidden" name="date" th:value="${date != null ? #temporals.format(date, 'yyyy-MM-dd') : ''}">
                            <button type="submit" class="btn btn-primary">검색</button>
                        </form>
                        <div th:if="${patientSearchResults != null and !#lists.isEmpty(patientSearchResults)}" style="margin-bottom:8px;">
                            <table class="history-table">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>환자명</th>
                                    <th>생년월일</th>
                                    <th>전화</th>
                                    <th>선택</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="p : ${patientSearchResults}">
                                    <td th:text="${p.patient_id}">1</td>
                                    <td th:text="${p.name}">환자명</td>
                                    <td th:text="${p.birth_date != null ? p.birth_date : ''}"></td>
                                    <td th:text="${p.phone != null ? p.phone : ''}"></td>
                                    <td>
                                        <button type="button" class="btn btn-secondary"
                                                th:onclick="|location.href='@{/receptions(patientId=${p.patient_id}, date=${date})}'|">선택</button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="form-row">
                            <label>환자ID</label>
                            <input type="text" th:value="${selectedPatient != null ? selectedPatient.patient_id : ''}" readonly />
                        </div>
                        <div class="form-row">
                            <label>환자명</label>
                            <input type="text" th:value="${selectedPatient != null ? selectedPatient.name : ''}" readonly />
                        </div>
                        <div class="form-row">
                            <label>생년월일</label>
                            <input type="text" th:value="${selectedPatient != null ? selectedPatient.birth_date : ''}" readonly />
                        </div>
                        <div class="form-row">
                            <label>전화번호</label>
                            <input type="text" th:value="${selectedPatient != null ? selectedPatient.phone : ''}" readonly />
                        </div>
                        <div class="form-row">
                            <label>주소1</label>
                            <input type="text" th:value="${selectedPatient != null ? selectedPatient.address1 : ''}" readonly />
                        </div>
                        <div class="form-row">
                            <label>주소2</label>
                            <input type="text" th:value="${selectedPatient != null ? selectedPatient.address2 : ''}" readonly />
                        </div>
                        <div class="form-row">
                            <label>메모</label>
                            <input type="text" th:value="${selectedPatient != null ? selectedPatient.note : ''}" readonly />
                        </div>
                        <div class="form-row">
                            <label>이메일</label>
                            <input type="text" th:value="${selectedPatient != null ? selectedPatient.email : ''}" readonly />
                        </div>
                    </div>
                </section>

                <section class="card">
                    <div class="card-header">외래 history 정보</div>
                    <div class="card-body">
                        <table class="history-table">
                            <thead>
                            <tr>
                                <th>내원일시</th>
                                <th>진료과</th>
                                <th>진료의사</th>
                                <th>초/재진</th>
                                <th>증상/메모</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="h : ${visitHistories}">
                                <td th:text="${h.visit_datetime != null ? #temporals.format(h.visit_datetime, 'yyyy-MM-dd HH:mm') : ''}"></td>
                                <td th:text="${h.department != null ? h.department.name : ''}"></td>
                                <td th:text="${h.user_account != null ? h.user_account.name : ''}"></td>
                                <td th:text="${h.visit_type}"></td>
                                <td th:text="${h.note}"></td>
                            </tr>
                            <tr th:if="${visitHistories == null or #lists.isEmpty(visitHistories)}">
                                <td colspan="5">&nbsp;</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <section class="card">
                    <div class="card-header">입원 history 정보</div>
                    <div class="card-body">
                        <table class="history-table">
                            <thead>
                            <tr>
                                <th>입원일자</th>
                                <th>퇴원일자</th>
                                <th>진료의사</th>
                                <th>증상</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td colspan="4">&nbsp;</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

            </section>

            <section class="right-panel">

                <div class="tabs-small">
                    <div class="active">외래 접수 정보</div>
                    <div>입원 접수 정보</div>
                </div>

                <section class="card">
                    <div class="card-body">
                        <form th:action="@{/receptions/save}" method="post">
                            <input type="hidden" name="patientId" th:value="${selectedPatient != null ? selectedPatient.patient_id : ''}" />
                            <input type="hidden" name="reservationId" id="reservationId" value="" />

                            <div class="form-row">
                                <label>예약</label>
                                <button type="button"
                                        class="btn btn-primary"
                                        id="openReservationModalBtn"
                                        th:disabled="${selectedPatient == null or confirmedReservations == null or #lists.isEmpty(confirmedReservations)}">
                                    예약 선택 (<span th:text="${confirmedReservations != null ? #lists.size(confirmedReservations) : 0}">0</span>)
                                </button>
                                <button type="button" class="btn btn-secondary" id="clearReservationBtn" disabled>예약 해제</button>
                            </div>

                            <div class="form-row">
                                <label>진료과</label>
                                <select name="departmentCode" id="deptSelect" required>
                                    <option value="">선택</option>
                                    <option th:each="d : ${departments}" th:value="${d.department_code}" th:text="${d.name}"></option>
                                </select>
                            </div>

                            <div class="form-row">
                                <label>진료의사</label>
                                <select name="user_id" id="doctorSelect" required>
                                    <option value="">선택</option>
                                    <option th:each="doc : ${doctorProfiles}" th:value="${doc.user_account.user_id}" th:text="${doc.user_account.name}" th:data-dept="${doc.department.department_code}"></option>
                                </select>
                            </div>

                            <div class="form-row">
                                <label>진료구분</label>
                                <select name="visit_type">
                                    <option th:each="t : ${visit_types}" th:value="${t}" th:text="${t}"></option>
                                </select>
                            </div>

                            <div class="form-row">
                                <label>내원경로</label>
                                <select name="visitRoute" id="visitRouteSelect">
                                    <option th:each="r : ${visitRoutes}" th:value="${r}" th:text="${r}"></option>
                                </select>
                            </div>

                            <div class="form-row">
                                <label>보험코드</label>
                                <select name="insurance_code">
                                    <option value="">선택</option>
                                    <option th:each="ic : ${insuranceCodes}"
                                            th:value="${ic.insurance_code}"
                                            th:text="${ic.name}"></option>
                                </select>
                            </div>

                            <div class="form-row">
                                <label>메모</label>
                                <textarea name="note"></textarea>
                            </div>

                            <div style="text-align:right; margin-top:10px;">
                                <button type="submit" class="time-in">접수</button>
                            </div>
                        </form>
                    </div>
                </section>

                <div class="summary-bar">
                    금일 접수 현황: <span th:text="${todayTotal}">0</span>명 / 대기인원 <span th:text="${todayWaiting}">0</span>명
                </div>

                <section class="card">
                    <div class="card-header">
                        <span>대기자 관리</span>
                        <span th:text="${date != null ? #temporals.format(date, 'yyyy-MM-dd') : ''}"></span>
                    </div>
                    <div class="card-body">
                        <div class="waiting-box">
                            <div class="waiting-header">
                                <span>환자 / 진료과 / 의사</span>
                                <span>상태</span>
                            </div>

                            <div th:each="w : ${waitingVisits != null ? waitingVisits : {}}" class="waiting-item">
                                <span th:text="${w.visit_id}">1</span>
                                <span th:text="${w.department != null ? w.department.name : ''}"></span>
                                <span th:text="${w.status_code != null ? w.status_code.status_code : ''}"></span>
                            </div>

                            <div th:if="${waitingVisits == null or #lists.isEmpty(waitingVisits)}">
                                대기중인 환자가 없습니다.
                            </div>
                        </div>
                    </div>
                </section>

            </section>
        </div>
    </div>
</div>

<!-- 예약 선택 모달 -->
<div class="modal-overlay" id="reservationModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="reservationModalTitle">
        <div class="modal-header">
            <div id="reservationModalTitle">예약 선택 (확정/대기)</div>
            <button type="button" class="btn btn-secondary" id="closeReservationModalBtn">닫기</button>
        </div>
        <div class="modal-body">
            <table class="history-table">
                <thead>
                <tr>
                    <th>예약ID</th>
                    <th>예약시간</th>
                    <th>진료과</th>
                    <th>의사</th>
                    <th>상태</th>
                    <th>메모</th>
                    <th>선택</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="r : ${confirmedReservations}">
                    <td th:text="${r.reservation_id}">1</td>
                    <td th:text="${r.start_time != null ? #temporals.format(r.start_time, 'yyyy-MM-dd HH:mm') : ''}">2025-12-16 10:00</td>
                    <td th:text="${r.department != null ? r.department.name : ''}">진료과</td>
                    <td th:text="${r.user != null ? r.user.name : ''}">의사</td>
                    <td th:text="${r.status_code != null ? r.status_code.name : ''}">상태</td>
                    <td th:text="${r.note}"></td>
                    <td>
                        <button type="button"
                                class="btn btn-primary select-reservation-btn"
                                th:attr="data-reservation-id=${r.reservation_id}, data-dept=${r.department != null ? r.department.department_code : ''}, data-doctor=${r.user != null ? r.user.user_id : ''}">
                            선택
                        </button>
                    </td>
                </tr>
                <tr th:if="${confirmedReservations == null or #lists.isEmpty(confirmedReservations)}">
                    <td colspan="7">선택 가능한 예약이 없습니다.</td>
                </tr>
                </tbody>
            </table>
            <div class="hint" style="margin-top:8px; font-size:12px; color:#666;">
                예약을 선택하면 진료과/의사/내원경로(예약)가 자동으로 설정됩니다.
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="closeReservationModalBtn2">닫기</button>
        </div>
    </div>
</div>

<script>
    // 진료과 선택 시 의사 목록 필터링
    const deptSelect = document.getElementById('deptSelect');
    const doctorSelect = document.getElementById('doctorSelect');
    const visitRouteSelect = document.getElementById('visitRouteSelect');
    const reservationIdInput = document.getElementById('reservationId');
    const openReservationModalBtn = document.getElementById('openReservationModalBtn');
    const clearReservationBtn = document.getElementById('clearReservationBtn');
    const reservationModal = document.getElementById('reservationModal');
    const closeReservationModalBtn = document.getElementById('closeReservationModalBtn');
    const closeReservationModalBtn2 = document.getElementById('closeReservationModalBtn2');

    function filterDoctors() {
        const dept = deptSelect.value;
        const options = doctorSelect.querySelectorAll('option');
        options.forEach(opt => {
            const d = opt.getAttribute('data-dept');
            if (!d) return; // 첫 번째 "선택" 옵션
            opt.style.display = (!dept || d === dept) ? '' : 'none';
        });
        // 현재 선택된 의사가 다른 과라면 초기화
        if (doctorSelect.selectedOptions.length > 0) {
            const sel = doctorSelect.selectedOptions[0];
            if (sel.getAttribute('data-dept') !== dept) {
                doctorSelect.value = '';
            }
        }
    }

    if (deptSelect && doctorSelect) {
        deptSelect.addEventListener('change', filterDoctors);
    }

    function openReservationModal() {
        if (!reservationModal) return;
        reservationModal.classList.add('open');
    }

    function closeReservationModal() {
        if (!reservationModal) return;
        reservationModal.classList.remove('open');
    }

    function applyReservation(reservationId, deptCode, doctorId) {
        reservationIdInput.value = reservationId || '';
        clearReservationBtn.disabled = !reservationIdInput.value;

        if (deptCode) {
            deptSelect.value = deptCode;
            filterDoctors();
        }
        if (doctorId) {
            doctorSelect.value = doctorId;
        }
        if (visitRouteSelect) {
            visitRouteSelect.value = '예약';
        }
    }

    function clearReservation() {
        reservationIdInput.value = '';
        clearReservationBtn.disabled = true;
    }

    if (openReservationModalBtn) {
        openReservationModalBtn.addEventListener('click', openReservationModal);
    }
    if (closeReservationModalBtn) {
        closeReservationModalBtn.addEventListener('click', closeReservationModal);
    }
    if (closeReservationModalBtn2) {
        closeReservationModalBtn2.addEventListener('click', closeReservationModal);
    }
    if (reservationModal) {
        reservationModal.addEventListener('click', (e) => {
            if (e.target === reservationModal) closeReservationModal();
        });
    }
    if (clearReservationBtn) {
        clearReservationBtn.addEventListener('click', clearReservation);
    }

    document.querySelectorAll('.select-reservation-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const reservationId = btn.getAttribute('data-reservation-id');
            const deptCode = btn.getAttribute('data-dept');
            const doctorId = btn.getAttribute('data-doctor');

            applyReservation(reservationId, deptCode, doctorId);
            closeReservationModal();
        });
    });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

    <title>MediCare</title>
	<!-- 구글 폰트 링크 -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>/* 전체 리셋 및 기본 배경 */
		
	html, body {
		height: 100%;
		overflow: hidden;        /* 화면 전체 스크롤 막기 */
	}
	body {
	    margin: 0;
	    padding: 0;
	    font-family: 'Inter', '맑은 고딕', sans-serif;
	    background-color: #D5DDED; /* 이미지의 연한 푸른색 배경 */
	
	}
	
	
	/* 상단 헤더 배경 및 레이아웃 */
	.top-bar {
	    display: flex;
	    justify-content: space-between;
	    align-items: center;
	    padding: 5px 15px;
	    background-color: #ffffff; /* 흰색 배경 */
	    font-size: 14px;
	}
	
	/* 상단 헤더 텍스트 스타일 */
	.user-info {
	    color: #555;
	}
	
	/* 상단 헤더 -> 로그아웃 출근 퇴근 배열 */
	.action-buttons {
	    display: flex;
	    gap: 5px;
	}
	
	/* 상단 헤더 -> 로그아웃 출근 퇴근 공통스타일 */
	.action-buttons button {
	    padding: 4px 12px;
	    border: none;
	    border-radius: 4px;
	    cursor: pointer;
	    font-weight: 500;
	    font-size: 13px;
		border: 1px solid #7B7B7B;
	}
	
	/* 상단 헤더 -> 로그아웃 버튼 스타일 */
	.btn-logout {
		padding: 4px 12px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-weight: 500;
		font-size: 13px;
		color: white;
	    background-color: #FF4B4B;
		border: 1px solid #7B7B7B;
	}
	
	/* 상단 헤더 -> 출근 버튼 스타일 */
	.time-in {
	    background-color: #879BD5;
		color:#ffffff;
	}
	
	/* 상단 헤더 -> 퇴근 버튼 스타일 */
	.time-out {
	    background-color: #D5DDED;
	    color: #000;
	}

	/* 중앙 헤더 -> 카테고리 배치 */
	.tab-list {
	    list-style: none; /* 앞에 점 제거*/
	    margin: 0;
	    padding: 0;
	    display: flex; /* 가로 나열*/
	}
	
	/* 중앙 헤더 -> 카테고리 요소 스타일 */
	.tab-item a {
	    display: block;
	    padding: 8px 15px;
	    text-decoration: none; /* 카테고리 밑줄 제거*/
	    color: #333; /* 글자 색*/
	    background-color: transparent; /* 배경색 투명 (nav-tabs의 배경색 사용) */
	    border: none; /* 경계선 제거 */
	    font-size: 14px;
	    font-weight: normal;
	}
	
	/* 2. 중앙 헤더 공통 ⭐ */
	.nav-tabs {
		background-color: #D5DDED; /* 이미지의 균일한 하늘색 배경 */
		padding: 0 10px;
	}
	
	/* 중앙 헤더 -> 카테고리 호버 */
	.tab-item:hover {
	    background-color: rgba(255, 255, 255, 0.3); /* 마지막 숫자가 컬러 세기 정도*/
	}
	
	/* 중앙 헤더 -> 선택된 카테고리 스타일 */
	.tab-item.active a {
	    color: #333; /* 텍스트 색상은 검은색 유지 (사진처럼) */
	    font-weight: 550;
	    /* 하단에 진한 파란색 선으로 강조 */
	}
	
	
	/* 3. 하단 헤더  */
	.sub-menu {
	    background-color: #BACCFF; /* 흰색 배경 */
	    padding: 5px 15px; /* 패딩을 줄여서 메뉴와 붙은 느낌 */
	    font-size: 14px;
	    color: #555;
		font-weight: 530;
	    /* 이미지처럼 '금일 진료 리스트' 텍스트를 진하게 표현 */
	}
	
	/* 컨텐츠 영역 (전체 배경색 확인용) */
	.content-area {
		height: calc(100vh - 130px);  /* 화면 높이에서 헤더 뺀 값 */
		overflow: hidden;              /* 밖으로 넘치는 건 숨김 */
	    background-color: #D5DDED; /* 나머지 화면을 덮는 배경색 */
	}
	
	/* 금일 진료 리스트 */
	#table{ /* div 영역 및 레이아웃 */
		margin:5px;
		margin-left: auto;
		margin-right: auto;
	}
	
	table { 
	    width: 100%; /* 너비 */
	    border-collapse: collapse; /* 표 한줄로 합치기 */
	    font-size: 13px;
	    background-color: white;
		margin:5px 0px;
	 }

	 th, td {
	     border: 1px solid #7B7B7B; /* 칸 당 테두리*/
	     padding: 0;
		 height: 25px; /* 원하는 셀 높이 */
	     text-align: center; /* 텍스트 중앙 */
	 }

	 th {
	     background-color: #879BD5; 
		 font-weight: normal; /* 글씨 굵기 보통으로 */
		 color: rgb(31, 31, 31);
	 }


	  .container {
	      display: grid;
	      grid-template-columns: 1fr 1fr; /* 왼쪽, 오른쪽 */
	      gap: 5px;
	      height: calc(100vh - 130px); /* 상단+중앙+하단 헤더 제외 */
	      padding: 5px;
	      box-sizing: border-box;
	  }
	
	  .schedule{
	  	  grid-column:1/2 ;
	  }
	  .vacation{
	  	  grid-column:2/3 ;
	  }
	  .fc-event-title {  /*캘린더 줄띄어쓰기*/
	        white-space: pre-line;
	   }
	
	
    </style>
<link rel="stylesheet" th:href="@{/css/common-base.css}">
	<!-- FullCalendar CSS -->
	<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">

	<!-- FullCalendar JS -->
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
	<script>
				document.addEventListener('DOMContentLoaded', () => {

				    document.querySelector('.time-in').addEventListener('click', () => { //출근 처리
				        fetch('/work/time-in', { method: 'POST' })
				            .then(res =>
				                res.text().then(msg => {
				                    if (!res.ok) throw msg;
				                    alert(msg);
				                })
				            )
				            .catch(msg => alert(msg));
				    });

					document.querySelector('.time-out').addEventListener('click', () => { //퇴근 처리

						fetch('/work/time-out/check')
						        .then(res =>
						            res.text().then(msg => {
						                if (!res.ok) throw msg; // 퇴근 불가능

						                if (!confirm('퇴근하시겠습니까?')) return;

						                fetch('/work/time-out', { method: 'POST' }) // 예를 눌러야 실행
						                    .then(res => res.text())
						                    .then(msg => alert(msg))
						                    .catch(() => alert('퇴근 처리 실패'));
						            })
						        )
						        .catch(msg => alert(msg));
					});
				});
	</script>
</head>
<body>
	<div th:replace="~{fragments/staff-header :: header(title='스케줄 조회', activeTab='staffSchedule')}"></div>

	<!-- 콘텐츠 영역 시작-->
	<div class="content-area container">
		<!-- 1. 스케줄 -->
		<div class="schedule">
			<div id="calendar"></div>
		</div>
		
		<!-- 2. 휴가 -->
		<div class="vacation" style="height: 300px;  border: 1px solid #ccc; padding: 5px; border: none;">
			<!-- 상태 필터링 -->
					<div class="search-area" style="width:90%; margin: 5px auto; display:flex; justify-content:center;">
						<!-- 진료과 -->
					    <select id="departmentSelect">
					        <option value="">분류</option>
					    </select>

					    <!-- 의사 -->
					    <select id="doctorSelect">
					        <option value="">승인여부</option>
					    </select>

					    <!-- 날짜 -->
					    <input type="date" id="visitDate">

					    <button onclick="searchVisits()">검색</button>
					</div>    
			
			<table border="1" width="100%">
			        <thead>
			            <tr>
			                <th>분류</th>
			                <th>일시</th>
			                <th>승인여부</th>
			                <th>취소</th>
			            </tr>
			        </thead>
			        <tbody id="vacationBody"></tbody>
			    </table>
		</div>
	</div>
	<!-- 콘텐츠 영역 끝-->
	
	<script>
document.addEventListener('DOMContentLoaded', function () {

    /* =========================
       1. FullCalendar
    ========================= */
    const calendarEl = document.getElementById('calendar');

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        height: 'auto',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: ''
        },
        datesSet: function (info) {
            const currentDate = info.view.currentStart;
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;

            fetch(`/staff/mySchedule/events?year=${year}&month=${month}`)
                .then(res => res.json())
                .then(data => {
                    calendar.removeAllEvents();
                    calendar.addEventSource(data);
                });
        }
    });

    calendar.render();

    /* =========================
       2. 초기 데이터 로딩
    ========================= */
    loadVacationTypes();
    loadVacationStatus();
    loadVacations();

});

/* =========================
   분류 select
========================= */
function loadVacationTypes() {
    fetch('/staff/mySchedule/vacation-types')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('departmentSelect');
            select.innerHTML = '<option value="">분류</option>';

            data.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.typeCode;
                opt.textContent = t.typeName;
                select.appendChild(opt);
            });
        });
}

/* =========================
   승인여부 select
========================= */
function loadVacationStatus() {
    fetch('/staff/mySchedule/vacation-status')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('doctorSelect');
            select.innerHTML = '<option value="">승인여부</option>';

            data.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.statusCode;
                opt.textContent = s.name;
                select.appendChild(opt);
            });
        });
}

/* =========================
   전체 휴가 리스트
========================= */
function loadVacations() {
    fetch('/staff/mySchedule/vacations')
        .then(res => res.json())
        .then(renderVacationTable);
}

/* =========================
   검색
========================= */
function searchVisits() {
    const params = new URLSearchParams({
        typeCode: document.getElementById('departmentSelect').value,
        statusCode: document.getElementById('doctorSelect').value,
        date: document.getElementById('visitDate').value
    });

    fetch(`/staff/mySchedule/vacations/search?${params}`)
        .then(res => res.json())
        .then(renderVacationTable);
}

/* =========================
   테이블 렌더링
========================= */
function renderVacationTable(data) {
    const tbody = document.getElementById('vacationBody');
    tbody.innerHTML = '';

    if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4">검색 결과 없음</td></tr>`;
        return;
    }

    data.forEach(v => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${v.typeName}</td>
            <td>${v.startDate} ~ ${v.endDate}</td>
            <td>${v.statusName}</td>
            <td>
                ${v.statusCode === 'VAC_APPROVED'
                    ? `<button onclick="cancelVacation(${v.vacationId})">취소</button>`
                    : '-'}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/* =========================
   취소
========================= */
function cancelVacation(vacationId) {
    if (!confirm('휴가 취소 요청하시겠습니까?')) return;

    fetch(`/staff/mySchedule/vacation/${vacationId}/cancel`, { method: 'POST' })
        .then(res => {
            if (!res.ok) throw new Error();
            alert('취소 요청되었습니다.');
            loadVacations();
        })
        .catch(() => alert('취소 요청 실패'));
}
</script>




</body>
</html>


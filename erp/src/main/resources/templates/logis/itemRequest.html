<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

    <title>MediCare</title>
	<!-- 구글 폰트 링크 -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>/* 전체 리셋 및 기본 배경 */
	body {
	    margin: 0;
	    padding: 0;
	    font-family: 'Inter', '맑은 고딕', sans-serif;
	    background-color: #D5DDED; /* 이미지의 연한 푸른색 배경 */
	
	}
	
	
	/* 상단 헤더 배경 및 레이아웃 */
	.top-bar {
	    display: flex;
	    justify-content: space-between;
	    align-items: center;
	    padding: 5px 15px;
	    background-color: #ffffff; /* 흰색 배경 */
	    font-size: 14px;
	}
	
	/* 상단 헤더 텍스트 스타일 */
	.user-info {
	    color: #555;
	}
	
	/* 상단 헤더 -> 로그아웃 출근 퇴근 배열 */
	.action-buttons {
	    display: flex;
	    gap: 5px;
	}
	
	/* 상단 헤더 -> 로그아웃 출근 퇴근 공통스타일 */
	.action-buttons button {
	    padding: 4px 12px;
	    border: none;
	    border-radius: 4px;
	    cursor: pointer;
	    font-weight: 500;
	    font-size: 13px;
		border: 1px solid #7B7B7B;
	}
	
	/* 상단 헤더 -> 로그아웃 버튼 스타일 */
	.btn-logout {
		padding: 4px 12px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-weight: 500;
		font-size: 13px;
		color: white;
	    background-color: #FF4B4B;
		border: 1px solid #7B7B7B;
	}
	
	/* 상단 헤더 -> 출근 버튼 스타일 */
	.time-in {
	    background-color: #879BD5;
		color:#ffffff;
	}
	
	/* 상단 헤더 -> 퇴근 버튼 스타일 */
	.time-out {
	    background-color: #D5DDED;
	    color: #000;
	}

	/* 중앙 헤더 -> 카테고리 배치 */
	.tab-list {
	    list-style: none; /* 앞에 점 제거*/
	    margin: 0;
	    padding: 0;
	    display: flex; /* 가로 나열*/
	}
	
	/* 중앙 헤더 -> 카테고리 요소 스타일 */
	.tab-item a {
	    display: block;
	    padding: 8px 15px;
	    text-decoration: none; /* 카테고리 밑줄 제거*/
	    color: #333; /* 글자 색*/
	    background-color: transparent; /* 배경색 투명 (nav-tabs의 배경색 사용) */
	    border: none; /* 경계선 제거 */
	    font-size: 14px;
	    font-weight: normal;
	}
	
	/* 2. 중앙 헤더 공통 ⭐ */
	.nav-tabs {
		background-color: #D5DDED; /* 이미지의 균일한 하늘색 배경 */
		padding: 0 10px;
	}
	
	/* 중앙 헤더 -> 카테고리 호버 */
	.tab-item:hover {
	    background-color: rgba(255, 255, 255, 0.3); /* 마지막 숫자가 컬러 세기 정도*/
	}
	
	/* 중앙 헤더 -> 선택된 카테고리 스타일 */
	.tab-item.active a {
	    color: #333; /* 텍스트 색상은 검은색 유지 (사진처럼) */
	    font-weight: 550;
	    /* 하단에 진한 파란색 선으로 강조 */
	}
	
	
	/* 3. 하단 헤더  */
	.sub-menu {
	    background-color: #BACCFF; /* 흰색 배경 */
	    padding: 5px 15px; /* 패딩을 줄여서 메뉴와 붙은 느낌 */
	    font-size: 14px;
	    color: #555;
		font-weight: 530;
	    /* 이미지처럼 '금일 진료 리스트' 텍스트를 진하게 표현 */
	}
	
	/* 컨텐츠 영역 (전체 배경색 확인용) */
	.content-area {
	    min-height: 500px; /* 임시 높이 */
	    background-color: #D5DDED; /* 나머지 화면을 덮는 배경색 */
	}
	
	/* 금일 진료 리스트 */
	#table{ /* div 영역 및 레이아웃 */
		margin:5px;
		margin-left: auto;
		margin-right: auto;
	}
	
	table { 
	    width: 90%; /* 너비 */
	    border-collapse: collapse; /* 표 한줄로 합치기 */
	    font-size: 14px;
	    background-color: white;
		
	 }

	 th, td {
	     border: 1px solid #7B7B7B; /* 칸 당 테두리*/
	     padding: 0;
		 height: 25px; /* 원하는 셀 높이 */
	     text-align: center; /* 텍스트 중앙 */
	 }

	 th {
	     background-color: #879BD5; 
		 font-weight: normal; /* 글씨 굵기 보통으로 */
		 color: rgb(31, 31, 31);
	 }

	 tr:nth-child(even) {
	     background-color: #ffffffff;
	 }

	 /* 접수 시작 */
	 .first {
		 display: flex;             /* flex로 변환 */
		 justify-content: center;   /* 가로 중앙 */
		 align-items: center;       /* 세로 중앙 */
		 width: 100%;               /* 가로 꽉 */
		 height: 100%;              /* 세로 꽉 */
		 box-sizing: border-box;    /* 패딩 포함 계산 */
		 border: none;
		 background-color: #00FF08;
		 color: black;
		 cursor: pointer;
		 font-size: 14px;
		 font-weight: 300; /* 글씨 굵기 보통으로 */
		 text-decoration: none;
	  }

	  .container {
  	      display: grid;
  	      grid-template-columns: 1fr 1fr; /* 왼쪽, 오른쪽 */
  	      gap: 5px;
  	      height: calc(100vh - 130px); /* 상단+중앙+하단 헤더 제외 */
  	      padding: 5px;
  	      box-sizing: border-box;
  	  }
  	
  	.item{
  		grid-column:1/2 ;
  	}
	
	.request{
		grid-column:2/3 ;
	}
	.item-scroll {
	      width: 90%;
	      margin: 5px auto;
	      max-height: 520px;
	      overflow-y: auto;
	      border: 1px solid #7B7B7B;
	      background-color: #ffffff;
	  }
	
	  .item-scroll table {
	      width: 100%;
	  }
	  /* ===============================
	     상세 팝업 전체 컨테이너
	     =============================== */
	  #requestDetail {
	      display: none;
	      background-color: #ffffff;      /* 깨끗한 흰색 */
	      padding: 25px 30px;
	      border-radius: 12px;
	      box-shadow: 0 12px 28px rgba(0,0,0,0.18);
	      width: 90%;
	      max-width: 750px;
	      margin: 20px auto;
	      font-family: 'Inter', sans-serif;
	      font-size: 14px;
	      color: #333;
	      transition: all 0.3s ease;
	  }

	  /* ===============================
	     기본 정보 p 태그
	     =============================== */
	  #requestDetail p {
	      margin: 8px 0;
	      display: flex;
	      justify-content: space-between;
	  }

	  #requestDetail p span {
	      font-weight: 500;
	      color: #1e1e2f;
	  }

	  /* ===============================
	     테이블 스타일
	     =============================== */
	  #requestDetail table {
	      width: 100%;
	      border-collapse: separate;
	      border-spacing: 0;
	      margin-top: 12px;
	      font-size: 14px;
	      border-radius: 8px;
	      overflow: hidden;
	      box-shadow: inset 0 0 0 1px #d0d5dd;
	  }

	  #requestDetail table th,
	  #requestDetail table td {
	      padding: 8px 12px;
	      text-align: center;
	      vertical-align: middle;
	  }

	  #requestDetail table th {
	      background-color: #f1f3f7;
	      font-weight: 600;
	      color: #1e1e2f;
	  }

	  /* 테이블 홀수 줄 배경색 */
	  #requestDetail table tbody tr:nth-child(odd) {
	      background-color: #fbfbfd;
	  }

	  /* ===============================
	     버튼 영역 공통
	     =============================== */
	  #requestDetail .action-buttduons,
	  #requestDetail .action-buttons {
	      display: flex;
	      justify-content: flex-end;
	      gap: 12px;
	      margin-top: 15px;
	      flex-wrap: wrap;
	  }

	  /* 버튼 기본 스타일 */
	  #requestDetail button {
	      padding: 6px 16px;
	      border: none;
	      border-radius: 6px;
	      cursor: pointer;
	      font-weight: 600;
	      font-size: 14px;
	      transition: all 0.2s ease;
	  }

	  #requestDetail button:hover {
	      opacity: 0.9;
	  }

	  /* ===============================
	     버튼 색상
	     =============================== */
	  #approveBtn {
	      background-color: #879BD5; /* 밝은 파랑 */
	      color: #fff;
	  }

	  #rejectBtn {
	      background-color: #ff6b6b; /* 부드러운 빨강 */
	      color: #fff;
	  }

	  #outboundBtn {
	      background-color: #879BD5; /* 녹색 */
	      color: #fff;
	  }

	  /* ===============================
	     출고 영역
	     =============================== */
	  #outboundArea {
	      display: none;
	      margin-top: 20px;
	      padding: 18px 20px;
	      border-radius: 10px;
	      background-color: #f7f8fa;
	      border: 1px solid #e0e3eb;
	  }

	  #outboundArea h4 {
	      margin-top: 0;
	      margin-bottom: 12px;
	      font-size: 16px;
	      font-weight: 600;
	      color: #1e1e2f;
	  }

	  #stockLackMessage {
	      color: #d32f2f;
	      font-weight: 600;
	      margin-bottom: 10px;
	  }

	  /* ===============================
	     인풋, 텍스트 영역, 셀렉트
	     =============================== */
	  #requestDetail input,
	  #requestDetail textarea,
	  #requestDetail select {
	      width: 100%;
	      padding: 6px 10px;
	      font-size: 14px;
	      border-radius: 6px;
	      border: 1px solid #d0d5dd;
	      box-sizing: border-box;
	      margin-top: 4px;
	      margin-bottom: 8px;
	      background-color: #fff;
	  }

	  #requestDetail textarea {
	      resize: vertical;
	      min-height: 60px;
	  }

    </style>
<link rel="stylesheet" th:href="@{/css/common-base.css}">
	
</head>
<body>
    <div th:replace="~{fragments/logis-header :: header(title='불출 요청 리스트', activeTab='itemRequest')}"></div>


	<!-- 콘텐츠 영역 시작-->
    <div class="content-area">
		<div class="container">
			<div class="item">
			<!-- 상태 필터링 -->
				<div style="width:90%; margin: 5px; display:flex; justify-content:flex-end;">
				    <select id="statusFilter" style="padding: 5px; font-size: 14px;">
				        <option value="">전체 보기</option>
				        <option value="요청">요청</option>
				        <option value="승인">승인</option>
				        <option value="부분출고">부분출고</option>
				    </select>
				</div>

				<div class="item-scroll">
				<!-- 금일 진료 리스트 -->
				<table id="requestTable" border="1">
					<thead>
					    <tr>
					        <th>분류</th>
					        <th>물품명</th>
					        <th>요청수량</th>
					        <th>요청일시</th>
					        <th>상태</th>
					        <th>상세보기</th>
					    </tr>
					</thead>

						<tbody id="">
						<tr th:if="${list.size() == 0}">
						        <td colspan="10" class="no-data" style="height: 500px;">요청이 없습니다.</td>
						    </tr>

							<tr th:each="v : ${list}">
							    <td th:text="${v.itemType}"></td>
							    <td th:text="${v.itemName}"></td>
								<td th:text="${#numbers.formatInteger(v.requestedQty, 0) + ' ' + v.packUnitName}"></td>
							    <td th:text="${#temporals.format(v.requestedAt, 'yyyy-MM-dd HH:mm')}"></td>
							    <td class="status" th:text="${v.statusCode}"></td>
								<td>
									<button type="button"
									        class="detail-btn"
									        th:data-request-id="${v.issueRequestId}"
									        th:data-department-name="${v.departmentName}"
									        th:data-requested-at="${#temporals.format(v.requestedAt,'yyyy-MM-dd HH:mm')}"
									        th:data-status="${v.statusCode}"
									        th:data-item-code="${v.itemCode}"
									        th:data-item-name="${v.itemName}"
									        th:data-qty="${#numbers.formatInteger(v.requestedQty,0)}"
									        th:data-unit="${v.packUnitName}">
									    상세보기
									</button>

								</td>

							</tr>

							<th:block th:if="${list.size() > 0 and list.size() <20}">
							    <tr th:each="i : ${#numbers.sequence(list.size() + 1, 20)}">
							        <td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td>
							    </tr>
							</th:block>
					</tbody>
				</table>
				</div>
		</div>
		<div class="request">

		    <!-- 선택 전 안내 -->
		    <p id="emptyMsg">요청을 선택해주세요</p>

			<div id="requestDetail" style="display:none;">

			    <!--  공통 상세 영역 (그대로 유지) -->
			    <p>요청번호
			        <span id="detailRequestId"></span>
			    </p>

			    <p>요청부서
			        <span id="detailDepartmentName"></span>
			    </p>

			    <p>요청일시
			        <span id="detailRequestedAt"></span>
			    </p>

			    <p>상태
			        <span id="detailStatusCode"></span>
			    </p>

			    <table border="1">
			        <thead>
			            <tr>
			                <th>물품코드</th>
			                <th>물품명</th>
			                <th>요청수량</th>
			            </tr>
			        </thead>
			        <tbody id="detailItemBody"></tbody>
			    </table>

			    <!-- ✅ 요청 상태 전용 버튼 -->
			    <div class="action-buttduons" id="requestActionArea">
			        <input type="hidden" id="issueRequestId">
			        <button id="approveBtn">승인</button>
			        <button id="rejectBtn">반려</button>
			    </div>

			    <!-- ✅ 승인 상태 전용 출고 영역 (추가된 부분) -->
			    <div id="outboundArea" style="display:none; margin-top:20px;">

			        <h4>출고 정보</h4>
					<p id="stockLackMessage"
					   style="display:none; color:#d32f2f; font-weight:bold;">
					    재고가 부족하여 출고할 수 없습니다.
					</p>

			        <p>
			            가용재고:
			            <span id="totalAvailableQty"></span>
			        </p>

			        <p>
			            요청 환산 수량:
			            <span id="convertedRequestQty"></span>
			        </p>

			        <table border="1">
			            <thead>
			                <tr>
			                    <th>LOT 코드</th>
			                    <th>출고마감일</th>
			                    <th>가용수량</th>
			                    <th>출고수량</th>
			                </tr>
			            </thead>
			            <tbody id="lotTableBody"></tbody>
			        </table>
			        <div class="action-buttons">
			            <button id="outboundBtn">출고</button>
			        </div>
			    </div>

			</div>

		</div>
	</div>
	<!-- 콘텐츠 영역 끝-->
	<script>
	document.addEventListener("DOMContentLoaded", () => {
	
	    const detailBox = document.getElementById("requestDetail");
	    const emptyMsg = document.getElementById("emptyMsg");
	
	    const approveBtn = document.getElementById("approveBtn");
	    const rejectBtn = document.getElementById("rejectBtn");
	
	    const requestActionArea = document.getElementById("requestActionArea");
	    const outboundArea = document.getElementById("outboundArea");
	
	    approveBtn.addEventListener("click", () => {
	        updateStatus("IR_APPROVED");
	    });
	
	    rejectBtn.addEventListener("click", () => {
	        updateStatus("IR_REJECTED");
	    });
	
	    document.querySelectorAll(".detail-btn").forEach(btn => {
	        btn.addEventListener("click", () => {
	
	            const status = btn.dataset.status;
	
	            emptyMsg.style.display = "none";
	            detailBox.style.display = "block";
	
	            if (status === "요청") {
	                requestActionArea.style.display = "block";
	                outboundArea.style.display = "none";
	            }
	
	            if (status === "승인") {
	                requestActionArea.style.display = "none";
	                outboundArea.style.display = "block";
					
					loadOutboundExtra(
					        btn.dataset.requestId,
					        btn.dataset.itemCode,
							status
					    );
	            }
	
	            document.getElementById("detailRequestId").textContent = btn.dataset.requestId;
	            document.getElementById("detailDepartmentName").textContent = btn.dataset.departmentName;
	            document.getElementById("detailRequestedAt").textContent = btn.dataset.requestedAt;
	            document.getElementById("detailStatusCode").textContent = status;
	
	            document.getElementById("issueRequestId").value = btn.dataset.requestId;
	
	            const tbody = document.getElementById("detailItemBody");
	            tbody.innerHTML = `
	                <tr>
	                    <td>${btn.dataset.itemCode}</td>
	                    <td>${btn.dataset.itemName}</td>
	                    <td>${btn.dataset.qty} ${btn.dataset.unit}</td>
	                </tr>
	            `;
	        });
	    });
	
	    function updateStatus(statusCode) {
	        const issueRequestId = document.getElementById("issueRequestId").value;
	
	        fetch(`/logis/itemRequest/status?issueRequestId=${issueRequestId}&statusCode=${statusCode}`, {
	            method: "POST"
	        })
	        .then(res => {
	            if (!res.ok) throw new Error("상태 변경 실패");
	            alert("처리되었습니다.");
	            location.reload();
	        })
	        .catch(err => alert(err.message));
	    }
		
		function loadOutboundExtra(issueRequestId, itemCode, status) { //출고

		    fetch(`/logis/itemRequest/outbound/extra?issueRequestId=${issueRequestId}&itemCode=${itemCode}`)
		        .then(res => {
		            if (!res.ok) throw new Error("출고 정보 조회 실패");
		            return res.json();
		        })
		        .then(data => {
		            renderOutboundArea(data, status);
		        })
		        .catch(err => alert(err.message));
		}
		
		function renderOutboundArea(data, status) { // 출고시 필드에 정보 뜨게하기
			const totalAvailableQty = Number(data.totalAvailableQty || 0);
		    const convertedRequestQty = Number(data.convertedRequestQty || 0);
		
			// 가용재고 / 요청환산수량 표시
		    document.getElementById("totalAvailableQty").textContent =
		        `${totalAvailableQty} ${data.baseUnit || ''}`;
		    document.getElementById("convertedRequestQty").textContent =
		        `${convertedRequestQty} ${data.baseUnit || ''}`;

			
		    // LOT 테이블
		    const tbody = document.getElementById("lotTableBody");
		    tbody.innerHTML = "";

			let lotRows = '';
			data.lotList.forEach(lot => {
				const avail = Number(lot.availableQty || 0);
			    if (avail > 0) {
			        lotRows += `
			            <tr>
			                <td>${lot.lotCode}</td>
							<td>${lot.outboundDeadline ?? '-'}</td>

			                <td>${avail}</td>
			                <td>
			                    <input type="number"
			                           min="0"
			                           max="${avail}"
			                           data-lot-code="${lot.lotCode}"
			                           data-stock-id="${lot.stockId}">
			                </td>
			            </tr>
			        `;
			    }
			});

			tbody.innerHTML = lotRows;


		    // 출고버튼
		    const outboundBtn = document.getElementById("outboundBtn");
			
			const compareQty = data.convertedRequestQty; // 최초 요청 환산 수량

		    if (data.totalAvailableQty >= data.convertedRequestQty) {
		        outboundBtn.style.display = "inline-block";
		    } else {
				outboundBtn.disabled = true;
				stockLackMessage.style.display = "block";
				
				document.querySelectorAll("#lotTableBody input").forEach(input => {
		            input.disabled = true;
		        });
		    }
		}
		
		// 전체출고 버튼 클릭
		document.getElementById("outboundBtn")?.addEventListener("click", () => {
		    const issueRequestId = Number(document.getElementById("issueRequestId").value);
			const remainingQty = Number(document.getElementById("convertedRequestQty").textContent.split(" ")[0] || 0);

		    const lotList = [];
			let isValid = true;
			let totalQty = 0; // 전체 행 합계
			
		    document.querySelectorAll("#lotTableBody tr").forEach(row => {
		        const stockId = row.querySelector("input").dataset.stockId;
		        const lotCode = row.querySelector("input").dataset.lotCode;
		        const qty = parseFloat(row.querySelector("input").value || "0");
				const availableQty = parseInt(row.children[2].textContent || "0");
				if (qty > availableQty) {
				    alert("가용재고가 부족합니다.");
					isValid = false;
				    return;
				 }
				
				 totalQty+=qty;
				 lotList.push({ stockId: Number(stockId), lotCode, qty });
		    });

			if (!isValid) return;

			if (totalQty !== remainingQty) { // 전체 합계 체크
		        alert(`출고 수량 합계가 요청 환산 수량과 일치해야 합니다.\n요청 환산 수량: ${remainingQty}, 현재 합계: ${totalQty}`);
		        return;
		    }
			console.log("전송할 lotList:", lotList);

		    fetch("/logis/itemRequest/outbound/partial", { // 기존 컨트롤러 재활용
		        method: "POST",
		        headers: { "Content-Type": "application/json" },
		        body: JSON.stringify({
		            issueRequestId: Number(issueRequestId),
		            lotList: lotList,
		            isPartial: false // 전체출고임을 표시
		        })
		    })
		    .then(res => res.text())
		    .then(msg => {
		        alert(msg);
		        location.reload();
		    })
		    .catch(err => alert(err.message));
		});


	});
	document.addEventListener("DOMContentLoaded", () => {

	    const statusFilter = document.getElementById("statusFilter");
	    const tableRows = document.querySelectorAll("#requestTable tbody tr");

	    statusFilter.addEventListener("change", function() {
	        const selected = this.value;

	        tableRows.forEach(row => {
	            const statusCell = row.querySelector(".status");
	            if (!statusCell) return; // 상태 셀이 없으면 건너뛰기

	            const status = statusCell.textContent.trim();
	            row.style.display = (selected === "" || status === selected) ? "" : "none";
	        });
	    });

	});

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

    <title>MediCare</title>
	<!-- êµ¬ê¸€ í°íŠ¸ ë§í¬ -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>/* ì „ì²´ ë¦¬ì…‹ ë° ê¸°ë³¸ ë°°ê²½ */
	body {
	    margin: 0;
	    padding: 0;
	    font-family: 'Inter', 'ë§‘ì€ ê³ ë”•', sans-serif;
	    background-color: #D5DDED; /* ì´ë¯¸ì§€ì˜ ì—°í•œ í‘¸ë¥¸ìƒ‰ ë°°ê²½ */
	
	}
	
	
	/* ìƒë‹¨ í—¤ë” ë°°ê²½ ë° ë ˆì´ì•„ì›ƒ */
	.top-bar {
	    display: flex;
	    justify-content: space-between;
	    align-items: center;
	    padding: 5px 15px;
	    background-color: #ffffff; /* í°ìƒ‰ ë°°ê²½ */
	    font-size: 14px;
	}
	
	/* ìƒë‹¨ í—¤ë” í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
	.user-info {
	    color: #555;
	}
	
	/* ìƒë‹¨ í—¤ë” -> ë¡œê·¸ì•„ì›ƒ ì¶œê·¼ í‡´ê·¼ ë°°ì—´ */
	.action-buttons {
	    display: flex;
	    gap: 5px;
	}
	
	/* ìƒë‹¨ í—¤ë” -> ë¡œê·¸ì•„ì›ƒ ì¶œê·¼ í‡´ê·¼ ê³µí†µìŠ¤íƒ€ì¼ */
	.action-buttons button {
	    padding: 4px 12px;
	    border: none;
	    border-radius: 4px;
	    cursor: pointer;
	    font-weight: 500;
	    font-size: 13px;
		border: 1px solid #7B7B7B;
	}
	
	/* ìƒë‹¨ í—¤ë” -> ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.btn-logout {
		padding: 4px 12px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-weight: 500;
		font-size: 13px;
		color: white;
	    background-color: #FF4B4B;
		border: 1px solid #7B7B7B;
	}
	
	/* ìƒë‹¨ í—¤ë” -> ì¶œê·¼ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.time-in {
	    background-color: var(--ui-panel-title);
		color:#ffffff;
	}
	
	/* ìƒë‹¨ í—¤ë” -> í‡´ê·¼ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.time-out {
	    background-color: #D5DDED;
	    color: #000;
	}

	/* ì¤‘ì•™ í—¤ë” -> ì¹´í…Œê³ ë¦¬ ë°°ì¹˜ */
	.tab-list {
	    list-style: none; /* ì•ì— ì  ì œê±°*/
	    margin: 0;
	    padding: 0;
	    display: flex; /* ê°€ë¡œ ë‚˜ì—´*/
	}
	
	/* ì¤‘ì•™ í—¤ë” -> ì¹´í…Œê³ ë¦¬ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
	.tab-item a {
	    display: block;
	    padding: 8px 15px;
	    text-decoration: none; /* ì¹´í…Œê³ ë¦¬ ë°‘ì¤„ ì œê±°*/
	    color: #333; /* ê¸€ì ìƒ‰*/
	    background-color: transparent; /* ë°°ê²½ìƒ‰ íˆ¬ëª… (nav-tabsì˜ ë°°ê²½ìƒ‰ ì‚¬ìš©) */
	    border: none; /* ê²½ê³„ì„  ì œê±° */
	    font-size: 14px;
	    font-weight: normal;
	}
	
	/* 2. ì¤‘ì•™ í—¤ë” ê³µí†µ â­ */
	.nav-tabs {
		background-color: #D5DDED; /* ì´ë¯¸ì§€ì˜ ê· ì¼í•œ í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
		padding: 0 10px;
	}
	
	/* ì¤‘ì•™ í—¤ë” -> ì¹´í…Œê³ ë¦¬ í˜¸ë²„ */
	.tab-item:hover {
	    background-color: rgba(255, 255, 255, 0.3); /* ë§ˆì§€ë§‰ ìˆ«ìê°€ ì»¬ëŸ¬ ì„¸ê¸° ì •ë„*/
	}
	
	/* ì¤‘ì•™ í—¤ë” -> ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ìŠ¤íƒ€ì¼ */
	.tab-item.active a {
	    color: #333; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒì€ ê²€ì€ìƒ‰ ìœ ì§€ (ì‚¬ì§„ì²˜ëŸ¼) */
	    font-weight: 550;
	    /* í•˜ë‹¨ì— ì§„í•œ íŒŒë€ìƒ‰ ì„ ìœ¼ë¡œ ê°•ì¡° */
	}
	
	
	/* 3. í•˜ë‹¨ í—¤ë”  */
	.sub-menu {
	    background-color: #BACCFF; /* í°ìƒ‰ ë°°ê²½ */
	    padding: 5px 15px; /* íŒ¨ë”©ì„ ì¤„ì—¬ì„œ ë©”ë‰´ì™€ ë¶™ì€ ëŠë‚Œ */
	    font-size: 14px;
	    color: #555;
		font-weight: 530;
	    /* ì´ë¯¸ì§€ì²˜ëŸ¼ 'ê¸ˆì¼ ì§„ë£Œ ë¦¬ìŠ¤íŠ¸' í…ìŠ¤íŠ¸ë¥¼ ì§„í•˜ê²Œ í‘œí˜„ */
	}
	
	/* ì»¨í…ì¸  ì˜ì—­ (ì „ì²´ ë°°ê²½ìƒ‰ í™•ì¸ìš©) */
	.content-area {
	    min-height: 500px; /* ì„ì‹œ ë†’ì´ */
	    background-color: #D5DDED; /* ë‚˜ë¨¸ì§€ í™”ë©´ì„ ë®ëŠ” ë°°ê²½ìƒ‰ */
	}
	
	/* ê¸ˆì¼ ì§„ë£Œ ë¦¬ìŠ¤íŠ¸ */
	#table{ /* div ì˜ì—­ ë° ë ˆì´ì•„ì›ƒ */
		margin:5px;
		margin-left: auto;
		margin-right: auto;
	}
	
	table { 
	    width: 90%; /* ë„ˆë¹„ */
	    border-collapse: collapse; /* í‘œ í•œì¤„ë¡œ í•©ì¹˜ê¸° */
	    font-size: 14px;
	    background-color: white;
		
	 }

	 th, td {
	     border: 1px solid #7B7B7B; /* ì¹¸ ë‹¹ í…Œë‘ë¦¬*/
	     padding: 0;
		 height: 25px; /* ì›í•˜ëŠ” ì…€ ë†’ì´ */
	     text-align: center; /* í…ìŠ¤íŠ¸ ì¤‘ì•™ */
	 }

	 th {
	     background-color: var(--ui-panel-title); 
		 font-weight: normal; /* ê¸€ì”¨ êµµê¸° ë³´í†µìœ¼ë¡œ */
		 color: rgb(31, 31, 31);
	 }

	 tr:nth-child(even) {
	     background-color: #ffffffff;
	 }

	 /* ì ‘ìˆ˜ ì‹œì‘ */
	 .first {
		 display: flex;             /* flexë¡œ ë³€í™˜ */
		 justify-content: center;   /* ê°€ë¡œ ì¤‘ì•™ */
		 align-items: center;       /* ì„¸ë¡œ ì¤‘ì•™ */
		 width: 100%;               /* ê°€ë¡œ ê½‰ */
		 height: 100%;              /* ì„¸ë¡œ ê½‰ */
		 box-sizing: border-box;    /* íŒ¨ë”© í¬í•¨ ê³„ì‚° */
		 border: none;
		 background-color: #00FF08;
		 color: black;
		 cursor: pointer;
		 font-size: 14px;
		 font-weight: 300; /* ê¸€ì”¨ êµµê¸° ë³´í†µìœ¼ë¡œ */
		 text-decoration: none;
	  }

	  .container {
	  	      display: grid;
	  	      grid-template-columns: 1fr 2fr; /* ì™¼ìª½, ì˜¤ë¥¸ìª½ */
	  	      gap: 5px;
	  	      height: calc(100vh - 130px); /* ìƒë‹¨+ì¤‘ì•™+í•˜ë‹¨ í—¤ë” ì œì™¸ */
	  	      padding: 5px;
	  	      box-sizing: border-box;
	  }
	  
	  .calendar{
		 grid-column: 1/2;
	  }
	  
	  .user{
		 grid-column: 2/3;
	  }
	
	  .item-scroll {
	      width: 90%;
	      margin: 5px auto;
	      max-height: 520px;
	      overflow-y: auto;
	      border: 1px solid #7B7B7B;
	      background-color: #ffffff;
	  }

	  .item-scroll table {
	      width: 100%;
	  }

    </style>
<link rel="stylesheet" th:href="@{/css/common-base.css}">
	
	<!-- FullCalendar CSS/JS -->
	<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
	
</head>
<body>
    <div th:replace="~{fragments/hr-header :: header(title='ì§ì› ìŠ¤ì¼€ì¤„ ì¡°íšŒ', activeTab='allSchedule')}"></div>


	<!-- ì½˜í…ì¸  ì˜ì—­ ì‹œì‘-->
    <div class="content-area">
		<div class="container">
			<div class="calendar"> <!-- ìº˜ë¦°ë” ì˜ì—­-->
				<div id="calendar"></div>
			</div>
			
			<div class="user">
				<div id="userSearchArea" style="display:none; width:90%; margin:10px auto; gap:10px; justify-content:center;">
					

					    <!-- ì§„ë£Œê³¼ -->
					    <select id="departmentSelect">
					        <option value="">ì§„ë£Œê³¼ ì „ì²´</option>
					    </select>

					    <!-- ê·¼ë¬´í˜•íƒœ -->
					    <select id="workTypeSelect">
					        <option value="">ê·¼ë¬´í˜•íƒœ ì „ì²´</option>
					    </select>

					    <!-- ì§ì› ê²€ìƒ‰ -->
					    <input type="text" id="nameFilter" placeholder="ì§ì›ëª… / ì§ì›ID">
 
					    <button onclick="searchUserSchedule()">ê²€ìƒ‰</button>
					
				</div>

				<div class="item-scroll">
				<table border="1" width="100%">
				    <thead id="userScheduleHead" style="display:none;">
				        <tr>
				            <th>ì§„ë£Œê³¼</th>
				            <th>ì§ì›ID</th>
				            <th>ì§ì›ëª…</th>
				            <th>ìŠ¤ì¼€ì¤„</th>
				            <th>íœ´ê°€</th>
				        </tr>
				    </thead>
				    <tbody id="userScheduleBody">
				        <tr>
				            <td colspan="5" style="height:500px;">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</td>
				        </tr>
				    </tbody>
				</table>
				</div>
			</div>
		</div>
	</div>
	<!-- ì½˜í…ì¸  ì˜ì—­ ë-->
	
	<script>
	let originScheduleData = []; // ë‚ ì§œ ê¸°ì¤€ ì „ì²´ ë°ì´í„°
	let allWorkTypes = [];   // ì „ì²´ ê·¼ë¬´í˜•íƒœ


	document.addEventListener('DOMContentLoaded', function() {
	    const calendarEl = document.getElementById('calendar');
	    const userEl = document.getElementById('userSchedule');

	    const calendar = new FullCalendar.Calendar(calendarEl, {
	        initialView: 'dayGridMonth',
	        locale: 'ko',
	        height: 'auto',
	        headerToolbar: {
	            left: 'prev,next today',
	            center: 'title',
	            right: ''
	        },
			dateClick: function(info) {
			    const selectedDate = info.dateStr; // ì„ íƒí•œ ë‚ ì§œ
			    console.log("ì„ íƒí•œ ë‚ ì§œ:", selectedDate);

				// ë‚ ì§œ ì„ íƒ í‘œì‹œ (ì´ë¯¸ ì˜ë¨)
				calendar.getEvents().forEach(event => {
				     if (event.id === 'selected-date') event.remove();
				});

				calendar.addEvent({ // ë‚ ì§œ ì„ íƒì‹œ css
				     id: 'selected-date',
				     start: selectedDate,
				     allDay: true,
				     display: 'background',
				     backgroundColor: '#D5DDED'
				});

				document.getElementById('userSearchArea').style.display = 'flex';
				
				// ì§ì› ìŠ¤ì¼€ì¤„ ì¡°íšŒ
				fetch(`/hr/allSchedule/byDate?date=${selectedDate}`)
				     .then(res => res.json())
				     .then(data => {
					 originScheduleData = data;   // ğŸ”¥ ì›ë³¸ ì €ì¥
				     renderUserSchedule(data);
				});
			}

	    });

	    calendar.render();
		loadDepartments();
		loadWorkTypes();

	});
	
	document.getElementById('departmentSelect').addEventListener('change', function () {
	    const selectedDeptName =
	        this.options[this.selectedIndex].text;

	    const role = getRoleByDepartment(selectedDeptName);

	    if (!role) {
	        renderWorkTypeOptions(allWorkTypes); // ì „ì²´
	        return;
	    }

	    const filtered = allWorkTypes.filter(w => w.roleCode === role);
	    renderWorkTypeOptions(filtered);
	});

	
	function renderUserSchedule(data) {
	    const tbody = document.getElementById('userScheduleBody');
	    const thead = document.getElementById('userScheduleHead');

	    // thead ë³´ì´ê²Œ
	    thead.style.display = '';

	    tbody.innerHTML = '';

	    // ë°ì´í„° ì—†ì„ ë•Œ
	    if (data.length === 0) {
	        tbody.innerHTML = `
	            <tr>
	                <td colspan="5" style="height:450px;">í•´ë‹¹ ë‚ ì§œì— ìŠ¤ì¼€ì¤„ì´ ë¶€ì—¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</td>
	            </tr>
	        `;
	        return;
	    }

	    data.forEach(item => {
	        const tr = document.createElement('tr');
	        tr.innerHTML = `
	            <td>${item.departmentName}</td>
	            <td>${item.userId}</td>
	            <td>${item.userName}</td>
	            <td>${item.workName ?? '-'}</td>
	            <td>${item.statusName ?? 'ì—†ìŒ'}</td>
	        `;
	        tbody.appendChild(tr);
	    });
	}
	
	function loadDepartments() { //ì§„ë£Œê³¼ ë“œë¡­ë‹¤ìš´
	    fetch('/hr/allSchedule/departments')
	        .then(res => res.json())
	        .then(data => {
	            const select = document.getElementById('departmentSelect');
	            select.innerHTML = '<option value="">ì§„ë£Œê³¼ ì „ì²´</option>';

	            data.forEach(d => {
	                const opt = document.createElement('option');
	                opt.value = d.departmentCode;
	                opt.textContent = d.name;
	                select.appendChild(opt);
	            });
	        });
	}

	function loadWorkTypes() { // ê·¼ë¬´í˜•íƒœ ë“œë¡­ë‹¤ìš´ 
	    fetch('/hr/allSchedule/work-types')
	        .then(res => res.json())
	        .then(data => {
	            allWorkTypes = data;     // ì „ì²´ ì €ì¥
	            renderWorkTypeOptions(data); // ìµœì´ˆ ì „ì²´ í‘œì‹œ
	        });
	}
	
	function renderWorkTypeOptions(list) { // ê·¼ë¬´í˜•íƒœ ë“œë¡­ë‹¤ìš´
	    const select = document.getElementById('workTypeSelect');
	    select.innerHTML = '<option value="">ê·¼ë¬´í˜•íƒœ ì „ì²´</option>';

	    list.forEach(w => {
	        const opt = document.createElement('option');
	        opt.value = w.workTypeCode;
	        opt.textContent = w.workName;
	        opt.dataset.role = w.roleCode; // ğŸ”¥ ì¤‘ìš”
	        select.appendChild(opt);
	    });
	}

	function getRoleByDepartment(deptName) { //ê³¼ì— ë”°ë¼ ê·¼ë¬´ í˜•íƒœ ë‹¤ë¥´ê²Œ
	    if (['ë‚´ë¶„ë¹„ë‚´ê³¼', 'ì¼ë°˜ì™¸ê³¼', 'ì •í˜•ì™¸ê³¼', 'í˜¸í¡ê¸°ë‚´ê³¼'].includes(deptName))
	        return 'DOCTOR';
	    if (deptName === 'ì•½ì œê³¼')
	        return 'PHARM';
	    if (deptName === 'ì›ë¬´ê³¼')
	        return 'STAFF';
	    return null;
	}


	
	function searchUserSchedule() { //ê²€ìƒ‰
	    const deptCode = document.getElementById('departmentSelect').value;
	    const workTypeCode = document.getElementById('workTypeSelect').value;
	    const keyword = document.getElementById('nameFilter').value.trim();

		let filtered = originScheduleData;
	    // 1ï¸.ì§„ë£Œê³¼ í•„í„°
	    if (deptCode) {
	        filtered = filtered.filter(item =>
	            item.departmentCode === deptCode ||
	            item.departmentName ===
	            document.querySelector(`#departmentSelect option[value="${deptCode}"]`)?.textContent
	        );
	    }

	    // 2ï¸.ê·¼ë¬´í˜•íƒœ í•„í„°
	    if (workTypeCode) {
	        filtered = filtered.filter(item =>
	            item.workTypeCode === workTypeCode ||
	            item.workName ===
	            document.querySelector(`#workTypeSelect option[value="${workTypeCode}"]`)?.textContent
	        );
	    }

	    // 3ï¸.ì§ì›ID / ì§ì›ëª… LIKE ê²€ìƒ‰
	    if (keyword) {
	        filtered = filtered.filter(item =>
	            (item.userId && item.userId.includes(keyword)) ||
	            (item.userName && item.userName.includes(keyword))
	        );
	    }

	    renderUserSchedule(filtered);
	}

	</script>


</body>
</html>
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

    <title>MediCare</title>
	<!-- êµ¬ê¸€ í°íŠ¸ ë§í¬ -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>/* ì „ì²´ ë¦¬ì…‹ ë° ê¸°ë³¸ ë°°ê²½ */
	body {
	    margin: 0;
	    padding: 0;
	    font-family: 'Inter', 'ë§‘ì€ ê³ ë”•', sans-serif;
	    background-color: #D5DDED; /* ì´ë¯¸ì§€ì˜ ì—°í•œ í‘¸ë¥¸ìƒ‰ ë°°ê²½ */
	
	}
	
	
	/* ìƒë‹¨ í—¤ë” ë°°ê²½ ë° ë ˆì´ì•„ì›ƒ */
	.top-bar {
	    display: flex;
	    justify-content: space-between;
	    align-items: center;
	    padding: 5px 15px;
	    background-color: #ffffff; /* í°ìƒ‰ ë°°ê²½ */
	    font-size: 14px;
	}
	
	/* ìƒë‹¨ í—¤ë” í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
	.user-info {
	    color: #555;
	}
	
	/* ìƒë‹¨ í—¤ë” -> ë¡œê·¸ì•„ì›ƒ ì¶œê·¼ í‡´ê·¼ ë°°ì—´ */
	.action-buttons {
	    display: flex;
	    gap: 5px;
	}
	
	/* ìƒë‹¨ í—¤ë” -> ë¡œê·¸ì•„ì›ƒ ì¶œê·¼ í‡´ê·¼ ê³µí†µìŠ¤íƒ€ì¼ */
	.action-buttons button {
	    padding: 4px 12px;
	    border: none;
	    border-radius: 4px;
	    cursor: pointer;
	    font-weight: 500;
	    font-size: 13px;
		border: 1px solid #7B7B7B;
	}
	
	/* ìƒë‹¨ í—¤ë” -> ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.btn-logout {
		padding: 4px 12px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-weight: 500;
		font-size: 13px;
		color: white;
	    background-color: #FF4B4B;
		border: 1px solid #7B7B7B;
	}
	
	/* ìƒë‹¨ í—¤ë” -> ì¶œê·¼ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.time-in {
	    background-color: #879BD5;
		color:#ffffff;
	}
	
	/* ìƒë‹¨ í—¤ë” -> í‡´ê·¼ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.time-out {
	    background-color: #D5DDED;
	    color: #000;
	}

	/* ì¤‘ì•™ í—¤ë” -> ì¹´í…Œê³ ë¦¬ ë°°ì¹˜ */
	.tab-list {
	    list-style: none; /* ì•ì— ì  ì œê±°*/
	    margin: 0;
	    padding: 0;
	    display: flex; /* ê°€ë¡œ ë‚˜ì—´*/
	}
	
	/* ì¤‘ì•™ í—¤ë” -> ì¹´í…Œê³ ë¦¬ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
	.tab-item a {
	    display: block;
	    padding: 8px 15px;
	    text-decoration: none; /* ì¹´í…Œê³ ë¦¬ ë°‘ì¤„ ì œê±°*/
	    color: #333; /* ê¸€ì ìƒ‰*/
	    background-color: transparent; /* ë°°ê²½ìƒ‰ íˆ¬ëª… (nav-tabsì˜ ë°°ê²½ìƒ‰ ì‚¬ìš©) */
	    border: none; /* ê²½ê³„ì„  ì œê±° */
	    font-size: 14px;
	    font-weight: normal;
	}
	
	/* 2. ì¤‘ì•™ í—¤ë” ê³µí†µ â­ */
	.nav-tabs {
		background-color: #D5DDED; /* ì´ë¯¸ì§€ì˜ ê· ì¼í•œ í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
		padding: 0 10px;
	}
	
	/* ì¤‘ì•™ í—¤ë” -> ì¹´í…Œê³ ë¦¬ í˜¸ë²„ */
	.tab-item:hover {
	    background-color: rgba(255, 255, 255, 0.3); /* ë§ˆì§€ë§‰ ìˆ«ìê°€ ì»¬ëŸ¬ ì„¸ê¸° ì •ë„*/
	}
	
	/* ì¤‘ì•™ í—¤ë” -> ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ìŠ¤íƒ€ì¼ */
	.tab-item.active a {
	    color: #333; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒì€ ê²€ì€ìƒ‰ ìœ ì§€ (ì‚¬ì§„ì²˜ëŸ¼) */
	    font-weight: 550;
	    /* í•˜ë‹¨ì— ì§„í•œ íŒŒë€ìƒ‰ ì„ ìœ¼ë¡œ ê°•ì¡° */
	}
	
	
	/* 3. í•˜ë‹¨ í—¤ë”  */
	.sub-menu {
	    background-color: #BACCFF; /* í°ìƒ‰ ë°°ê²½ */
	    padding: 5px 15px; /* íŒ¨ë”©ì„ ì¤„ì—¬ì„œ ë©”ë‰´ì™€ ë¶™ì€ ëŠë‚Œ */
	    font-size: 14px;
	    color: #555;
		font-weight: 530;
	    /* ì´ë¯¸ì§€ì²˜ëŸ¼ 'ê¸ˆì¼ ì§„ë£Œ ë¦¬ìŠ¤íŠ¸' í…ìŠ¤íŠ¸ë¥¼ ì§„í•˜ê²Œ í‘œí˜„ */
	}
	
	/* ì»¨í…ì¸  ì˜ì—­ (ì „ì²´ ë°°ê²½ìƒ‰ í™•ì¸ìš©) */
	.content-area {
	    min-height: 500px; /* ì„ì‹œ ë†’ì´ */
	    background-color: #D5DDED; /* ë‚˜ë¨¸ì§€ í™”ë©´ì„ ë®ëŠ” ë°°ê²½ìƒ‰ */
	}
	
	/* ê¸ˆì¼ ì§„ë£Œ ë¦¬ìŠ¤íŠ¸ */
	#table{ /* div ì˜ì—­ ë° ë ˆì´ì•„ì›ƒ */
		margin:5px;
		margin-left: auto;
		margin-right: auto;
	}
	
	table { 
	    width: 90%; /* ë„ˆë¹„ */
	    border-collapse: collapse; /* í‘œ í•œì¤„ë¡œ í•©ì¹˜ê¸° */
	    font-size: 14px;
	    background-color: white;
		
	 }

	 th, td {
	     border: 1px solid #7B7B7B; /* ì¹¸ ë‹¹ í…Œë‘ë¦¬*/
	     padding: 0;
		 height: 25px; /* ì›í•˜ëŠ” ì…€ ë†’ì´ */
	     text-align: center; /* í…ìŠ¤íŠ¸ ì¤‘ì•™ */
	 }

	 th {
	     background-color: #879BD5; 
		 font-weight: normal; /* ê¸€ì”¨ êµµê¸° ë³´í†µìœ¼ë¡œ */
		 color: rgb(31, 31, 31);
	 }

	 tr:nth-child(even) {
	     background-color: #ffffffff;
	 }

	 /* ì ‘ìˆ˜ ì‹œì‘ */
	 .first {
		 display: flex;             /* flexë¡œ ë³€í™˜ */
		 justify-content: center;   /* ê°€ë¡œ ì¤‘ì•™ */
		 align-items: center;       /* ì„¸ë¡œ ì¤‘ì•™ */
		 width: 100%;               /* ê°€ë¡œ ê½‰ */
		 height: 100%;              /* ì„¸ë¡œ ê½‰ */
		 box-sizing: border-box;    /* íŒ¨ë”© í¬í•¨ ê³„ì‚° */
		 border: none;
		 background-color: #00FF08;
		 color: black;
		 cursor: pointer;
		 font-size: 14px;
		 font-weight: 300; /* ê¸€ì”¨ êµµê¸° ë³´í†µìœ¼ë¡œ */
		 text-decoration: none;
	  }

	
	
    </style>
<link rel="stylesheet" th:href="@{/css/common-base.css}">
	
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
	
</head>
<body>
   	<div th:replace="~{fragments/hr-header :: header(title='íœ´ê°€ ì‹ ì²­ ë¦¬ìŠ¤íŠ¸', activeTab='vacationList')}"></div>


	<!-- ì½˜í…ì¸  ì˜ì—­ ì‹œì‘-->
    <div class="content-area">
		<!-- ê²€ìƒ‰ ì˜ì—­ -->
		<div id="vacationSearchArea" style="width:90%; margin:10px auto; display:flex; gap:10px; justify-content:flex-end;">

		    <!-- ì§„ë£Œê³¼ -->
		    <select id="departmentSelect">
		        <option value="">ì§„ë£Œê³¼ ì „ì²´</option>
		    </select>

		    <!-- ë¶„ë¥˜ -->
		    <select id="typeSelect">
		        <option value="">ë¶„ë¥˜ ì „ì²´</option>
		    </select>

		    <!-- ìƒíƒœ -->
		    <select id="statusSelect">
		        <option value="">ìƒíƒœ ì „ì²´</option>
		    </select>

		    <!-- ì§ì› ê²€ìƒ‰ -->
		    <input type="text" id="keyword" placeholder="ì§ì›ëª… / ì§ì›ID">

		    <!-- ë‚ ì§œ -->
		    <input type="date" id="Date">

		    <button>ê²€ìƒ‰</button>
		</div>


		<!-- ê¸ˆì¼ ì§„ë£Œ ë¦¬ìŠ¤íŠ¸ -->
		<table id="table" border="1">
			<thead>
			    <tr>
			        <th>íœ´ê°€ì½”ë“œ</th>
			        <th>ë¶„ë¥˜</th>
			        <th>ìƒíƒœ</th>
			        <th>ì§ì›ID</th>
			        <th>ì§ì›ëª…</th>
			        <th>ì§„ë£Œê³¼</th>
					<th>ì‚¬ìš© ê¸°ê°„</th>
					<th>ì‚¬ìœ </th>
			        <th>ì„ íƒ</th>
			    </tr>
			</thead>

			<tbody>
				<tr th:if="${vacation.size() == 0}">
				        <td colspan="10" class="no-data" style="height: 500px;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
				    </tr>

				    <tr th:each="v : ${vacation}">
						<td th:text="${v.vacation_id}"></td>
						<td th:text="${v.vacation_type.type_name}"></td>
						<td th:text="${v.status_code.name}"></td>
						<td th:text="${v.user_account.user_id}"></td>
						<td th:text="${v.user_account.name}"></td>
						<td th:text="${#lists.isEmpty(v.user_account.staff_profile) ? '-' : v.user_account.staff_profile.get(0).department.name}"></td>
						<td th:text="${#temporals.format(v.start_date, 'yyyy-MM-dd')} + ' ~ ' + ${#temporals.format(v.end_date, 'yyyy-MM-dd')}"></td>
				
						<td th:text="${v.reason}"></td>
						<td>
						        <button type="button" th:data-id="${v.vacation_id}" 
						                th:data-status="${v.status_code.status_code}" 
						                class="btnView">ì„ íƒ</button>
						    </td>
				    </tr>
					
					<!-- ë¹ˆ í–‰ì„ ì±„ì›Œ ìµœì†Œ 10í–‰ìœ¼ë¡œ ìœ ì§€ -->
					    <tr th:if="${vacation.size() >0 }" 
					        th:each="i : ${#numbers.sequence(vacation.size() + 1, 20)}">
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					</tr>
			</tbody>
		</table>
		
		<!-- íŒì—… -->
		<div id="vacationPopup" class="popup" style="display:none;"> <!-- ì•ˆë³´ì´ê²Œ -->
		    <div class="popup-header"> <!-- ìƒë‹¨ -->
		        <button id="popupBackBtn">ì´ì „</button>
		        <span id="popupTitle">ìƒì„¸ ë³´ê¸°</span>
		    </div>
		    <div class="popup-content"> <!-- ì¤‘ì•™ -->
		        <label>ì§„ë£Œê³¼:</label>
		        <input type="text" id="popupDepartment" readonly />

		        <label>ì§ì›ID:</label>
		        <input type="text" id="popupUserId" readonly />

		        <label>ì§ì›ëª…:</label>
		        <input type="text" id="popupUserName" readonly />

		        <label>ê¸°ê°„:</label>
		        <input type="date" id="popupStartDate" readonly />
		        <input type="date" id="popupEndDate" readonly />

		        <label>ë¶„ë¥˜:</label>
		        <input type="text" id="popupType" readonly />

		        <label>ì‚¬ìœ :</label>
		        <textarea id="popupReason" readonly ></textarea>
		</div>
		<div class="popup-footer" id="popupFooter"></div> <!-- í•˜ë‹¨ -->
		
		
    </div>
	<!-- ì½˜í…ì¸  ì˜ì—­ ë-->
	
	<script>
	const vacationPopup = document.getElementById('vacationPopup'); //íŒì—…ì°½ DOMìš”ì†Œ ì ‘ê·¼
	const popupFooter = document.getElementById('popupFooter'); //í•˜ë‹¨ DOMìš”ì†Œ ì ‘ê·¼
	const popupTitle = document.getElementById('popupTitle'); //ìƒë‹¨ DOMìš”ì†Œ ì ‘ê·¼

	document.querySelector('#vacationSearchArea button').addEventListener('click', filterVacationTable); //ë“œë¡­ë‹¤ìš´

			document.addEventListener('DOMContentLoaded', () => { //ë“œë¡­ë‹¤ìš´
			    loadDepartments();
			    loadVacationTypes();
			    loadVacationStatuses();
			});

			/* =====================
			   ì§„ë£Œê³¼ ë“œë¡­ë‹¤ìš´
			===================== */
			function loadDepartments() {
			    fetch('/hr/allSchedule/departments')
			        .then(res => res.json())
			        .then(data => {
			            const select = document.getElementById('departmentSelect');
			            select.innerHTML = '<option value="">ì§„ë£Œê³¼ ì „ì²´</option>';

			            data.forEach(d => {
			                const opt = document.createElement('option');
							opt.value = d.name;      // ì½”ë“œ â†’ ì´ë¦„
							                opt.textContent = d.name;
			                select.appendChild(opt);
			            });
			        });
			}

			/* =====================
			   íœ´ê°€ ë¶„ë¥˜ ë“œë¡­ë‹¤ìš´
			===================== */
			function loadVacationTypes() {
			    fetch('/hr/vacationList/types')
			        .then(res => res.json())
			        .then(data => {
			            const select = document.getElementById('typeSelect');
			            select.innerHTML = '<option value="">ë¶„ë¥˜ ì „ì²´</option>';

			            data.forEach(t => {
			                const opt = document.createElement('option');
							opt.value = t.typeName;   // ì½”ë“œ â†’ ì´ë¦„
							opt.textContent = t.typeName;
			                select.appendChild(opt);
			            });
			        });
			}

			/* =====================
			   íœ´ê°€ ìƒíƒœ ë“œë¡­ë‹¤ìš´
			===================== */
			function loadVacationStatuses() {
			    fetch('/hr/vacation/status')
			        .then(res => res.json())
			        .then(data => {
			            const select = document.getElementById('statusSelect');
			            select.innerHTML = '<option value="">ìƒíƒœ ì „ì²´</option>';

			            data.forEach(s => {
			                const opt = document.createElement('option');
							opt.value = s.name;      // ì½”ë“œ â†’ ì´ë¦„
							opt.textContent = s.name;
			                select.appendChild(opt);
			            });
			        });
			}
			
			function filterVacationTable() { //ê²€ìƒ‰
			    const deptValue   = document.getElementById('departmentSelect').value;
			    const typeValue   = document.getElementById('typeSelect').value;
			    const statusValue = document.getElementById('statusSelect').value;
			    const keyword     = document.getElementById('keyword').value.trim().toLowerCase();
			    const selectedDate = document.getElementById('Date').value;

			    const rows = document.querySelectorAll('#table tbody tr');

			    rows.forEach(row => {
			        // "ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤" / ë¹ˆ í–‰ ì œì™¸
			        if (row.children.length < 9) return;

			        const department = row.children[5].innerText.trim(); // ì§„ë£Œê³¼
			        const type       = row.children[1].innerText.trim(); // ë¶„ë¥˜
			        const status     = row.children[2].innerText.trim(); // ìƒíƒœ
			        const userId     = row.children[3].innerText.trim().toLowerCase();
			        const userName   = row.children[4].innerText.trim().toLowerCase();
			        const periodText = row.children[6].innerText.trim(); // yyyy-MM-dd ~ yyyy-MM-dd

			        let isVisible = true;

			        /* ===== ì§„ë£Œê³¼ ===== */
			        if (deptValue && department !== deptValue) {
			            isVisible = false;
			        }

			        /* ===== ë¶„ë¥˜ ===== */
			        if (typeValue && type !== typeValue) {
			            isVisible = false;
			        }

			        /* ===== ìƒíƒœ ===== */
			        if (statusValue && status !== statusValue) {
			            isVisible = false;
			        }

			        /* ===== í‚¤ì›Œë“œ (ID or ì´ë¦„ LIKE) ===== */
			        if (keyword) {
			            if (!userId.includes(keyword) && !userName.includes(keyword)) {
			                isVisible = false;
			            }
			        }

			        /* ===== ë‚ ì§œ (start_date ~ end_date ì‚¬ì´) ===== */
			        if (selectedDate) {
			            const [startDate, endDate] = periodText.split(' ~ ');
			            if (selectedDate < startDate || selectedDate > endDate) {
			                isVisible = false;
			            }
			        }

			        row.style.display = isVisible ? '' : 'none';
			    });
			}
	
	document.querySelectorAll('.btnView').forEach(btn => { //ê° ì„ íƒ ë²„íŠ¼
	    btn.addEventListener('click', () => { //í´ë¦­
	        const tr = btn.closest('tr'); // í´ë¦­í•œ í–‰ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
	        const status = btn.getAttribute('data-status'); // th:data-status

	        const department = tr.children[5].innerText; //ê° ì—´ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
	        const userId = tr.children[3].innerText;
	        const userName = tr.children[4].innerText;
	        const type = tr.children[1].innerText;
	        const reason = tr.children[8].innerText;

	        const period = tr.children[6].innerText.split(' ~ ');
	        const startDate = period[0].trim();
	        const endDate = period[1].trim();

	        document.getElementById('popupDepartment').value = department; //ì¶”ì¶œí•œ í…ìŠ¤íŠ¸ë¥¼ íŒì—…ì°½ ì¸í’‹í•„ë“œì— ë„£ê¸°
	        document.getElementById('popupUserId').value = userId;
	        document.getElementById('popupUserName').value = userName;
	        document.getElementById('popupType').value = type;
	        document.getElementById('popupReason').value = reason;
	        document.getElementById('popupStartDate').value = startDate;
	        document.getElementById('popupEndDate').value = endDate;

	        // ì´ˆê¸°í™” ( ë§¤ë²ˆ ìƒë‹¨, ì¤‘ì•™, í•˜ë‹¨ ë„ì›Œì£¼ê¸° )
	        popupTitle.innerHTML = '';
			popupFooter.innerHTML = '';

	        // ìƒíƒœë³„ ë²„íŠ¼
	        if(status === 'VAC_APPROVED_REQUESTED') { // ìŠ¹ì¸ ëŒ€ê¸°
	            popupTitle.innerText = 'ì‹ ê·œ ì‹ ì²­';
	            addFooterButton('ë°˜ë ¤', 'VAC_REJECTED', tr.children[0].innerText);
	            addFooterButton('ìŠ¹ì¸', 'VAC_APPROVED', tr.children[0].innerText);
	        } else if(status === 'VAC_APPROVED' || status === 'VAC_CANCEL_REQUESTED') { // ìŠ¹ì¸, ì·¨ì†Œ ëŒ€ê¸°
	            popupTitle.innerText = (status === 'VAC_CANCEL_REQUESTED') ? 'ì·¨ì†Œ ìŠ¹ì¸' : 'ìƒì„¸ ë³´ê¸°';
	            addFooterButton('ìŠ¹ì¸ ì·¨ì†Œ', 'VAC_CANCELLED', tr.children[0].innerText);
	        } else { // ì·¨ì†Œ, ë°˜ë ¤, ì‚¬ìš© ì™„ë£Œ
	            popupTitle.innerText = 'ìƒì„¸ ë³´ê¸°';
	        }
	        vacationPopup.style.display = 'block';
	    });
	});

	// ì´ì „ ë²„íŠ¼
	document.getElementById('popupBackBtn').addEventListener('click', () => {
	    vacationPopup.style.display = 'none';
	});

	// ë™ì  ë²„íŠ¼ ìƒì„±
	function addFooterButton(label, newStatus, vacationId) {
	    const btn = document.createElement('button'); //ë²„íŠ¼ ìƒˆë¡œ ë§Œë“¤ê¸°
	    btn.innerText = label; //í…ìŠ¤íŠ¸ëŠ” ì„¤ì •í•´ë‘”ê±°
	    btn.addEventListener('click', () => { // ë²„íŠ¼ í´ë¦­ ì‹œ
	        updateVacationStatus(vacationId, newStatus); //idë‘ status_codeë„˜ê¸°ê¸°
	        vacationPopup.style.display = 'none'; // ë²„íŠ¼ ì—†ì• ê¸°
	    });
	    popupFooter.appendChild(btn); // createElementí•œê²ƒì„ appendChildí•´ì•¼ ì‹¤ì œë¡œ í‘œì‹œë¨
	}

	// AJAXë¡œ ìƒíƒœ ë³€ê²½
	function updateVacationStatus(vacationId, newStatus) {
	    fetch(`/hr/vacation/updateStatus`, { // ì»¨íŠ¸ë¡¤ëŸ¬ í˜¸ì¶œ
	        method: 'POST',
	        headers: {'Content-Type': 'application/json'}, // JSON í˜•ì‹ì„ì„ ì„œë²„ì— ì•Œë ¤ì£¼ëŠ” í—¤ë”
	        body: JSON.stringify({vacationId: vacationId, status: newStatus}) // ì™¼ìª½ì´ ì»¨íŠ¸ë¡¤ëŸ¬ë‘ ë§ì•„ì•¼í•¨
	    })
	    .then(res => res.json()) // ì„œë²„ê°€ ì‘ë‹µ res í• ì‹œ JSON í˜•ì‹ìœ¼ë¡œ íŒŒì‹±
	    .then(data => { // JSONìœ¼ë¡œ íŒŒì‹±í•œ ê²°ê³¼ ì²˜ë¦¬
	        if(data.success) { 
	            alert('ìƒíƒœ ë³€ê²½ ì™„ë£Œ');
	            location.reload();
	        } else {
	            alert('ë³€ê²½ ì‹¤íŒ¨');
	        }
		    });
	}
	</script>
	<script src="/js/notify.js"></script>
	<script> //ì›¹ì†Œì¼“

		// 1. Notification ê¶Œí•œ ìš”ì²­
		function requestNotificationPermission() {
		    return new Promise((resolve, reject) => {
		        if (Notification.permission === "granted") resolve();
		        else if (Notification.permission !== "denied") {
		            Notification.requestPermission().then(permission => {
		                if (permission === "granted") resolve();
		                else reject("ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨");
		            });
		        } else {
		            reject("ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨");
		        }
		    });
		}

		// 2. ì›¹ì†Œì¼“ ì—°ê²° ë° êµ¬ë…
		function connectWebSocket(user_id) {
		    const socket = new SockJS('/ws');
		    const stompClient = Stomp.over(socket);
		    stompClient.debug = null;

		    stompClient.connect({}, function() {
		        console.log("STOMP ì—°ê²° ì„±ê³µ");

		        // HR ì „ì²´ ì•Œë¦¼ (ê¶Œí•œ í•„ìš” ì—†ìŒ, alertë¡œ í‘œì‹œ)
		        stompClient.subscribe('/topic/hr', function(msg) {
					const data = JSON.parse(msg.body);  // JSON íŒŒì‹±

					alert("ğŸ“¢ " + data.title + "\n" + data.content);
					location.reload();
		        });

		        // 1:1 ì§ì› ì•Œë¦¼ (Notification ì‚¬ìš©)
		        stompClient.subscribe('/user/queue/notify/' + user_id, function(msg) {
		            console.log('1:1 ë©”ì‹œì§€ ìˆ˜ì‹ :', msg.body);
		            const data = JSON.parse(msg.body);
		            if (Notification.permission === "granted") {
		                new Notification(data.title, { body: data.content });
		            } else {
		                console.warn("ì•Œë¦¼ ê¶Œí•œ ì—†ìŒ");
		            }
		        });
		    });
		}

		// 3. DOMContentLoadedì—ì„œ ì‹¤í–‰
		document.addEventListener("DOMContentLoaded", function() {
		    const user_id = document.getElementById("user_id").innerText.trim();

		    // HR ì•Œë¦¼ì€ ê¶Œí•œê³¼ ìƒê´€ì—†ì´ ì—°ê²°
		    connectWebSocket(user_id);

		    // 1:1 ì•Œë¦¼ì„ ìœ„í•´ Notification ê¶Œí•œ ìš”ì²­
		    requestNotificationPermission().catch(err => console.warn(err));
		});


	</script>
</body>
</html>
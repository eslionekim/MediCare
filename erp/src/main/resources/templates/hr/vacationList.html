<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>MediCare</title>
	<!-- 구글 폰트 링크 -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>/* 전체 리셋 및 기본 배경 */
	body {
	    margin: 0;
	    padding: 0;
	    font-family: 'Inter', '맑은 고딕', sans-serif;
	    background-color: #D5DDED; /* 이미지의 연한 푸른색 배경 */
	
	}
	
	
	/* 상단 헤더 배경 및 레이아웃 */
	.top-bar {
	    display: flex;
	    justify-content: space-between;
	    align-items: center;
	    padding: 5px 15px;
	    background-color: #ffffff; /* 흰색 배경 */
	    font-size: 14px;
	}
	
	/* 상단 헤더 텍스트 스타일 */
	.user-info {
	    color: #555;
	}
	
	/* 상단 헤더 -> 로그아웃 출근 퇴근 배열 */
	.action-buttons {
	    display: flex;
	    gap: 5px;
	}
	
	/* 상단 헤더 -> 로그아웃 출근 퇴근 공통스타일 */
	.action-buttons button {
	    padding: 4px 12px;
	    border: none;
	    border-radius: 4px;
	    cursor: pointer;
	    font-weight: 500;
	    font-size: 13px;
		border: 1px solid #7B7B7B;
	}
	
	/* 상단 헤더 -> 로그아웃 버튼 스타일 */
	.btn-logout {
		padding: 4px 12px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-weight: 500;
		font-size: 13px;
		color: white;
	    background-color: #FF4B4B;
		border: 1px solid #7B7B7B;
	}
	
	/* 상단 헤더 -> 출근 버튼 스타일 */
	.time-in {
	    background-color: #879BD5;
		color:#ffffff;
	}
	
	/* 상단 헤더 -> 퇴근 버튼 스타일 */
	.time-out {
	    background-color: #D5DDED;
	    color: #000;
	}

	/* 중앙 헤더 -> 카테고리 배치 */
	.tab-list {
	    list-style: none; /* 앞에 점 제거*/
	    margin: 0;
	    padding: 0;
	    display: flex; /* 가로 나열*/
	}
	
	/* 중앙 헤더 -> 카테고리 요소 스타일 */
	.tab-item a {
	    display: block;
	    padding: 8px 15px;
	    text-decoration: none; /* 카테고리 밑줄 제거*/
	    color: #333; /* 글자 색*/
	    background-color: transparent; /* 배경색 투명 (nav-tabs의 배경색 사용) */
	    border: none; /* 경계선 제거 */
	    font-size: 14px;
	    font-weight: normal;
	}
	
	/* 2. 중앙 헤더 공통 ⭐ */
	.nav-tabs {
		background-color: #D5DDED; /* 이미지의 균일한 하늘색 배경 */
		padding: 0 10px;
	}
	
	/* 중앙 헤더 -> 카테고리 호버 */
	.tab-item:hover {
	    background-color: rgba(255, 255, 255, 0.3); /* 마지막 숫자가 컬러 세기 정도*/
	}
	
	/* 중앙 헤더 -> 선택된 카테고리 스타일 */
	.tab-item.active a {
	    color: #333; /* 텍스트 색상은 검은색 유지 (사진처럼) */
	    font-weight: 550;
	    /* 하단에 진한 파란색 선으로 강조 */
	}
	
	
	/* 3. 하단 헤더  */
	.sub-menu {
	    background-color: #BACCFF; /* 흰색 배경 */
	    padding: 5px 15px; /* 패딩을 줄여서 메뉴와 붙은 느낌 */
	    font-size: 14px;
	    color: #555;
		font-weight: 530;
	    /* 이미지처럼 '금일 진료 리스트' 텍스트를 진하게 표현 */
	}
	
	/* 컨텐츠 영역 (전체 배경색 확인용) */
	.content-area {
	    min-height: 500px; /* 임시 높이 */
	    background-color: #D5DDED; /* 나머지 화면을 덮는 배경색 */
	}
	
	/* 금일 진료 리스트 */
	#table{ /* div 영역 및 레이아웃 */
		margin:5px;
		margin-left: auto;
		margin-right: auto;
	}
	
	table { 
	    width: 90%; /* 너비 */
	    border-collapse: collapse; /* 표 한줄로 합치기 */
	    font-size: 14px;
	    background-color: white;
		
	 }

	 th, td {
	     border: 1px solid #7B7B7B; /* 칸 당 테두리*/
	     padding: 0;
		 height: 25px; /* 원하는 셀 높이 */
	     text-align: center; /* 텍스트 중앙 */
	 }

	 th {
	     background-color: #879BD5; 
		 font-weight: normal; /* 글씨 굵기 보통으로 */
		 color: rgb(31, 31, 31);
	 }

	 tr:nth-child(even) {
	     background-color: #ffffffff;
	 }

	 /* 접수 시작 */
	 .first {
		 display: flex;             /* flex로 변환 */
		 justify-content: center;   /* 가로 중앙 */
		 align-items: center;       /* 세로 중앙 */
		 width: 100%;               /* 가로 꽉 */
		 height: 100%;              /* 세로 꽉 */
		 box-sizing: border-box;    /* 패딩 포함 계산 */
		 border: none;
		 background-color: #00FF08;
		 color: black;
		 cursor: pointer;
		 font-size: 14px;
		 font-weight: 300; /* 글씨 굵기 보통으로 */
		 text-decoration: none;
	  }

	
	</style>
</head>
<body>
    <header class="main-header">
		<!-- 상단 헤더 -->
        <div class="top-bar">
            <div class="user-info">
                <span>(아이콘)</span>
                <span>MediCare |</span>
                <span>사용자ID: </span>
            </div>
            <div class="user-info">
                <span>진료과 ㅇㅇㅇ</span>
				<button class="btn-logout">로그아웃</button>
			</div>
            <div class="action-buttons">
                <button class="time-in">출근</button>
                <button class="time-out">퇴근</button>
            </div>
        </div>
		<!-- 상단 헤더 끝-->
		
		<!-- 중앙 헤더-->
        <nav class="nav-tabs">
            <ul class="tab-list">
                <li class="tab-item"><a href="">직원 스케줄 조회</a></li>
                <li class="tab-item active"><a href="">휴가 신청 리스트</a></li>
                <li class="tab-item"><a href="#">스케줄 부여</a></li>
                <li class="tab-item"><a href="#">근태 현황</a></li>
            </ul>
        </nav>
		<!-- 중앙 헤더 끝-->
		
		<!-- 하단 헤더-->
        <div class="sub-menu">
            <span>휴가 신청 리스트</span>
        </div>
		<!-- 하단 헤더 끝-->
    </header>

	<!-- 콘텐츠 영역 시작-->
    <div class="content-area">
		<!-- 상태 필터링 -->
		<div style="width:90%; margin: 5px auto; display:flex; justify-content:flex-end;">
		    <select id="statusFilter" style="padding: 5px; font-size: 14px;">
		        <option value="">전체 보기</option>
		        <option value="대기 중">대기 중</option>
		        <option value="진료중">진료중</option>
		        <option value="진료종료">진료종료</option>
		        <option value="수납/청구완료">수납/청구완료</option>
		    </select>
		</div>

		<!-- 금일 진료 리스트 -->
		<table id="table" border="1">
			<thead>
			    <tr>
			        <th>휴가코드</th>
			        <th>분류</th>
			        <th>상태</th>
			        <th>직원ID</th>
			        <th>직원명</th>
			        <th>진료과</th>
					<th>사용 기간</th>
					<th>선행 검사 상태</th>
					<th>내원사유</th>
			        <th>선택</th>
			    </tr>
			</thead>

			<tbody>
				<tr th:if="${vacation.size() == 0}">
				        <td colspan="10" class="no-data" style="height: 500px;">내역이 없습니다.</td>
				    </tr>

				    <tr th:each="v : ${vacation}">
						<td th:text="${v.vacation_id}"></td>
						<td th:text="${v.vacation_type.type_name}"></td>
						<td th:text="${v.status_code.name}"></td>
						<td th:text="${v.user_account.user_id}"></td>
						<td th:text="${v.user_account.name}"></td>
						<td th:text="${#lists.isEmpty(v.user_account.staff_profile) ? '-' : v.user_account.staff_profile.get(0).department.name}"></td>
						<td th:text="${#temporals.format(v.start_date, 'yyyy-MM-dd')} + ' ~ ' + ${#temporals.format(v.end_date, 'yyyy-MM-dd')}"></td>
						<td></td>
						<td th:text="${v.reason}"></td>
						<td>
						        <button type="button" th:data-id="${v.vacation_id}" 
						                th:data-status="${v.status_code.status_code}" 
						                class="btnView">선택</button>
						    </td>
				    </tr>
					
					<!-- 빈 행을 채워 최소 10행으로 유지 -->
					    <tr th:if="${vacation.size() >0 }" 
					        th:each="i : ${#numbers.sequence(vacation.size() + 1, 20)}">
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					</tr>
			</tbody>
		</table>
		
		<!-- 팝업 -->
		<div id="vacationPopup" class="popup" style="display:none;"> <!-- 안보이게 -->
		    <div class="popup-header"> <!-- 상단 -->
		        <button id="popupBackBtn">이전</button>
		        <span id="popupTitle">상세 보기</span>
		    </div>
		    <div class="popup-content"> <!-- 중앙 -->
		        <label>진료과:</label>
		        <input type="text" id="popupDepartment" readonly />

		        <label>직원ID:</label>
		        <input type="text" id="popupUserId" readonly />

		        <label>직원명:</label>
		        <input type="text" id="popupUserName" readonly />

		        <label>기간:</label>
		        <input type="date" id="popupStartDate" readonly />
		        <input type="date" id="popupEndDate" readonly />

		        <label>분류:</label>
		        <input type="text" id="popupType" readonly />

		        <label>사유:</label>
		        <textarea id="popupReason" readonly ></textarea>
		</div>
		<div class="popup-footer" id="popupFooter"></div> <!-- 하단 -->
		
		
    </div>
	<!-- 콘텐츠 영역 끝-->
	
	<script>
	const vacationPopup = document.getElementById('vacationPopup'); //팝업창 DOM요소 접근
	const popupFooter = document.getElementById('popupFooter'); //하단 DOM요소 접근
	const popupTitle = document.getElementById('popupTitle'); //상단 DOM요소 접근

	document.querySelectorAll('.btnView').forEach(btn => { //각 선택 버튼
	    btn.addEventListener('click', () => { //클릭
	        const tr = btn.closest('tr'); // 클릭한 행 기준으로 데이터 가져오기
	        const status = btn.getAttribute('data-status'); // th:data-status

	        const department = tr.children[5].innerText; //각 열에서 텍스트 추출
	        const userId = tr.children[3].innerText;
	        const userName = tr.children[4].innerText;
	        const type = tr.children[1].innerText;
	        const reason = tr.children[8].innerText;

	        const period = tr.children[6].innerText.split(' ~ ');
	        const startDate = period[0].trim();
	        const endDate = period[1].trim();

	        document.getElementById('popupDepartment').value = department; //추출한 텍스트를 팝업창 인풋필드에 넣기
	        document.getElementById('popupUserId').value = userId;
	        document.getElementById('popupUserName').value = userName;
	        document.getElementById('popupType').value = type;
	        document.getElementById('popupReason').value = reason;
	        document.getElementById('popupStartDate').value = startDate;
	        document.getElementById('popupEndDate').value = endDate;

	        // 초기화 ( 매번 상단, 중앙, 하단 띄워주기 )
	        popupTitle.innerHTML = '';
			popupFooter.innerHTML = '';

	        // 상태별 버튼
	        if(status === 'VAC_APPROVED_REQUESTED') { // 승인 대기
	            popupTitle.innerText = '신규 신청';
	            addFooterButton('반려', 'VAC_REJECTED', tr.children[0].innerText);
	            addFooterButton('승인', 'VAC_APPROVED', tr.children[0].innerText);
	        } else if(status === 'VAC_APPROVED' || status === 'VAC_CANCEL_REQUESTED') { // 승인, 취소 대기
	            popupTitle.innerText = (status === 'VAC_CANCEL_REQUESTED') ? '취소 승인' : '상세 보기';
	            addFooterButton('승인 취소', 'VAC_CANCELLED', tr.children[0].innerText);
	        } else { // 취소, 반려, 사용 완료
	            popupTitle.innerText = '상세 보기';
	        }
	        vacationPopup.style.display = 'block';
	    });
	});

	// 이전 버튼
	document.getElementById('popupBackBtn').addEventListener('click', () => {
	    vacationPopup.style.display = 'none';
	});

	// 동적 버튼 생성
	function addFooterButton(label, newStatus, vacationId) {
	    const btn = document.createElement('button'); //버튼 새로 만들기
	    btn.innerText = label; //텍스트는 설정해둔거
	    btn.addEventListener('click', () => { // 버튼 클릭 시
	        updateVacationStatus(vacationId, newStatus); //id랑 status_code넘기기
	        vacationPopup.style.display = 'none'; // 버튼 없애기
	    });
	    popupFooter.appendChild(btn); // createElement한것을 appendChild해야 실제로 표시됨
	}

	// AJAX로 상태 변경
	function updateVacationStatus(vacationId, newStatus) {
	    fetch(`/hr/vacation/updateStatus`, { // 컨트롤러 호출
	        method: 'POST',
	        headers: {'Content-Type': 'application/json'}, // JSON 형식임을 서버에 알려주는 헤더
	        body: JSON.stringify({vacationId: vacationId, status: newStatus}) // 왼쪽이 컨트롤러랑 맞아야함
	    })
	    .then(res => res.json()) // 서버가 응답 res 할시 JSON 형식으로 파싱
	    .then(data => { // JSON으로 파싱한 결과 처리
	        if(data.success) { 
	            alert('상태 변경 완료');
	            location.reload();
	        } else {
	            alert('변경 실패');
	        }
	    });
	}
	</script>
</body>
</html>
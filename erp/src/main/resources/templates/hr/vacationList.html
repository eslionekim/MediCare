<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

    <title>MediCare</title>
	<!-- 구글 폰트 링크 -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>/* 전체 리셋 및 기본 배경 */
	body {
	    margin: 0;
	    padding: 0;
	    font-family: 'Inter', '맑은 고딕', sans-serif;
	    background-color: #D5DDED; /* 이미지의 연한 푸른색 배경 */
	
	}
	
	
	/* 상단 헤더 배경 및 레이아웃 */
	.top-bar {
	    display: flex;
	    justify-content: space-between;
	    align-items: center;
	    padding: 5px 15px;
	    background-color: #ffffff; /* 흰색 배경 */
	    font-size: 14px;
	}
	
	/* 상단 헤더 텍스트 스타일 */
	.user-info {
	    color: #555;
	}
	
	/* 상단 헤더 -> 로그아웃 출근 퇴근 배열 */
	.action-buttons {
	    display: flex;
	    gap: 5px;
	}
	
	/* 상단 헤더 -> 로그아웃 출근 퇴근 공통스타일 */
	.action-buttons button {
	    padding: 4px 12px;
	    border: none;
	    border-radius: 4px;
	    cursor: pointer;
	    font-weight: 500;
	    font-size: 13px;
		border: 1px solid #7B7B7B;
	}
	
	/* 상단 헤더 -> 로그아웃 버튼 스타일 */
	.btn-logout {
		padding: 4px 12px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-weight: 500;
		font-size: 13px;
		color: white;
	    background-color: #FF4B4B;
		border: 1px solid #7B7B7B;
	}
	
	/* 상단 헤더 -> 출근 버튼 스타일 */
	.time-in {
	    background-color: var(--ui-panel-title);
		color:#ffffff;
	}
	
	/* 상단 헤더 -> 퇴근 버튼 스타일 */
	.time-out {
	    background-color: #D5DDED;
	    color: #000;
	}

	/* 중앙 헤더 -> 카테고리 배치 */
	.tab-list {
	    list-style: none; /* 앞에 점 제거*/
	    margin: 0;
	    padding: 0;
	    display: flex; /* 가로 나열*/
	}
	
	/* 중앙 헤더 -> 카테고리 요소 스타일 */
	.tab-item a {
	    display: block;
	    padding: 8px 15px;
	    text-decoration: none; /* 카테고리 밑줄 제거*/
	    color: #333; /* 글자 색*/
	    background-color: transparent; /* 배경색 투명 (nav-tabs의 배경색 사용) */
	    border: none; /* 경계선 제거 */
	    font-size: 14px;
	    font-weight: normal;
	}
	
	/* 2. 중앙 헤더 공통 ⭐ */
	.nav-tabs {
		background-color: #D5DDED; /* 이미지의 균일한 하늘색 배경 */
		padding: 0 10px;
	}
	
	/* 중앙 헤더 -> 카테고리 호버 */
	.tab-item:hover {
	    background-color: rgba(255, 255, 255, 0.3); /* 마지막 숫자가 컬러 세기 정도*/
	}
	
	/* 중앙 헤더 -> 선택된 카테고리 스타일 */
	.tab-item.active a {
	    color: #333; /* 텍스트 색상은 검은색 유지 (사진처럼) */
	    font-weight: 550;
	    /* 하단에 진한 파란색 선으로 강조 */
	}
	
	
	/* 3. 하단 헤더  */
	.sub-menu {
	    background-color: #BACCFF; /* 흰색 배경 */
	    padding: 5px 15px; /* 패딩을 줄여서 메뉴와 붙은 느낌 */
	    font-size: 14px;
	    color: #555;
		font-weight: 530;
	    /* 이미지처럼 '금일 진료 리스트' 텍스트를 진하게 표현 */
	}
	
	/* 컨텐츠 영역 (전체 배경색 확인용) */
	.content-area {
	    min-height: 500px; /* 임시 높이 */
	    background-color: #D5DDED; /* 나머지 화면을 덮는 배경색 */
	}
	
	/* 금일 진료 리스트 */
	#table{ /* div 영역 및 레이아웃 */
		margin:5px;
		margin-left: auto;
		margin-right: auto;
	}
	
	table { 
	    width: 90%; /* 너비 */
	    border-collapse: collapse; /* 표 한줄로 합치기 */
	    font-size: 14px;
	    background-color: white;
		
	 }

	 th, td {
	     border: 1px solid #7B7B7B; /* 칸 당 테두리*/
	     padding: 0;
		 height: 25px; /* 원하는 셀 높이 */
	     text-align: center; /* 텍스트 중앙 */
	 }

	 th {
	     background-color: var(--ui-panel-title); 
		 font-weight: normal; /* 글씨 굵기 보통으로 */
		 color: rgb(31, 31, 31);
	 }

	 tr:nth-child(even) {
	     background-color: #ffffffff;
	 }

	 /* 접수 시작 */
	 .first {
		 display: flex;             /* flex로 변환 */
		 justify-content: center;   /* 가로 중앙 */
		 align-items: center;       /* 세로 중앙 */
		 width: 100%;               /* 가로 꽉 */
		 height: 100%;              /* 세로 꽉 */
		 box-sizing: border-box;    /* 패딩 포함 계산 */
		 border: none;
		 background-color: #00FF08;
		 color: black;
		 cursor: pointer;
		 font-size: 14px;
		 font-weight: 300; /* 글씨 굵기 보통으로 */
		 text-decoration: none;
	  }

	  .item-scroll {
	      width: 90%;
	      margin: 5px auto;
	      max-height: 520px;
	      overflow-y: auto;
	      border: 1px solid #7B7B7B;
	      background-color: #ffffff;
	  }

	  .item-scroll table {
	      width: 100%;
	  }
	
	  /* 팝업 전체 스타일 (중앙 고정 + 적당한 너비) */
	  .popup {
	      display: none;
	      position: fixed;
	      top: 50%;
	      left: 50%;
	      transform: translate(-50%, -50%);
	      width: 500px;           /* 적당한 너비 */
	      max-width: 90%;         /* 화면 작으면 줄어듦 */
	      background: rgb(255, 255, 255);    /* 기존 색감 */
	      border-radius: 8px;     /* 기존 테두리 반경 */
	      box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* 기존 그림자 */
	      padding: 20px;
	      z-index: 1000;
	      font-size: 14px;
	  }

	  /* 팝업 헤더 */
	  .popup-header {
	      display: flex;
	      justify-content: space-between;
	      align-items: center;
	      margin-bottom: 15px;
	      font-weight: 600;
	      font-size: 16px;
	  }

	  #popupCloseBtn {
	      background: none;
	      border: none;
	      font-size: 20px;
	      cursor: pointer;
	      color: #333;
	  }

	  /* 팝업 내용 */
	  .popup-content {
	      display: flex;
	      flex-direction: column;
	      gap: 10px;
	  }

	  /* 인풋/텍스트에어리어/셀렉트 */
	  .popup-content input,
	  .popup-content textarea,
	  .popup-content select {
	      width: 100%;
	      padding: 5px 8px; /* 기존 색감 스타일 따라감 */
	      font-size: 14px;
	      border-radius: 4px;
	      border: 1px solid #b0b7c7;
	      margin-bottom: 5px;
	      box-sizing: border-box;
	  }

	  /* footer (버튼 영역) */
	  .popup-footer {
	      display: flex;
	      justify-content: flex-end;
	      gap: 10px;
	      margin-top: 15px;
	      flex-wrap: wrap; /* 화면 작으면 버튼 줄바꿈 */
	  }

	  .popup-footer button {
	      padding: 6px 12px;
	      border: none;
	      border-radius: 4px;
	      cursor: pointer;
	      font-weight: 500;
	  }

	  /* 버튼 색감 */
	  .popup-footer .approve {
	      background-color: #879BD5; /* 기존 submitVacation 색 */
	      color: #fff;
	  }

	  .popup-footer .reject {
	      background-color: #ccc;    /* 기존 closePopup 색 */
	      color: #333;
	  }


    </style>
<link rel="stylesheet" th:href="@{/css/common-base.css}">
	
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
	
</head>
<body th:attr="data-user-id=${username}">
   	<div th:replace="~{fragments/hr-header :: header(title='휴가 신청 리스트', activeTab='vacationList')}"></div>


	<!-- 콘텐츠 영역 시작-->
    <div class="content-area">
		<!-- 검색 영역 -->
		<div id="vacationSearchArea" style="width:90%; margin:10px auto; display:flex; gap:10px; justify-content:center;">

		    <!-- 진료과 -->
		    <select id="departmentSelect">
		        <option value="">진료과 전체</option>
		    </select>

		    <!-- 분류 -->
		    <select id="typeSelect">
		        <option value="">분류 전체</option>
		    </select>

		    <!-- 상태 -->
		    <select id="statusSelect">
		        <option value="">상태 전체</option>
		    </select>

		    <!-- 직원 검색 -->
		    <input type="text" id="keyword" placeholder="직원명 / 직원ID">

		    <!-- 날짜 -->
		    <input type="date" id="Date">

		    <button>검색</button>
		</div>


		<div class="section-title" style="width:90%; margin:5px auto 0;">&#47785;&#47197;</div>
		<!-- 금일 진료 리스트 -->
		<div class="item-scroll">
		<table id="table" border="1">
			<thead>
			    <tr>
			        <th>휴가코드</th>
			        <th>분류</th>
			        <th>상태</th>
			        <th>직원ID</th>
			        <th>직원명</th>
			        <th>진료과</th>
					<th>사용 기간</th>
					<th>사유</th>
			        <th>선택</th>
			    </tr>
			</thead>

			<tbody>
				<tr th:if="${vacation.size() == 0}">
				        <td colspan="10" class="no-data" style="height: 500px;">내역이 없습니다.</td>
				    </tr>

				    <tr th:each="v : ${vacation}">
						<td th:text="${v.vacation_id}"></td>
						<td th:text="${v.vacation_type.type_name}"></td>
						<td th:text="${v.status_code.name}"></td>
						<td th:text="${v.user_account.user_id}"></td>
						<td th:text="${v.user_account.name}"></td>
						<td th:text="${#lists.isEmpty(v.user_account.staff_profile) ? '-' : v.user_account.staff_profile.get(0).department.name}"></td>
						<td th:text="${#temporals.format(v.start_date, 'yyyy-MM-dd')} + ' ~ ' + ${#temporals.format(v.end_date, 'yyyy-MM-dd')}"></td>
				
						<td th:text="${v.reason}"></td>
						<td>
						        <button type="button" th:data-id="${v.vacation_id}" 
						                th:data-status="${v.status_code.status_code}" 
						                class="btnView">선택</button>
						    </td>
				    </tr>
					
					<!-- 빈 행을 채워 최소 10행으로 유지 -->
					    <tr th:if="${vacation.size() >0 and vacation.size() <20}" 
					        th:each="i : ${#numbers.sequence(vacation.size() + 1, 20)}">
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					        <td>&nbsp;</td>
					</tr>
			</tbody>
		</table>
		</div>
		<!-- 팝업 -->
		<!-- 팝업 -->
		<div id="vacationPopup" class="popup" style="display:none;">
		    <div class="popup-header">
		        <span id="popupTitle">상세 보기</span>
		        <button id="popupCloseBtn">이전</button>
		    </div>
		    <div class="popup-content">
		        <label>진료과</label>
		        <input type="text" id="popupDepartment" readonly />

		        <label>직원ID</label>
		        <input type="text" id="popupUserId" readonly />

		        <label>직원명</label>
		        <input type="text" id="popupUserName" readonly />

		        <label>기간</label>
		        <input type="date" id="popupStartDate" readonly />
		        <input type="date" id="popupEndDate" readonly />

		        <label>분류</label>
		        <input type="text" id="popupType" readonly />

		        <label>사유</label>
		        <textarea id="popupReason" readonly></textarea>
		    </div>
		    <div class="popup-footer" id="popupFooter"></div>
		</div>

		
		
    </div>
	<!-- 콘텐츠 영역 끝-->
	
	<script>
	const vacationPopup = document.getElementById('vacationPopup'); //팝업창 DOM요소 접근
	const popupFooter = document.getElementById('popupFooter'); //하단 DOM요소 접근
	const popupTitle = document.getElementById('popupTitle'); //상단 DOM요소 접근

	document.querySelector('#vacationSearchArea button').addEventListener('click', filterVacationTable); //드롭다운

			document.addEventListener('DOMContentLoaded', () => { //드롭다운
			    loadDepartments();
			    loadVacationTypes();
			    loadVacationStatuses();
			});

			/* =====================
			   진료과 드롭다운
			===================== */
			function loadDepartments() {
			    fetch('/hr/allSchedule/departments')
			        .then(res => res.json())
			        .then(data => {
			            const select = document.getElementById('departmentSelect');
			            select.innerHTML = '<option value="">진료과 전체</option>';

			            data.forEach(d => {
			                const opt = document.createElement('option');
							opt.value = d.name;      // 코드 → 이름
							                opt.textContent = d.name;
			                select.appendChild(opt);
			            });
			        });
			}

			/* =====================
			   휴가 분류 드롭다운
			===================== */
			function loadVacationTypes() {
			    fetch('/hr/vacationList/types')
			        .then(res => res.json())
			        .then(data => {
			            const select = document.getElementById('typeSelect');
			            select.innerHTML = '<option value="">분류 전체</option>';

			            data.forEach(t => {
			                const opt = document.createElement('option');
							opt.value = t.typeName;   // 코드 → 이름
							opt.textContent = t.typeName;
			                select.appendChild(opt);
			            });
			        });
			}

			/* =====================
			   휴가 상태 드롭다운
			===================== */
			function loadVacationStatuses() {
			    fetch('/hr/vacation/status')
			        .then(res => res.json())
			        .then(data => {
			            const select = document.getElementById('statusSelect');
			            select.innerHTML = '<option value="">상태 전체</option>';

			            data.forEach(s => {
			                const opt = document.createElement('option');
							opt.value = s.name;      // 코드 → 이름
							opt.textContent = s.name;
			                select.appendChild(opt);
			            });
			        });
			}
			
			function filterVacationTable() { //검색
			    const deptValue   = document.getElementById('departmentSelect').value;
			    const typeValue   = document.getElementById('typeSelect').value;
			    const statusValue = document.getElementById('statusSelect').value;
			    const keyword     = document.getElementById('keyword').value.trim().toLowerCase();
			    const selectedDate = document.getElementById('Date').value;

			    const rows = document.querySelectorAll('#table tbody tr');

			    rows.forEach(row => {
			        // "내역이 없습니다" / 빈 행 제외
			        if (row.children.length < 9) return;

			        const department = row.children[5].innerText.trim(); // 진료과
			        const type       = row.children[1].innerText.trim(); // 분류
			        const status     = row.children[2].innerText.trim(); // 상태
			        const userId     = row.children[3].innerText.trim().toLowerCase();
			        const userName   = row.children[4].innerText.trim().toLowerCase();
			        const periodText = row.children[6].innerText.trim(); // yyyy-MM-dd ~ yyyy-MM-dd

			        let isVisible = true;

			        /* ===== 진료과 ===== */
			        if (deptValue && department !== deptValue) {
			            isVisible = false;
			        }

			        /* ===== 분류 ===== */
			        if (typeValue && type !== typeValue) {
			            isVisible = false;
			        }

			        /* ===== 상태 ===== */
			        if (statusValue && status !== statusValue) {
			            isVisible = false;
			        }

			        /* ===== 키워드 (ID or 이름 LIKE) ===== */
			        if (keyword) {
			            if (!userId.includes(keyword) && !userName.includes(keyword)) {
			                isVisible = false;
			            }
			        }

			        /* ===== 날짜 (start_date ~ end_date 사이) ===== */
			        if (selectedDate) {
			            const [startDate, endDate] = periodText.split(' ~ ');
			            if (selectedDate < startDate || selectedDate > endDate) {
			                isVisible = false;
			            }
			        }

			        row.style.display = isVisible ? '' : 'none';
			    });
			}
	
	document.querySelectorAll('.btnView').forEach(btn => { //각 선택 버튼
	    btn.addEventListener('click', () => { //클릭
	        const tr = btn.closest('tr'); // 클릭한 행 기준으로 데이터 가져오기
	        const status = btn.getAttribute('data-status'); // th:data-status

	        const department = tr.children[5].innerText; //각 열에서 텍스트 추출
	        const userId = tr.children[3].innerText;
	        const userName = tr.children[4].innerText;
	        const type = tr.children[1].innerText;
	        const reason = tr.children[8].innerText;

	        const period = tr.children[6].innerText.split(' ~ ');
	        const startDate = period[0].trim();
	        const endDate = period[1].trim();

	        document.getElementById('popupDepartment').value = department; //추출한 텍스트를 팝업창 인풋필드에 넣기
	        document.getElementById('popupUserId').value = userId;
	        document.getElementById('popupUserName').value = userName;
	        document.getElementById('popupType').value = type;
	        document.getElementById('popupReason').value = reason;
	        document.getElementById('popupStartDate').value = startDate;
	        document.getElementById('popupEndDate').value = endDate;

	        // 초기화 ( 매번 상단, 중앙, 하단 띄워주기 )
	        popupTitle.innerHTML = '';
			popupFooter.innerHTML = '';

	        // 상태별 버튼
	        if(status === 'VAC_APPROVED_REQUESTED') { // 승인 대기
	            popupTitle.innerText = '신규 신청';
	            addFooterButton('반려', 'VAC_REJECTED', tr.children[0].innerText);
	            addFooterButton('승인', 'VAC_APPROVED', tr.children[0].innerText);
	        } else if(status === 'VAC_APPROVED' || status === 'VAC_CANCEL_REQUESTED') { // 승인, 취소 대기
	            popupTitle.innerText = (status === 'VAC_CANCEL_REQUESTED') ? '취소 승인' : '상세 보기';
	            addFooterButton('승인 취소', 'VAC_CANCELLED', tr.children[0].innerText);
	        } else { // 취소, 반려, 사용 완료
	            popupTitle.innerText = '상세 보기';
	        }
	        vacationPopup.style.display = 'block';
	    });
	});

	// 이전 버튼
	document.getElementById('popupCloseBtn').addEventListener('click', () => {
	    vacationPopup.style.display = 'none';
	});

	// 동적 버튼 생성
	function addFooterButton(label, newStatus, vacationId) {
	    const btn = document.createElement('button'); //버튼 새로 만들기
	    btn.innerText = label; //텍스트는 설정해둔거
	    btn.addEventListener('click', () => { // 버튼 클릭 시
	        updateVacationStatus(vacationId, newStatus); //id랑 status_code넘기기
	        vacationPopup.style.display = 'none'; // 버튼 없애기
	    });
	    popupFooter.appendChild(btn); // createElement한것을 appendChild해야 실제로 표시됨
	}

	// AJAX로 상태 변경
	function updateVacationStatus(vacationId, newStatus) {
	    fetch(`/hr/vacation/updateStatus`, { // 컨트롤러 호출
	        method: 'POST',
	        headers: {'Content-Type': 'application/json'}, // JSON 형식임을 서버에 알려주는 헤더
	        body: JSON.stringify({vacationId: vacationId, status: newStatus}) // 왼쪽이 컨트롤러랑 맞아야함
	    })
	    .then(res => res.json()) // 서버가 응답 res 할시 JSON 형식으로 파싱
	    .then(data => { // JSON으로 파싱한 결과 처리
	        if(data.success) { 
	            alert('상태 변경 완료');
	            location.reload();
	        } else {
	            alert('변경 실패');
	        }
		    });
	}
	</script>
	<script src="/js/notify.js"></script>
	<script> //웹소켓

		// 1. Notification 권한 요청
		function requestNotificationPermission() {
		    return new Promise((resolve, reject) => {
		        if (Notification.permission === "granted") resolve();
		        else if (Notification.permission !== "denied") {
		            Notification.requestPermission().then(permission => {
		                if (permission === "granted") resolve();
		                else reject("알림 권한 거부됨");
		            });
		        } else {
		            reject("알림 권한 거부됨");
		        }
		    });
		}

		// 2. 웹소켓 연결 및 구독
		function connectWebSocket(user_id) {
		    const socket = new SockJS('/ws');
		    const stompClient = Stomp.over(socket);
		    stompClient.debug = null;

		    stompClient.connect({}, function() {
		        console.log("STOMP 연결 성공");

		        // HR 전체 알림 (권한 필요 없음, alert로 표시)
		        stompClient.subscribe('/topic/hr', function(msg) {
					const data = JSON.parse(msg.body);  // JSON 파싱

					alert(data.title + "\n" + data.content);
					location.reload();
		        });

		        // 1:1 직원 알림 (Notification 사용)
		        stompClient.subscribe('/user/queue/notify/' + user_id, function(msg) {
		            console.log('1:1 메시지 수신:', msg.body);
		            const data = JSON.parse(msg.body);
		            if (Notification.permission === "granted") {
		                new Notification(data.title, { body: data.content });
		            } else {
		                console.warn("알림 권한 없음");
		            }
		        });
		    });
		}

		// 3. DOMContentLoaded에서 실행
		document.addEventListener("DOMContentLoaded", function() {
			const user_id = document.body.dataset.userId || document.getElementById("user_id")?.innerText?.trim();
			if (!user_id) return;

		    // HR 알림은 권한과 상관없이 연결
		    connectWebSocket(user_id);

		    // 1:1 알림을 위해 Notification 권한 요청
		    requestNotificationPermission().catch(err => console.warn(err));
		});


	</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>MediCare</title>
	<!-- êµ¬ê¸€ í°íŠ¸ ë§í¬ -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>/* ì „ì²´ ë¦¬ì…‹ ë° ê¸°ë³¸ ë°°ê²½ */
	body {
	    margin: 0;
	    padding: 0;
	    font-family: 'Inter', 'ë§‘ì€ ê³ ë”•', sans-serif;
	    background-color: #D5DDED; /* ì´ë¯¸ì§€ì˜ ì—°í•œ í‘¸ë¥¸ìƒ‰ ë°°ê²½ */
	
	}
	
	
	/* ìƒë‹¨ í—¤ë” ë°°ê²½ ë° ë ˆì´ì•„ì›ƒ */
	.top-bar {
	    display: flex;
	    justify-content: space-between;
	    align-items: center;
	    padding: 5px 15px;
	    background-color: #ffffff; /* í°ìƒ‰ ë°°ê²½ */
	    font-size: 14px;
	}
	
	/* ìƒë‹¨ í—¤ë” í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
	.user-info {
	    color: #555;
	}
	
	/* ìƒë‹¨ í—¤ë” -> ë¡œê·¸ì•„ì›ƒ ì¶œê·¼ í‡´ê·¼ ë°°ì—´ */
	.action-buttons {
	    display: flex;
	    gap: 5px;
	}
	
	/* ìƒë‹¨ í—¤ë” -> ë¡œê·¸ì•„ì›ƒ ì¶œê·¼ í‡´ê·¼ ê³µí†µìŠ¤íƒ€ì¼ */
	.action-buttons button {
	    padding: 4px 12px;
	    border: none;
	    border-radius: 4px;
	    cursor: pointer;
	    font-weight: 500;
	    font-size: 13px;
		border: 1px solid #7B7B7B;
	}
	
	/* ìƒë‹¨ í—¤ë” -> ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.btn-logout {
		padding: 4px 12px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-weight: 500;
		font-size: 13px;
		color: white;
	    background-color: #FF4B4B;
		border: 1px solid #7B7B7B;
	}
	
	/* ìƒë‹¨ í—¤ë” -> ì¶œê·¼ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.time-in {
	    background-color: #879BD5;
		color:#ffffff;
	}
	
	/* ìƒë‹¨ í—¤ë” -> í‡´ê·¼ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
	.time-out {
	    background-color: #D5DDED;
	    color: #000;
	}

	/* ì¤‘ì•™ í—¤ë” -> ì¹´í…Œê³ ë¦¬ ë°°ì¹˜ */
	.tab-list {
	    list-style: none; /* ì•ì— ì  ì œê±°*/
	    margin: 0;
	    padding: 0;
	    display: flex; /* ê°€ë¡œ ë‚˜ì—´*/
	}
	
	/* ì¤‘ì•™ í—¤ë” -> ì¹´í…Œê³ ë¦¬ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
	.tab-item a {
	    display: block;
	    padding: 8px 15px;
	    text-decoration: none; /* ì¹´í…Œê³ ë¦¬ ë°‘ì¤„ ì œê±°*/
	    color: #333; /* ê¸€ì ìƒ‰*/
	    background-color: transparent; /* ë°°ê²½ìƒ‰ íˆ¬ëª… (nav-tabsì˜ ë°°ê²½ìƒ‰ ì‚¬ìš©) */
	    border: none; /* ê²½ê³„ì„  ì œê±° */
	    font-size: 14px;
	    font-weight: normal;
	}
	
	/* 2. ì¤‘ì•™ í—¤ë” ê³µí†µ â­ */
	.nav-tabs {
		background-color: #D5DDED; /* ì´ë¯¸ì§€ì˜ ê· ì¼í•œ í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
		padding: 0 10px;
	}
	
	/* ì¤‘ì•™ í—¤ë” -> ì¹´í…Œê³ ë¦¬ í˜¸ë²„ */
	.tab-item:hover {
	    background-color: rgba(255, 255, 255, 0.3); /* ë§ˆì§€ë§‰ ìˆ«ìê°€ ì»¬ëŸ¬ ì„¸ê¸° ì •ë„*/
	}
	
	/* ì¤‘ì•™ í—¤ë” -> ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ìŠ¤íƒ€ì¼ */
	.tab-item.active a {
	    color: #333; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒì€ ê²€ì€ìƒ‰ ìœ ì§€ (ì‚¬ì§„ì²˜ëŸ¼) */
	    font-weight: 550;
	    /* í•˜ë‹¨ì— ì§„í•œ íŒŒë€ìƒ‰ ì„ ìœ¼ë¡œ ê°•ì¡° */
	}
	
	
	/* 3. í•˜ë‹¨ í—¤ë”  */
	.sub-menu {
	    background-color: #BACCFF; /* í°ìƒ‰ ë°°ê²½ */
	    padding: 5px 15px; /* íŒ¨ë”©ì„ ì¤„ì—¬ì„œ ë©”ë‰´ì™€ ë¶™ì€ ëŠë‚Œ */
	    font-size: 14px;
	    color: #555;
		font-weight: 530;
	    /* ì´ë¯¸ì§€ì²˜ëŸ¼ 'ê¸ˆì¼ ì§„ë£Œ ë¦¬ìŠ¤íŠ¸' í…ìŠ¤íŠ¸ë¥¼ ì§„í•˜ê²Œ í‘œí˜„ */
	}
	
	/* ì»¨í…ì¸  ì˜ì—­ (ì „ì²´ ë°°ê²½ìƒ‰ í™•ì¸ìš©) */
	.content-area {
	    min-height: 500px; /* ì„ì‹œ ë†’ì´ */
	    background-color: #D5DDED; /* ë‚˜ë¨¸ì§€ í™”ë©´ì„ ë®ëŠ” ë°°ê²½ìƒ‰ */
	}
	
	/* ê¸ˆì¼ ì§„ë£Œ ë¦¬ìŠ¤íŠ¸ */
	#table{ /* div ì˜ì—­ ë° ë ˆì´ì•„ì›ƒ */
		margin:5px;
		margin-left: auto;
		margin-right: auto;
	}
	
	table { 
	    width: 90%; /* ë„ˆë¹„ */
	    border-collapse: collapse; /* í‘œ í•œì¤„ë¡œ í•©ì¹˜ê¸° */
	    font-size: 14px;
	    background-color: white;
		
	 }

	 th, td {
	     border: 1px solid #7B7B7B; /* ì¹¸ ë‹¹ í…Œë‘ë¦¬*/
	     padding: 0;
		 height: 25px; /* ì›í•˜ëŠ” ì…€ ë†’ì´ */
	     text-align: center; /* í…ìŠ¤íŠ¸ ì¤‘ì•™ */
	 }

	 th {
	     background-color: #879BD5; 
		 font-weight: normal; /* ê¸€ì”¨ êµµê¸° ë³´í†µìœ¼ë¡œ */
		 color: rgb(31, 31, 31);
	 }

	 tr:nth-child(even) {
	     background-color: #ffffffff;
	 }

	 /* ì ‘ìˆ˜ ì‹œì‘ */
	 .first {
		 display: flex;             /* flexë¡œ ë³€í™˜ */
		 justify-content: center;   /* ê°€ë¡œ ì¤‘ì•™ */
		 align-items: center;       /* ì„¸ë¡œ ì¤‘ì•™ */
		 width: 100%;               /* ê°€ë¡œ ê½‰ */
		 height: 100%;              /* ì„¸ë¡œ ê½‰ */
		 box-sizing: border-box;    /* íŒ¨ë”© í¬í•¨ ê³„ì‚° */
		 border: none;
		 background-color: #00FF08;
		 color: black;
		 cursor: pointer;
		 font-size: 14px;
		 font-weight: 300; /* ê¸€ì”¨ êµµê¸° ë³´í†µìœ¼ë¡œ */
		 text-decoration: none;
	  }

	  .container {
	  	      display: grid;
	  	      grid-template-columns: 1fr 1fr; /* ì™¼ìª½, ì˜¤ë¥¸ìª½ */
	  	      gap: 5px;
	  	      height: calc(100vh - 130px); /* ìƒë‹¨+ì¤‘ì•™+í•˜ë‹¨ í—¤ë” ì œì™¸ */
	  	      padding: 5px;
	  	      box-sizing: border-box;
	  }
	  
	  .user_list{
	  		grid-column:1/2 ;
	  }
		
	  .schedule{
			grid-column:2/3 ;
	  }
	  
	  /* ë‚ ì§œ ìˆ«ì ìŠ¤íƒ€ì¼ 
	  .fc-daygrid-day-number {
	      font-size: 12px;
	      color: #5E77B4;
	      font-weight: 500;
	  }

	  // ë‚ ì§œ ë’¤ì— ë¶™ëŠ” 'ì¼' ì œê±° 
	  .fc-daygrid-day-number::after {
	      content: '';
	  }
	  
	  .work-select {
		pointer-events: auto;
	    position: relative;
	    z-index: 9999;       
	    margin-top: 18px;     
	    font-size: 11px;
	    width: 90%;
	  }

	  .fc-daygrid-day-events {
	    z-index: 1;
		pointer-events: none;
	  }

	  .fc-daygrid-day-frame {
	    overflow: visible !important; // ë“œë¡­ë‹¤ìš´ ì˜ë¦¼ ë°©ì§€ 
	  }*/
	  
	  #calendarTable td {
	      width: 80px;
	      height: 60px;
	      vertical-align: top;
	      text-align: left;
	      padding: 2px;
	  }
	  .work-select {
	      width: 100%;
	      font-size: 11px;
	      margin-top: 2px;
	  }
	</style>
	<!-- FullCalendar -->
	
</head>
<body>
    <header class="main-header">
		<!-- ìƒë‹¨ í—¤ë” -->
        <div class="top-bar">
            <div class="user-info">
                <span>(ì•„ì´ì½˜)</span>
                <span>MediCare |</span>
				<span>ì‚¬ìš©ìID:<span>
					<span id="user_id" th:text="${username}"></span>
	
            </div>
            <div class="user-info">
                <span>ì§„ë£Œê³¼ ã…‡ã…‡ã…‡</span>
				<button class="btn-logout">ë¡œê·¸ì•„ì›ƒ</button>
			</div>
            <div class="action-buttons">
                <button class="time-in">ì¶œê·¼</button>
                <button class="time-out">í‡´ê·¼</button>
            </div>
        </div>
		<!-- ìƒë‹¨ í—¤ë” ë-->
		
		<!-- ì¤‘ì•™ í—¤ë”-->
        <nav class="nav-tabs">
            <ul class="tab-list">
                <li class="tab-item"><a href="">ì§ì› ìŠ¤ì¼€ì¤„ ì¡°íšŒ</a></li>
                <li class="tab-item"><a href="">íœ´ê°€ ì‹ ì²­ ë¦¬ìŠ¤íŠ¸</a></li>
                <li class="tab-item active"><a href="#">ìŠ¤ì¼€ì¤„ ë¶€ì—¬</a></li>
                <li class="tab-item"><a href="#">ê·¼íƒœ í˜„í™©</a></li>
            </ul>
        </nav>
		<!-- ì¤‘ì•™ í—¤ë” ë-->
		
		<!-- í•˜ë‹¨ í—¤ë”-->
        <div class="sub-menu">
            <span>íœ´ê°€ ì‹ ì²­ ë¦¬ìŠ¤íŠ¸</span>
        </div>
		<!-- í•˜ë‹¨ í—¤ë” ë-->
    </header>

	<!-- ì½˜í…ì¸  ì˜ì—­ ì‹œì‘-->
    <div class="content-area">
		<div class="container">
		<!-- ìƒíƒœ í•„í„°ë§ -->
			<div class="user_list">
				<div> <!-- ê²€ìƒ‰ì°½ -->
					<form method="get" action="/hr/schedule">
					  <label>
					    ë…„ë„<input type="number" name="year" th:value="${year}" min="2000" max="2099">
					  </label>

					  <label>
					    ì›”<input type="number" name="month" th:value="${month}" min="1" max="12">
					  </label>

					  <button type="submit">ì¡°íšŒ</button>
					</form>
				</div>
				
				<div> <!-- ë¦¬ìŠ¤íŠ¸ -->
				<table id="table" border="1">
					<thead>
					    <tr>
					        <th>ì§„ë£Œê³¼</th>
					        <th>ì§ì›ID</th>
					        <th>ì§ì›ëª…</th>
					        <th>ìƒíƒœ</th>
					        <th>ì„ íƒ</th>
					    </tr>
					</thead>
		
					<tbody>
						<tr th:if="${userWithFlag.size() == 0}">
						        <td colspan="10" class="no-data" style="height: 500px;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
						    </tr>
		
						    <tr th:each="u : ${userWithFlag}">
								<td th:text="${u.user.staff_profile[0].department.name}"></td>
								<td th:text="${u.user.user_id}"></td>
								<td th:text="${u.user.name}"></td>
								<!-- ìƒíƒœ: 1ì¼ ìŠ¤ì¼€ì¤„ ìˆìœ¼ë©´ 'ë¶€ì—¬' -->
								<td th:text="${u.hasScheduleOnFirst ? 'ë¶€ì—¬' : 'ë¯¸ë¶€ì—¬'}"></td>
								<td><button class="selectUserBtn"
								    th:attr="data-user-id=${u.user.user_id}, data-department-code=${u.user.staff_profile[0].department.department_code}">
								    ì„ íƒ
								</button>
								</td>
						    </tr>
							
							<!-- ë¹ˆ í–‰ì„ ì±„ì›Œ ìµœì†Œ 10í–‰ìœ¼ë¡œ ìœ ì§€ -->
							    <tr th:if="${userWithFlag.size() >0 }" 
							        th:each="i : ${#numbers.sequence(userWithFlag.size() + 1, 20)}">
							        <td>&nbsp;</td>
							        <td>&nbsp;</td>
							        <td>&nbsp;</td>
							        <td>&nbsp;</td>
							        <td>&nbsp;</td>
							</tr>
					</tbody>
				</table>
				</div> 
			</div>
		
		<!-- ë‹¬ë ¥ -->
		<div class="schedule">
		    <div id="empty">ì„ íƒí•œ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>
		    <table id="calendarTable" border="1" style="display:none; border-collapse: collapse;">
		        <thead>
		            <tr>
		                <th>ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th>
		            </tr>
		        </thead>
		        <tbody></tbody>
		    </table>
		    <button id="saveBtn" style="display:none;" disabled>ì €ì¥</button>
		</div>
	<!-- ì½˜í…ì¸  ì˜ì—­ ë-->
	<script th:inline="javascript">
    const year = [[${year}]];   // ì˜ˆ: 2025
    const month = [[${month}]]; // ì˜ˆ: 12

    let selectedUserId = null;
    let selectedDepartmentCode = null;
    let workTypes = [];
    let existingSchedules = []; // âœ… ê¸°ì¡´ ìŠ¤ì¼€ì¤„ ì €ì¥ìš©

    /* ì§ì› ì„ íƒ ë²„íŠ¼ í´ë¦­ */
    document.querySelectorAll('.selectUserBtn').forEach(btn => {
        btn.addEventListener('click', async () => {
            selectedUserId = btn.dataset.userId;
            selectedDepartmentCode = btn.dataset.departmentCode;

            console.log("ì„ íƒí•œ ì§ì› userId =", selectedUserId);
            console.log("ì„ íƒí•œ ë¶€ì„œ departmentCode =", selectedDepartmentCode);

            // í…Œì´ë¸” ë¨¼ì € í‘œì‹œ
            document.getElementById('calendarTable').style.display = 'table';
            document.getElementById('empty').style.display = 'none';

			// ì €ì¥ ë²„íŠ¼ í‘œì‹œ
			document.getElementById('saveBtn').style.display = 'inline-block';
			
            // ê·¼ë¬´ ìœ í˜• ë¡œë”©
            await loadWorkTypes();
            // ê¸°ì¡´ ìŠ¤ì¼€ì¤„ ë¡œë”©
            await loadExistingSchedules();
            // ë‹¬ë ¥ ë Œë”
            renderCalendar(year, month);
        });
    });

    /* ê·¼ë¬´ ìœ í˜• ì¡°íšŒ */
    async function loadWorkTypes() {
        try {
            const res = await fetch(`/work-types?user_id=${selectedUserId}`);
            workTypes = await res.json();
            console.log("ë°›ì€ workTypes:", workTypes);
        } catch (err) {
            console.error("ê·¼ë¬´ ìœ í˜• ì¡°íšŒ ì‹¤íŒ¨", err);
            workTypes = [];
        }
    }

    /* ê¸°ì¡´ ìŠ¤ì¼€ì¤„ ì¡°íšŒ */
    async function loadExistingSchedules() {
        try {
            const res = await fetch(`/work-schedule/${selectedUserId}/${year}/${month}`);
            existingSchedules = await res.json();
            console.log("ë°›ì€ ê¸°ì¡´ ìŠ¤ì¼€ì¤„:", existingSchedules);
        } catch (err) {
            console.error("ê¸°ì¡´ ìŠ¤ì¼€ì¤„ ì¡°íšŒ ì‹¤íŒ¨", err);
            existingSchedules = [];
        }
    }

    /* ë‹¬ë ¥ ìƒì„± */
    function renderCalendar(year, month) {
        const tbody = document.querySelector('#calendarTable tbody');
        tbody.innerHTML = '';

        const firstDay = new Date(year, month-1, 1);
        const lastDay = new Date(year, month, 0);
        const startDay = firstDay.getDay();
        const totalDays = lastDay.getDate();

        let row = document.createElement('tr');
        for (let i=0;i<startDay;i++){
            const td = document.createElement('td');
            row.appendChild(td);
        }

        for (let day=1; day<=totalDays; day++) {
            const td = document.createElement('td');
            td.innerHTML = `<div>${day}</div>`;
            const select = document.createElement('select');
            select.className = 'work-select';
            const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            select.dataset.date = dateStr;
            select.innerHTML = `<option value="">ê·¼ë¬´ ì„ íƒ</option>`;

            workTypes.forEach(wt => {
                const opt = document.createElement('option');
                opt.value = wt.workTypeCode;
                opt.textContent = wt.workName;

                // âœ… ê¸°ì¡´ ìŠ¤ì¼€ì¤„ì´ë©´ selected
                const existing = existingSchedules.find(s => s.workDate === dateStr);
                if (existing && existing.workTypeCode === wt.workTypeCode) {
                    opt.selected = true;
                }

                select.appendChild(opt);
            });
			
			checkAllSelected();

            select.addEventListener('change', checkAllSelected);
            td.appendChild(select);
            row.appendChild(td);

            if ((day + startDay) % 7 === 0 || day === totalDays) {
                if(day === totalDays){
                    const remaining = 7 - ((day + startDay) % 7);
                    for(let i=0;i<remaining;i++){
                        const emptyTd = document.createElement('td');
                        row.appendChild(emptyTd);
                    }
                }
                tbody.appendChild(row);
                row = document.createElement('tr');
            }
        }
    }

    /* ëª¨ë“  ë‚ ì§œ ì„ íƒ ì—¬ë¶€ ì²´í¬ */
	function checkAllSelected() {
	    const selects = document.querySelectorAll('.work-select');
	    const saveBtn = document.getElementById('saveBtn');

	    // ê¸°ì¡´ ìŠ¤ì¼€ì¤„ ì¡´ì¬ ì—¬ë¶€ (í•œ ë‹¬ì´ë¼ë„ ìˆìœ¼ë©´ ìˆ˜ì •)
	    const isEditMode = existingSchedules.length > 0;

	    if (isEditMode) {
	        // âœ… ìˆ˜ì • ëª¨ë“œ
	        saveBtn.textContent = 'ìˆ˜ì •';
	        saveBtn.disabled = false;
	        return;
	    }

	    // âœ… ì €ì¥ ëª¨ë“œ
	    const allSelected = Array.from(selects).every(s => s.value !== '');
	    saveBtn.textContent = 'ì €ì¥';
	    saveBtn.disabled = !allSelected;
	}


    /* ì €ì¥ ë²„íŠ¼ í´ë¦­ */
    document.getElementById('saveBtn').addEventListener('click', () => {
        const data = [];
        document.querySelectorAll('.work-select').forEach(select => {
            data.push({
                workDate: select.dataset.date,
                workTypeCode: select.value
            });
        });

        fetch('/work-schedule/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: selectedUserId,
                department_code: selectedDepartmentCode,
                schedules: data
            })
        })			
		.then(async () => {
			alert('ìŠ¤ì¼€ì¤„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');

			    // ğŸ”¥ ì„œë²„ì—ì„œ ë‹¤ì‹œ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
			    await loadExistingSchedules();

			    // ğŸ”¥ ìº˜ë¦°ë” ë‹¤ì‹œ ê·¸ë¦¼ (ë¶€ì—¬ ìƒíƒœ ë°˜ì˜)
			    renderCalendar(year, month);

			    // ğŸ”¥ ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 
			    checkAllSelected();
		});
});
</script>



</body>
</html>
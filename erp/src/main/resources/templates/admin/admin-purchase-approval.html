<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>구매 승인</title>
    <style>
        body { margin:0; padding:0; font-family:"Inter","맑은 고딕",sans-serif; background:#9aa0a6; }
        .admin-frame { max-width:1920px; border:2px solid #2b7cff; background:#d7ddeb; }
        .content { padding:14px; }
        .tab-row { display:flex; gap:8px; margin-bottom:8px; }
        .tab { padding:4px 10px; border:1px solid #c9cfde; border-radius:6px; background:#f4f6fb; font-size:12px; cursor:pointer; }
        .panel { border:1px solid #b0b7c7; border-radius:4px; background:#fff; overflow:hidden; }
        .panel-title { background:#6b80bf; color:#fff; font-size:12px; padding:6px 8px; font-weight:600; }
        .panel-body { padding:8px; font-size:12px; }
        table { width:100%; border-collapse:collapse; font-size:12px; }
        th, td { border:1px solid #c9cfde; padding:4px 6px; text-align:center; }
        th { background:#e9edf7; }
        .btn { border:1px solid #7b7b7b; border-radius:6px; padding:4px 10px; font-size:12px; background:#d5dded; cursor:pointer; }
        .selectable-row { cursor: pointer; }
        .selected-row { background: #eef2ff; }
    </style>
    <link rel="stylesheet" th:href="@{/css/common-base.css}">
</head>
<body>
<div class="admin-frame">
    <div th:replace="~{fragments/admin-header :: header(title='구매 승인', activeTab='ad-030')}"></div>

    <div class="content">
        <div class="tab-row">
            <div class="tab">대기</div>
            <div class="tab">승인</div>
            <div class="tab">반려</div>
            <div class="tab">완료</div>
        </div>

        <div class="panel">
            <div class="panel-title">구매 승인 리스트</div>
            <div class="panel-body">
                <table>
                    <thead>
                    <tr>
                        <th>요청번호</th>
                        <th>요청부서</th>
                        <th>품목코드</th>
                        <th>수량</th>
                        <th>상태</th>
                        <th>요청일</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="row : ${rows}" class="selectable-row" th:attr="data-request-id=${row.requestId}">
                        <td th:text="${row.requestId}">-</td>
                        <td th:text="${row.requestDept}">-</td>
                        <td th:text="${row.itemCode}">-</td>
                        <td th:text="${row.quantity}">-</td>
                        <td th:text="${row.status}">-</td>
                        <td th:text="${row.requestedAt}">-</td>
                    </tr>
                    <tr th:if="${rows == null or #lists.isEmpty(rows)}">
                        <td colspan="6">검색 결과 없음</td>
                    </tr>
                    </tbody>
                </table>
                <div style="margin-top:8px;">
                    <button class="btn" type="button" th:if="${isAdmin}" id="approveBtn">승인</button>
                    <button class="btn" type="button" th:if="${isAdmin}" id="rejectBtn">반려</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    (function () {
        const rows = Array.from(document.querySelectorAll("tr[data-request-id]"));
        let selectedId = null;
        rows.forEach((row) => {
            row.addEventListener("click", () => {
                rows.forEach((r) => r.classList.remove("selected-row"));
                row.classList.add("selected-row");
                selectedId = row.dataset.requestId || null;
            });
        });

        const approveBtn = document.getElementById("approveBtn");
        const rejectBtn = document.getElementById("rejectBtn");
        const postAction = async (url) => {
            const res = await fetch(url, { method: "POST" });
            if (!res.ok) {
                alert("Action failed.");
                return;
            }
            location.reload();
        };

        if (approveBtn) {
            approveBtn.addEventListener("click", () => {
                if (!selectedId) {
                    alert("Select a row first.");
                    return;
                }
                postAction(`/admin/actions/purchase-approval/${encodeURIComponent(selectedId)}/approve`);
            });
        }
        if (rejectBtn) {
            rejectBtn.addEventListener("click", () => {
                if (!selectedId) {
                    alert("Select a row first.");
                    return;
                }
                postAction(`/admin/actions/purchase-approval/${encodeURIComponent(selectedId)}/reject`);
            });
        }
    })();
</script>
</body>
</html>

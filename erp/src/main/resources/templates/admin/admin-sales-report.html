<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>매출 리포트</title>
    <style>
        body { margin:0; padding:0; font-family:"Inter","맑은 고딕",sans-serif; background:#9aa0a6; }
        .admin-frame { max-width:1920px; border:2px solid #2b7cff; background:#d7ddeb; }
        .content { padding:14px; }
        .filter-row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; background:#f4f6fb; padding:8px; border-radius:6px; border:1px solid #cbd2e1; }
        .filter-row select, .filter-row input { padding:4px 6px; border:1px solid #cbd2e1; border-radius:4px; font-size:12px; background:#fff; }
        .filter-row .date { width:120px; }
        .btn { border:1px solid #7b7b7b; border-radius:6px; padding:4px 10px; font-size:12px; background:#d5dded; cursor:pointer; }
        .btn-blue { background:#879bd5; color:#fff; }

        .kpi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin:12px 0; }
        .kpi { border:1px solid #b0b7c7; background:#fff; border-radius:4px; padding:10px; font-size:12px; }
        .kpi strong { display:block; font-size:12px; color:#5b6b99; margin-bottom:6px; }

        .report-grid { display:grid; grid-template-columns:1.4fr 1fr; gap:12px; }
        .panel { border:1px solid #b0b7c7; border-radius:4px; background:#fff; overflow:hidden; }
        .panel-title { background:#6b80bf; color:#fff; font-size:12px; padding:6px 8px; font-weight:600; }
        .panel-body { padding:8px; font-size:12px; }

        table { width:100%; border-collapse:collapse; font-size:12px; }
        th, td { border:1px solid #c9cfde; padding:4px 6px; text-align:center; }
        th { background:#e9edf7; }

        .chart-box { border:1px dashed #c9cfde; background:linear-gradient(180deg,#f8f9fd 0%,#eef1fb 100%); height:180px; display:flex; align-items:center; justify-content:center; color:#7a86a8; }
        .chart-daily { align-items:flex-end; justify-content:flex-start; gap:8px; padding:10px; position:relative; --accent-color:#5f7fd6; --line-covered:#4f78c2; --line-noncovered:#e38a42; }
        .chart-daily::after { content:""; position:absolute; inset:10px; background-image:linear-gradient(transparent 95%, rgba(120,130,170,0.15) 96%); background-size:100% 25%; pointer-events:none; }
        .chart-daily .bar-wrap { display:flex; flex-direction:column; align-items:center; flex:1; min-width:24px; }
        .chart-daily .bar { width:100%; background:linear-gradient(180deg,var(--accent-color) 0%,#3f4f92 100%); border-radius:6px 6px 0 0; position:relative; box-shadow:0 2px 6px rgba(38,46,86,0.25); z-index:1; }
        .chart-daily .bar-label { margin-top:4px; font-size:10px; color:#4b5678; }
        .chart-daily .bar-value { position:absolute; top:-16px; font-size:10px; color:#4b5678; white-space:nowrap; }
        .chart-empty { font-size:12px; color:#7a86a8; }
        .chart-line { position:absolute; inset:10px; width:calc(100% - 20px); height:calc(100% - 20px); pointer-events:none; z-index:2; }
        .chart-line polyline { fill:none; stroke-linejoin:round; stroke-linecap:round; opacity:0.9; }
        .chart-line .line-covered { stroke:var(--line-covered); stroke-width:1; }
        .chart-line .line-noncovered { stroke:var(--line-noncovered); stroke-width:1; }
        .chart-line .dot-covered { fill:#ffffff; stroke:var(--line-covered); stroke-width:1; }
        .chart-line .dot-noncovered { fill:#ffffff; stroke:var(--line-noncovered); stroke-width:1; }
        .chart-legend { display:flex; gap:12px; font-size:11px; color:#4b5678; margin-bottom:6px; }
        .legend-item { display:flex; align-items:center; gap:6px; }
        .legend-swatch { width:10px; height:10px; border-radius:50%; background:var(--line-covered); border:1px solid rgba(0,0,0,0.15); }
        .legend-noncovered .legend-swatch { background:var(--line-noncovered); }
        .dept-legend { flex-wrap:wrap; }
        .chart-multi { height:200px; }
        .chart-multi .series-data { display:none; }
        .rank-chart { margin:8px 0 12px; display:flex; flex-direction:column; gap:6px; }
        .rank-item { display:grid; grid-template-columns:90px 1fr 70px; gap:6px; align-items:center; font-size:11px; color:#4b5678; }
        .rank-bar { height:8px; border-radius:4px; background:linear-gradient(90deg,#5f7fd6 0%,#58b3c4 100%); }
        .chart-daily .bar-wrap:nth-child(5n+1) .bar { background:linear-gradient(180deg,#5f7fd6 0%,#4660b6 100%); }
        .chart-daily .bar-wrap:nth-child(5n+2) .bar { background:linear-gradient(180deg,#58b3c4 0%,#3b8fa5 100%); }
        .chart-daily .bar-wrap:nth-child(5n+3) .bar { background:linear-gradient(180deg,#7bc47f 0%,#4d9a62 100%); }
        .chart-daily .bar-wrap:nth-child(5n+4) .bar { background:linear-gradient(180deg,#f0b766 0%,#d48a34 100%); }
        .chart-daily .bar-wrap:nth-child(5n+5) .bar { background:linear-gradient(180deg,#d77aa8 0%,#b65787 100%); }
    </style>
    <link rel="stylesheet" th:href="@{/css/common-base.css}">
</head>
<body>
<div class="admin-frame">
    <div th:replace="~{fragments/admin-header :: header(title='매출 리포트', activeTab='ad-020')}"></div>

    <div class="content">
        <form class="filter-row" method="get">
            <input class="date" type="date" name="startDate" th:value="${selectedStartDate}">
            <span>-</span>
            <input class="date" type="date" name="endDate" th:value="${selectedEndDate}">
            <select name="departmentCode">
                <option value="" th:selected="${selectedDepartmentCode == null or selectedDepartmentCode == ''}">진료과</option>
                <option th:each="d : ${departmentOptions}"
                        th:value="${d.code}"
                        th:text="${d.name}"
                        th:selected="${selectedDepartmentCode != null and selectedDepartmentCode == d.code}">
                </option>
            </select>
            <select name="doctorId">
                <option value="" th:selected="${selectedDoctorId == null or selectedDoctorId == ''}">의사</option>
                <option th:each="doc : ${doctorOptions}"
                        th:value="${doc.userId}"
                        th:text="${doc.departmentName != '' ? doc.name + ' (' + doc.departmentName + ')' : doc.name}"
                        th:selected="${selectedDoctorId != null and selectedDoctorId == doc.userId}">
                </option>
            </select>
            <select name="insuranceCode">
                <option value="" th:selected="${selectedInsuranceCode == null or selectedInsuranceCode == ''}">보험구분</option>
                <option th:each="ic : ${insuranceOptions}"
                        th:value="${ic.code}"
                        th:text="${ic.name}"
                        th:selected="${selectedInsuranceCode != null and selectedInsuranceCode == ic.code}">
                </option>
            </select>
            <select name="paymentMethod">
                <option value="" th:selected="${selectedPaymentMethod == null or selectedPaymentMethod == ''}">결제수단</option>
                <option th:each="pm : ${paymentMethodOptions}"
                        th:value="${pm.code}"
                        th:text="${pm.name}"
                        th:selected="${selectedPaymentMethod != null and selectedPaymentMethod == pm.code}">
                </option>
            </select>
            <select name="visitType">
                <option value="" th:selected="${selectedVisitType == null or selectedVisitType == ''}">외래/입원</option>
                <option value="OUT" th:selected="${selectedVisitType == 'OUT'}">외래</option>
                <option value="IN" th:selected="${selectedVisitType == 'IN'}">입원</option>
            </select>
            <button class="btn btn-blue" type="submit">검색</button>
        </form>

        <div class="kpi-grid">
            <div class="kpi">
                <strong>총매출</strong>
                <span th:text="${#numbers.formatInteger(summary.totalAmount, 0, 'COMMA')}">0</span>
            </div>
            <div class="kpi">
                <strong>급여/비급여</strong>
                <span>
                    급여 <span th:text="${#numbers.formatInteger(summary.coveredAmount, 0, 'COMMA')}">0</span>
                    / 비급여 <span th:text="${#numbers.formatInteger(summary.noncoveredAmount, 0, 'COMMA')}">0</span>
                </span>
            </div>
            <div class="kpi">
                <strong>환불액</strong>
                <span th:text="${#numbers.formatInteger(summary.refundAmount, 0, 'COMMA')}">0</span>
            </div>
            <div class="kpi">
                <strong>순매출</strong>
                <span th:text="${#numbers.formatInteger(summary.netAmount, 0, 'COMMA')}">0</span>
            </div>
        </div>

        <div class="report-grid">
            <div class="panel">
                <div class="panel-title">일자별 매출 추이</div>
                <div class="panel-body">
                    <div class="chart-legend">
                        <span class="legend-item legend-covered"><span class="legend-swatch"></span>&#44553;&#50668;</span>
                        <span class="legend-item legend-noncovered"><span class="legend-swatch"></span>&#48708;&#44553;&#50668;</span>
                    </div>
                    <div class="chart-box chart-daily"
                         th:if="${dailyRows != null and !#lists.isEmpty(dailyRows)}"
                         th:with="maxTotal=${dailyMaxTotal}"
                         th:attr="data-dept=${selectedDepartmentCode}, data-payment=${selectedPaymentMethod}">
                        <svg class="chart-line" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true"></svg>
                        <div class="bar-wrap" th:each="row : ${dailyRows}"
                             th:attr="data-value=${row.totalAmount}, data-covered=${row.coveredAmount}, data-noncovered=${row.noncoveredAmount}">
                            <div class="bar"
                                 th:style="${'height:' + (maxTotal == 0 ? 0 : (row.totalAmount * 100 / maxTotal)) + '%'}">
                                <span class="bar-value" th:text="${#numbers.formatInteger(row.totalAmount, 0, 'COMMA')}"></span>
                            </div>
                            <span class="bar-label" th:text="${row.day}">-</span>
                        </div>
                    </div>
                    <div class="chart-box chart-empty" th:if="${dailyRows == null or #lists.isEmpty(dailyRows)}">차트 데이터 없음</div>
                    <table style="margin-top:8px;">
                        <thead>
                        <tr>
                            <th>일자</th>
                            <th>매출</th>
                            <th>급여</th>
                            <th>비급여</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="row : ${dailyRows}">
                            <td th:text="${row.day}">-</td>
                            <td th:text="${#numbers.formatInteger(row.totalAmount, 0, 'COMMA')}">-</td>
                            <td th:text="${#numbers.formatInteger(row.coveredAmount, 0, 'COMMA')}">-</td>
                            <td th:text="${#numbers.formatInteger(row.noncoveredAmount, 0, 'COMMA')}">-</td>
                        </tr>
                        <tr th:if="${dailyRows == null or #lists.isEmpty(dailyRows)}">
                            <td colspan="4">검색 결과 없음</td>
                        </tr>
                        </tbody>
                    </table>
                    <div class="chart-legend dept-legend"
                         th:if="${(selectedDepartmentCode == null or selectedDepartmentCode == '') and deptDailySeries != null and !#lists.isEmpty(deptDailySeries)}">
                        <span class="legend-item" th:each="series, stat : ${deptDailySeries}">
                            <span class="legend-swatch"></span>
                            <span th:text="${series.departmentName}">-</span>
                        </span>
                    </div>
                    <div class="chart-box chart-daily chart-multi"
                         th:if="${(selectedDepartmentCode == null or selectedDepartmentCode == '') and deptDailySeries != null and !#lists.isEmpty(deptDailySeries)}"
                         th:attr="data-labels=${#strings.listJoin(dailyLabels, ',')}">
                        <svg class="chart-line" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true"></svg>
                        <div class="series-data" th:each="series : ${deptDailySeries}"
                             th:attr="data-name=${series.departmentName}, data-values=${#strings.listJoin(series.totals, ',')}"></div>
                    </div>
                    <div class="chart-box chart-empty"
                         th:if="${(selectedDepartmentCode == null or selectedDepartmentCode == '') and (deptDailySeries == null or #lists.isEmpty(deptDailySeries))}">彀姼 ?办澊???嗢潓</div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">결제수단/랭킹</div>
                <div class="panel-body">
                    <strong>&#51652;&#47308;&#44284; &#47588;&#52636; TOP</strong>
                    <div class="rank-chart"
                         th:if="${deptRankRows != null and !#lists.isEmpty(deptRankRows)}"
                         th:with="maxDept=${deptRankMax}">
                        <div class="rank-item" th:each="row : ${deptRankRows}">
                            <span th:text="${row.name}">-</span>
                            <div class="rank-bar"
                                 th:style="${'width:' + (maxDept == 0 ? 0 : (row.amount * 100 / maxDept)) + '%'}"></div>
                            <span th:text="${#numbers.formatInteger(row.amount, 0, 'COMMA')}">-</span>
                        </div>
                    </div>
                    <strong>결제수단별 집계</strong>
                    <table style="margin-top:6px;">
                        <thead>
                        <tr>
                            <th>결제수단</th>
                            <th>금액</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="row : ${paymentRows}">
                            <td th:text="${row.paymentMethodName}">-</td>
                            <td th:text="${#numbers.formatInteger(row.amount, 0, 'COMMA')}">-</td>
                        </tr>
                        <tr th:if="${paymentRows == null or #lists.isEmpty(paymentRows)}">
                            <td colspan="2">검색 결과 없음</td>
                        </tr>
                        </tbody>
                    </table>

                    <strong style="display:block; margin-top:10px;">상위 진료과/의사</strong>
                    <table style="margin-top:6px;">
                        <thead>
                        <tr>
                            <th>구분</th>
                            <th>명칭</th>
                            <th>매출</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="row : ${rankRows}">
                            <td th:text="${row.type}">-</td>
                            <td th:text="${row.name}">-</td>
                            <td th:text="${#numbers.formatInteger(row.amount, 0, 'COMMA')}">-</td>
                        </tr>
                        <tr th:if="${rankRows == null or #lists.isEmpty(rankRows)}">
                            <td colspan="3">검색 결과 없음</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    (function () {
        const chart = document.querySelector(".chart-daily");
        if (!chart) return;
        const dept = chart.getAttribute("data-dept") || "";
        const payment = chart.getAttribute("data-payment") || "";
        const key = dept || payment;
        if (key) {
            let hash = 0;
            for (let i = 0; i < key.length; i++) {
                hash = (hash * 31 + key.charCodeAt(i)) % 360;
            }
            chart.style.setProperty("--accent-color", "hsl(" + hash + " 65% 55%)");
            chart.style.setProperty("--line-covered", "hsl(" + hash + " 60% 45%)");
            chart.style.setProperty("--line-noncovered", "hsl(" + ((hash + 40) % 360) + " 70% 50%)");
        }

        const wraps = Array.from(chart.querySelectorAll(".bar-wrap"));
        const svg = chart.querySelector(".chart-line");
        if (!svg || wraps.length < 2) return;
        const coveredValues = wraps.map(w => Number(w.dataset.covered || 0));
        const noncoveredValues = wraps.map(w => Number(w.dataset.noncovered || 0));
        const max = Math.max(...coveredValues, ...noncoveredValues, 0);
        if (max <= 0) return;
        const makePoints = values => values.map((v, idx) => {
            const x = (idx / (values.length - 1)) * 100;
            const y = 100 - (v / max) * 100;
            return { x, y };
        });
        const drawLine = (points, lineClass, dotClass) => {
            const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            polyline.setAttribute("points", points.map(p => p.x + "," + p.y).join(" "));
            polyline.setAttribute("class", lineClass);
            svg.appendChild(polyline);
            points.forEach(p => {
                const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                dot.setAttribute("cx", p.x);
                dot.setAttribute("cy", p.y);
                dot.setAttribute("r", 1.4);
                dot.setAttribute("class", dotClass);
                svg.appendChild(dot);
            });
        };
        drawLine(makePoints(coveredValues), "line-covered", "dot-covered");
        drawLine(makePoints(noncoveredValues), "line-noncovered", "dot-noncovered");

        const multi = document.querySelector(".chart-multi");
        if (multi) {
            const labels = (multi.getAttribute("data-labels") || "").split(",").filter(Boolean);
            const seriesEls = Array.from(multi.querySelectorAll(".series-data"));
            const legendItems = Array.from(document.querySelectorAll(".dept-legend .legend-item"));
            const svgMulti = multi.querySelector(".chart-line");
            const series = seriesEls.map((el, idx) => {
                const values = (el.getAttribute("data-values") || "")
                    .split(",")
                    .map(v => Number(v || 0));
                const hue = (idx * 57) % 360;
                return { name: el.getAttribute("data-name") || "", values, color: "hsl(" + hue + " 65% 50%)" };
            });
            if (svgMulti && series.length > 0 && labels.length > 1) {
                const max = Math.max(...series.flatMap(s => s.values), 0);
                if (max > 0) {
                    series.forEach((s, idx) => {
                        const points = s.values.map((v, i) => {
                            const x = (i / (labels.length - 1)) * 100;
                            const y = 100 - (v / max) * 100;
                            return { x, y };
                        });
                        const line = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                        line.setAttribute("points", points.map(p => p.x + "," + p.y).join(" "));
                        line.setAttribute("style", "stroke:" + s.color + ";stroke-width:1;fill:none;opacity:0.85;");
                        svgMulti.appendChild(line);
                        points.forEach(p => {
                            const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                            dot.setAttribute("cx", p.x);
                            dot.setAttribute("cy", p.y);
                            dot.setAttribute("r", 1.2);
                            dot.setAttribute("style", "stroke:" + s.color + ";stroke-width:1;fill:#fff;");
                            svgMulti.appendChild(dot);
                        });
                        if (legendItems[idx]) {
                            const swatch = legendItems[idx].querySelector(".legend-swatch");
                            if (swatch) {
                                swatch.style.background = s.color;
                            }
                        }
                    });
                }
            }
        }
    })();
</script>
</body>
</html>

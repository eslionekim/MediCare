<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ë³µì•½ì§€ë„</title>

<style>
body{
    font-family: 'Inter','ë§‘ì€ ê³ ë”•';
    background:#EEF3FF;
}

.container{
    width:95%;
    margin:10px auto;
}

.box{
    background:white;
    border-radius:8px;
    padding:12px 15px;
    box-shadow:0 2px 6px rgba(0,0,0,0.08);
    margin-bottom:10px;
}

.flex{
    display:flex;
    gap:10px;
}

.left{
    flex:3;
}
.right{
    flex:1.2;
}

.title{
    font-weight:600;
    margin-bottom:6px;
}

table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
}

th,td{
    border:1px solid #bbb;
    padding:6px;
    text-align:center;
}

th{
    background:#CFE0FF;
}

.patient-header hr{
    border:0;
    border-top:1px solid #999;
    margin:8px 0;
}
</style>
<!--pdf-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

</head>

<body>
<div class="container">

    <div class="flex">

        <!-- ì¢Œì¸¡ ì „ì²´ -->
        <div class="left">

            <!-- ì¢Œì¸¡ ìƒë‹¨ í™˜ì ì •ë³´ -->
            <div class="box patient-header">
				<input type="hidden" id="prescriptionId" th:value="${prescriptionId}">

                <div>
                    <span th:text="${guide.patientName}"></span> ë‹˜
                </div>

                <div>
                    <span th:text="${guide.birth}"></span> /
                    <span th:text="${guide.gender}"></span>
                </div>

                <hr/>

                <div>
                    ì¡°ì œì¼
                    <span th:text="${guide.dispensedAt}"></span>
                </div>

                <div>
                    ì¡°ì œì•½ì‚¬
                    <span th:text="${guide.pharmacistName}"></span>
                </div>

                <div>
                    ID
                    <span th:text="${guide.prescriptionId}"></span>
                </div>

                <div>
                    ë°œí–‰ê¸°ê´€ ã…‡ã…‡ë³‘ì›
                </div>
            </div>

            <!-- ì¢Œì¸¡ ì¤‘ì•™ ì•½í’ˆ ë¦¬ìŠ¤íŠ¸ -->
            <div class="box">

                <div class="title">ì²˜ë°© ì•½í’ˆ ëª©ë¡</div>

                <table>
                    <thead>
                        <tr>
                            <th>ì´ë¯¸ì§€</th>
                            <th>ì•½í’ˆëª… / ì„¤ëª…</th>
                            <th>ë³µì•½ì•ˆë‚´</th>
                            <th>íˆ¬ì•½ëŸ‰</th>
                            <th>íšŸìˆ˜</th>
                            <th>ì¼ìˆ˜</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr th:each="i : ${guide.items}">
                            <td>ğŸ’Š</td>

                            <td>
                                <div th:text="${i.name}"></div>
                                <small th:text="${i.description}"></small>
                            </td>

                            <td th:text="${i.guidance}"></td>

                            <td th:text="${i.dose}"></td>
                            <td th:text="${i.frequency}"></td>
                            <td th:text="${i.days}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>

        <!-- ìš°ì¸¡ ìƒë‹¨ ê¸ˆì•¡ ìš”ì•½ -->
        <div class="right">

            <div class="box">
                <div class="title">ê¸ˆì•¡ ìš”ì•½</div>

                <div>ì´ì•¡
                    <b th:text="${#numbers.formatDecimal(guide.totalAmount, 0, 0)}"></b> ì›
                </div>

                <div>ê³¼ì„¸ ì´ì•¡
                    <b th:text="${#numbers.formatDecimal(guide.taxAmount, 0, 0)}"></b> ì›
                </div>

                <div>ë¹„ê³¼ì„¸ ì´ì•¡
                    <b th:text="${#numbers.formatDecimal(guide.nonTaxAmount, 0, 0)}"></b> ì›
                </div>
				
				<div>ë³´í—˜ëª…
                    <b th:text="${guide.insuranceName}"></b>
                </div>
				
				<div>ë³´í—˜ìœ¨
                    <b th:text="${#numbers.formatDecimal(guide.discountRate * 100, 0, 0)}"></b>%
                </div>
				
                <div>ë³´í—˜ë¶€ë‹´ê¸ˆ
                    <b th:text="${#numbers.formatDecimal(guide.insurerAmount, 0, 0)}"></b> ì›
                </div>

                <div>ë³¸ì¸ ë¶€ë‹´ê¸ˆ
                    <b th:text="${#numbers.formatDecimal(guide.patientAmount, 0, 0)}"></b> ì›
                </div>
            </div>

        </div>
    </div>
	<div style="margin-top: 15px; text-align: center;">
	    <button onclick="completeDispense()">íˆ¬ì•½ ì™„ë£Œ</button>
	    <button onclick="downloadPdf()">ë³µì•½ì§€ë„ ì¶œë ¥(PDF)</button>
	</div>
</div>
<script>
	// íˆ¬ì•½
	function completeDispense() {
	
	    const prescriptionId = document.getElementById("prescriptionId").value;
	
	    if (!prescriptionId) {
	        alert("ì²˜ë°© IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	        return;
	    }
	
	    fetch(`/pharm/dispense/complete/${prescriptionId}`, {
	        method: "POST"
	    })
	    .then(res => {
	        if (!res.ok) throw new Error("íˆ¬ì•½ ì²˜ë¦¬ ì‹¤íŒ¨");
	        return res.text();
	    })
	    .then(() => {
	        alert("íˆ¬ì•½ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
	        window.close();
	        opener.location.reload();
	    })
	    .catch(err => alert(err.message));
	}
	
	//ë³µì•½ì§€ë„ ì¶œë ¥
	function downloadPdf() { 
	    const element = document.body;

	    const opt = {
	        filename: 'medication_guide.pdf',
	        image: { type: 'jpeg', quality: 0.98 },
	        html2canvas: { scale: 2 },
	        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
	    };

	    html2pdf().set(opt).from(element).save();
	}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

    <title>MediCare</title>
	<!-- 구글 폰트 링크 -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>/* 전체 리셋 및 기본 배경 */
	body {
	    margin: 0;
	    padding: 0;
	    font-family: 'Inter', '맑은 고딕', sans-serif;
	    background-color: #D5DDED; /* 이미지의 연한 푸른색 배경 */
	
	}
	
	
	/* 상단 헤더 배경 및 레이아웃 */
	.top-bar {
	    display: flex;
	    justify-content: space-between;
	    align-items: center;
	    padding: 5px 15px;
	    background-color: #ffffff; /* 흰색 배경 */
	    font-size: 14px;
	}
	
	/* 상단 헤더 텍스트 스타일 */
	.user-info {
	    color: #555;
	}
	
	/* 상단 헤더 -> 로그아웃 출근 퇴근 배열 */
	.action-buttons {
	    display: flex;
	    gap: 5px;
	}
	
	/* 상단 헤더 -> 로그아웃 출근 퇴근 공통스타일 */
	.action-buttons button {
	    padding: 4px 12px;
	    border: none;
	    border-radius: 4px;
	    cursor: pointer;
	    font-weight: 500;
	    font-size: 13px;
		border: 1px solid #7B7B7B;
	}
	
	/* 상단 헤더 -> 로그아웃 버튼 스타일 */
	.btn-logout {
		padding: 4px 12px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		font-weight: 500;
		font-size: 13px;
		color: white;
	    background-color: #FF4B4B;
		border: 1px solid #7B7B7B;
	}
	
	/* 상단 헤더 -> 출근 버튼 스타일 */
	.time-in {
	    background-color: var(--ui-panel-title);
		color:#ffffff;
	}
	
	/* 상단 헤더 -> 퇴근 버튼 스타일 */
	.time-out {
	    background-color: #D5DDED;
	    color: #000;
	}

	/* 중앙 헤더 -> 카테고리 배치 */
	.tab-list {
	    list-style: none; /* 앞에 점 제거*/
	    margin: 0;
	    padding: 0;
	    display: flex; /* 가로 나열*/
	}
	
	/* 중앙 헤더 -> 카테고리 요소 스타일 */
	.tab-item a {
	    display: block;
	    padding: 8px 15px;
	    text-decoration: none; /* 카테고리 밑줄 제거*/
	    color: #333; /* 글자 색*/
	    background-color: transparent; /* 배경색 투명 (nav-tabs의 배경색 사용) */
	    border: none; /* 경계선 제거 */
	    font-size: 14px;
	    font-weight: normal;
	}
	
	/* 2. 중앙 헤더 공통 ⭐ */
	.nav-tabs {
		background-color: #D5DDED; /* 이미지의 균일한 하늘색 배경 */
		padding: 0 10px;
	}
	
	/* 중앙 헤더 -> 카테고리 호버 */
	.tab-item:hover {
	    background-color: rgba(255, 255, 255, 0.3); /* 마지막 숫자가 컬러 세기 정도*/
	}
	
	/* 중앙 헤더 -> 선택된 카테고리 스타일 */
	.tab-item.active a {
	    color: #333; /* 텍스트 색상은 검은색 유지 (사진처럼) */
	    font-weight: 550;
	    /* 하단에 진한 파란색 선으로 강조 */
	}
	
	
	/* 3. 하단 헤더  */
	.sub-menu {
	    background-color: #BACCFF; /* 흰색 배경 */
	    padding: 5px 15px; /* 패딩을 줄여서 메뉴와 붙은 느낌 */
	    font-size: 14px;
	    color: #555;
		font-weight: 530;
	    /* 이미지처럼 '금일 진료 리스트' 텍스트를 진하게 표현 */
	}
	
	/* 컨텐츠 영역 (전체 배경색 확인용) */
	.content-area {
	    min-height: 500px; /* 임시 높이 */
	    background-color: #D5DDED; /* 나머지 화면을 덮는 배경색 */
	}
	
	/* 금일 진료 리스트 */
	#table{ /* div 영역 및 레이아웃 */
		margin:5px;
		margin-left: auto;
		margin-right: auto;
	}
	
	table { 
	    width: 90%; /* 너비 */
	    border-collapse: collapse; /* 표 한줄로 합치기 */
	    font-size: 14px;
	    background-color: white;
		
	 }

	 th, td {
	     border: 1px solid #7B7B7B; /* 칸 당 테두리*/
	     padding: 0;
		 height: 25px; /* 원하는 셀 높이 */
	     text-align: center; /* 텍스트 중앙 */
	 }

	 th {
	     background-color: var(--ui-panel-title); 
		 font-weight: normal; /* 글씨 굵기 보통으로 */
		 color: rgb(31, 31, 31);
	 }

	 tr:nth-child(even) {
	     background-color: #ffffffff;
	 }

	 /* 접수 시작 */
	 .first {
		 display: flex;             /* flex로 변환 */
		 justify-content: center;   /* 가로 중앙 */
		 align-items: center;       /* 세로 중앙 */
		 width: 100%;               /* 가로 꽉 */
		 height: 100%;              /* 세로 꽉 */
		 box-sizing: border-box;    /* 패딩 포함 계산 */
		 border: none;
		 background-color: #00FF08;
		 color: black;
		 cursor: pointer;
		 font-size: 14px;
		 font-weight: 300; /* 글씨 굵기 보통으로 */
		 text-decoration: none;
	  }

	  .container {
  	      display: grid;
  	      grid-template-columns: 1fr 1fr; /* 왼쪽, 오른쪽 */
  	      gap: 5px;
  	      height: calc(100vh - 130px); /* 상단+중앙+하단 헤더 제외 */
  	      padding: 5px;
   	      box-sizing: border-box;
    	  }

	  .item-scroll {
	      width: 90%;
	      margin: 5px auto;
	      max-height: 520px;
	      overflow-y: auto;
	      border: 1px solid #7B7B7B;
	      background-color: #ffffff;
	  }

	  .item-scroll table {
	      width: 100%;
	  }

	  .lot-scroll {
	      width: 90%;
	      margin: 5px auto;
	      max-height: 520px;
	      overflow-y: auto;
	      border: 1px solid #7B7B7B;
	      background-color: #ffffff;
	  }

	  .lot-scroll table {
	      width: 100%;
	  }

    	.item{
  		grid-column:1/2 ;
  	}
	
	.lot{
		grid-column:2/3 ;
	}
	
	.popup-form {
	    position: fixed;
	    top: 50%;
	    left: 50%;
	    transform: translate(-50%, -50%);
	    background: #fff;
	    border: 1px solid #7B7B7B;
	    padding: 20px;
	    z-index: 1000;
	    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
	}

	.popup-form form label {
	    display: inline-block;
	    width: 100px;
	}

	.popup-form form input, .popup-form form select {
	    margin-bottom: 10px;
	}

	.popup-form h3 {
	    margin-top: 0;
	}
	
	#requestModal {
	    display: none;
	    position: fixed;
	    top: 50%;
	    left: 50%;
	    transform: translate(-50%, -50%);
	    z-index: 9999;
	    background-color: white;
	    border: 1px solid #333;
	    padding: 15px;
	    box-shadow: 0 0 10px rgba(0,0,0,0.5);
	}

	
    </style>
<link rel="stylesheet" th:href="@{/css/common-base.css}">
	
</head>
	<div th:replace="~{fragments/pharm-header :: header(title='전체 재고 현황', activeTab='pharmItem')}"></div>
<body>

	<!-- 콘텐츠 영역 시작-->
    <div class="content-area">
		<div class="container">
			<div class="item">
			<!-- 상태 필터링 -->
				<div style="width:90%; margin: 5px auto; display:flex; justify-content:center;">
					<form method="get" th:action="@{/pharm/pharmItem}" style="display:flex; gap:8px;">
					    <!-- 상태 -->
					    <select name="status">
					        <option value="">전체 상태</option>
					        <option th:each="s : ${statusList}"
					                th:value="${s}"
					                th:text="${s}"
					                th:selected="${s == selectedStatus}">
					        </option>
					    </select>

					    <!-- 키워드 -->
					    <input type="text" name="keyword"
					           placeholder="품목코드 / 품목명"
					           th:value="${keyword}"/>

					    <button type="submit">검색</button>
					</form>
				</div>

				<div class="section-title" style="width:90%; margin:5px auto 0;">&#51116;&#44256; &#47785;&#47197;</div>
				<!-- 금일 진료 리스트 -->
				<div class="item-scroll">
				<table id="requestTable" border="1">
					<thead>
					    <tr>
					        <th>품목코드</th>
					        <th>종류</th>
					        <th>품목명</th>
					        <th>현재고</th>
					        <th>최소재고</th>
							<th>가용재고</th>
							<th>상태</th>
							<th>상세</th>
					    </tr>
					</thead>

					<tbody>
					<tr th:if="${itemList.size() == 0}">
					        <td colspan="10" class="no-data" style="height: 500px;">물품을 등록해주세요.</td>
					    </tr>

						<tr th:each="item : ${itemList}">
							<td th:text="${item.item_code}"></td>
			                <td th:text="${item.item_type}"></td>
							
			                <td th:text="${item.name}"></td>
			                <td th:text="${#numbers.formatInteger(item.current_stock,0)}"></td>
			                <td th:text="${#numbers.formatInteger(item.safety_stock,0)}"></td>
			                <td th:text="${#numbers.formatInteger(item.available_stock,0)}"></td>
			                <td th:text="${item.status}"></td>
			                <td>
								<button type="button"
								        class="show-lot-btn"
								        th:data-item-code="${item.item_code}">
								    상세보기
								</button>
			                </td>
						</tr>

						<tr th:if="${itemList.size() > 0}"
						    th:each="i : ${#numbers.sequence(itemList.size() + 1, 20)}">
						    <td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td>
						    <td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td>
							<td>&nbsp;</td><td>&nbsp;</td>
						</tr>
					</tbody>
				</table>
				</div>
		</div>
		<div class="lot">
		    <div class="lotList">
				<div style="width:90%; margin:5px auto; display:flex; justify-content:center; gap:5px;">
		        <button id="purchaseRequestBtn" style="display:none;">불출요청</button>
		        <button id="stockInBtn" style="display:none;">입고등록</button>
				<input type="text" id="lotSearchInput" placeholder="로트코드 검색">
				<button type="button" id="lotSearchBtn">검색</button>
				</div>
				<div class="section-title" style="width:90%; margin:5px auto 0;">입고 목록</div>
		        
				<div class="item-scroll">
		        <table id="lotTable" border="1">
		            <thead>

		                <tr>
		                    <th>로트코드</th>
		                    <th>입고일</th>
		                    <th>위치</th>
		                    <th>유통기한</th>
		                    <th>수량</th>
		                    <th>상태</th>
		                    <th>폐기</th>
		                    <th>수량조정</th>
		                </tr>
		            </thead>
		            <tbody id="lotTableBody"></tbody>
		        </table>
				</div>
		    </div>
		</div>

		
		<!-- 신규등록요청 폼 (초기에는 숨김) -->
		<div id="purchaseForm" class="popup-form" style="display:none;">
		    <h3>신규등록 요청</h3>
		    <form id="newItemForm">
		        <label>분류:</label>
		        <select name="item_type" required>
		            <option value="">선택</option>
		            <option value="약품">약품</option>
		            <option value="재료">재료</option>
		            <option value="자재">기타</option>
		        </select><br>

		        <label>물품명:</label>
		        <input type="text" name="name" required><br>

				<label>일반 물품 코드:</label>
		        <input type="text" name="code" required><br>
				
				<label>제조사 물품 코드:</label>
				<input type="text" name="madecode" required><br>


		        <label>기본단위:</label>
		        <input type="text" name="base_unit" required><br>

		        <label>포장단위명:</label>
		        <input type="text" name="pack_name" required><br>

		        <label>포장단위수량:</label>
		        <input type="number" name="pack_quantity" min="1" required><br>

		        <label>안전재고:</label>
		        <input type="number" name="safety_stock" min="0" required><br>

		        <label>기본 단가:</label>
		        <input type="number" name="base_price" min="0" step="0.01" required><br>

				<label>과세 여부:</label>
				<select name="taxable" required>
				    <option value="">선택</option>
				    <option value="true">과세</option>
				    <option value="false">비과세</option>
				</select><br>

				
		        <button type="submit">요청</button>
		        <button type="button" class="closeBtn">닫기</button>
		    </form>
		</div>

		<!-- 입고등록 폼 (초기에는 숨김) -->
		<div id="stockInForm" class="popup-form" style="display:none;">
		    <h3>입고등록</h3>
		    <form id="stockInFormElement">
				<label>입고요청 선택</label>
				<select id="stockMoveSelect" name="stock_move_id" required>
				    <option value="">선택하세요</option>
				</select><br>
				
				<input type="hidden" name="item_code" id="stockInItemCode">
		        <label>로트코드</label>
		        <input type="text" name="lot_code" required><br>

		        <label>입고일</label>
		        <input type="date" name="created_at" required><br>

				<label>위치</label>
				<select name="location" id="locationSelect" required></select><br>
				
		        <label>구간</label>
		        <select name="zone" id="zoneSelect" required></select><br>

		        <label>유통기한</label>
		        <input type="date" name="expiry_date"><br>

		        <label>수량</label>
		        <input type="number" name="quantity" min="1" required><br>

				<label>총액</label>
				<input type="text" id="totalPrice" readonly><br>

				
		        <button type="submit">입고등록</button>
		        <button type="button" class="closeBtn">닫기</button>
		    </form>
		</div>
		
		<!-- 폐기 모달 -->
		<div id="discardForm" class="popup-form" style="display:none;">
		  <form id="discardFormElement">
		    <h3>폐기 사유 선택</h3>
		    <label>사유:</label>
		      <select id="discardReason">
		        <option value="">선택</option>
		        <option value="유통기한 만료">유통기한 만료</option>
		        <option value="파손">파손</option>
		        <option value="오염">오염</option>
		        <option value="회수">회수</option>
		        <option value="기타">기타</option>
		      </select><br>
		    <label>상세 사유 (기타일 때 필수):</label>
		      <textarea id="discardDetail" placeholder="기타 사유 입력"></textarea><br>
		    <button type="submit" id="discardSubmit">확인</button>
		    <button type="button" class="closeBtn">취소</button>
		  </form>
		</div>

		<!-- 수량조정 모달 -->
		<div id="adjustForm" class="popup-form" style="display:none;">
		  <form id="adjustFormElement">
		    <h3>수량 조정</h3>
		    <label>유형:</label>
		      <select id="adjustType">
		        <option value="">선택</option>
		        <option value="증가">증가</option>
		        <option value="감소">감소</option>
		      </select><br>
		    <label>수량:</label>
		      <input type="number" id="adjustQty" min="1"><br>
		    <label>사유:</label>
		      <select id="adjustReason">
		        <option value="">선택</option>
		        <option value="실사오차">실사오차</option>
		        <option value="전산오류">전산오류</option>
		        <option value="반품">반품</option>
		        <option value="기타">기타</option>
		      </select><br>
		    <label>상세사유:</label>
		      <textarea id="adjustDetail" placeholder="기타 사유 입력"></textarea><br>
		    <button type="submit" id="adjustSubmit">확인</button>
		    <button type="button" class="closeBtn">취소</button>
			</form>
		</div>
		
		<!-- 모달 -->
		<div id="requestModal" style="display:none; border:1px solid #333; padding:15px;">
		    <h3>불출 요청</h3>

		    <div>
		        포장 단위 요청 수량
		        <input type="number" id="reqQtyInput" min="1" value="1">
		        <span id="packUnitName"></span>
		    </div>

			<div style="margin-top:8px; color:#333;">
			    기본 단위 요청 수량:
			    <strong>
			        <span id="totalReqQty">0</span>
			    </strong>
			</div>
			
		    <div>
		        사유(선택)
		        <input type="text" id="reqReasonInput" maxlength="255">
		    </div>

		    <button id="submitRequestBtn">불출요청 등록</button>
		    <button onclick="document.getElementById('requestModal').style.display='none'">취소</button>
		</div>
	</div>
	</div>
	<script>
		document.addEventListener("DOMContentLoaded", () => {
		    const lotListDiv = document.querySelector(".lotList");
		    const lotTableBody = document.getElementById("lotTableBody");
		
		    const purchaseBtn = document.getElementById("purchaseRequestBtn");
		    const stockBtn = document.getElementById("stockInBtn");
		
		    const purchaseForm = document.getElementById("requestModal");
		    const stockForm = document.getElementById("stockInForm");
		    const discardForm = document.getElementById("discardForm");
		    const adjustForm = document.getElementById("adjustForm");
		
		    const newItemForm = document.getElementById("newItemForm");
		
		    let selectedStockId = null;
		    let selectedItemCode = null;
		    let unitPrice = 0;
		
		    const qtyInput = document.querySelector('input[name="quantity"]');
		    const totalPriceInput = document.getElementById("totalPrice");
		
			const lotSearchInput = document.getElementById("lotSearchInput"); //로트코드 검색창
			const lotSearchBtn = document.getElementById("lotSearchBtn"); //검색버튼

			let packUnitQty = 0;
			
			const reqQtyInput = document.getElementById("reqQtyInput");
			const totalReqQtyEl = document.getElementById("totalReqQty");
			const packUnitNameEl = document.getElementById("packUnitName");
			
			const stockMoveSelect = document.getElementById("stockMoveSelect");

			stockMoveSelect.addEventListener("change", function () {
			    const selectedOption = this.options[this.selectedIndex];
			    if (!selectedOption || !selectedOption.dataset.qty) return;
	
			    const reqQty = Number(selectedOption.dataset.qty);
	
			    // 수량 자동 입력
			    qtyInput.value = reqQty;
	
			    // 총액도 같이 계산
			    totalPriceInput.value = (unitPrice * reqQty).toLocaleString();
			});

			
			// 총 수량 계산 함수
			function updateTotalReqQty() {
			    const packCount = Number(reqQtyInput.value || 0);
			    const total = packCount * packUnitQty;
			    totalReqQtyEl.textContent = total.toLocaleString();
			}
			reqQtyInput.addEventListener("input", updateTotalReqQty);
			
		    qtyInput.addEventListener("input", () => {
		        const qty = parseInt(qtyInput.value || 0);
		        totalPriceInput.value = (unitPrice * qty).toLocaleString();
		    });

		    purchaseBtn.addEventListener("click", (e) => {
		        e.preventDefault();
		        purchaseForm.style.display = "block";
				
				// 포장 단위 수량 조회
			    fetch(`/pharm/item/${selectedItemCode}/pack-unit-qty`)
			        .then(res => res.json())
			        .then(qty => {
			            packUnitQty = Number(qty);
			            packUnitNameEl.textContent = `(1포장 = ${packUnitQty}개)`;
			            updateTotalReqQty();
			        })
			        .catch(err => {
			            console.error(err);
			            packUnitQty = 0;
			            packUnitNameEl.textContent = "";
			            totalReqQtyEl.textContent = "0";
			        });
		    });

		    // LOT 렌더 함수
		    function renderLotList(data) {
		        lotTableBody.innerHTML = "";
		        if (!data || data.length === 0) {
		            lotTableBody.innerHTML = `
		                <tr>
		                    <td colspan="9" style="text-align:center; height:200px;">재고가 없습니다.</td>
		                </tr>
		            `;
					purchaseBtn.style.display="none";
		            stockBtn.style.display = "none"; // LOT 없으면 입고 버튼 숨김
		        } else {
		            data.forEach(lot => {
		                const tr = document.createElement("tr");
		                tr.innerHTML = `
		                    <td>${lot.lot_code}</td>
		                    <td>${lot.created_at ?? "-"}</td>
		                    <td>${lot.location}</td>
		                    <td>${lot.expiry_date ?? "-"}</td>
		                    <td>${lot.quantity}</td>
		                    <td>${lot.status}</td>
		                    <td><button type="button" class="discardBtn" data-stock-id="${lot.stock_id}">폐기</button></td>
		                    <td><button type="button" class="adjustBtn" data-stock-id="${lot.stock_id}">수량조정</button></td>
		                `;
		                lotTableBody.appendChild(tr);
		            });
		        }
		        lotListDiv.style.display = "block";
		    }

		    // 초기 전체 LOT
		    fetch("/pharm/lots")
		        .then(res => res.json())
		        .then(data => renderLotList(data))
		        .catch(err => { console.error(err); alert("전체 LOT 데이터를 불러오지 못했습니다."); });

		    // Location & Zone
		    fetch("/pharm/warehouse/locations")
		        .then(res => res.json())
		        .then(data => {
		            const locationSelect = document.getElementById("locationSelect");
		            locationSelect.innerHTML = '<option value="">선택</option>';
		            data.forEach(loc => locationSelect.innerHTML += `<option value="${loc}">${loc}</option>`);
		        });

		    document.getElementById("locationSelect").addEventListener("change", function () {
		        const location = this.value;
		        const zoneSelect = document.getElementById("zoneSelect");
		        zoneSelect.innerHTML = '<option value="">선택</option>';
		        if (!location) return;
		        fetch(`/pharm/warehouse/zones?location=${location}`)
		            .then(res => res.json())
		            .then(data => data.forEach(zone => zoneSelect.innerHTML += `<option value="${zone}">${zone}</option>`));
		    });

		    // 이벤트 위임: 폐기, 수량조정
		    lotTableBody.addEventListener("click", (e) => {
		        if (e.target.classList.contains("discardBtn")) {
		            selectedStockId = e.target.dataset.stockId;
		            discardForm.style.display = "block";
		        }
		        if (e.target.classList.contains("adjustBtn")) {
		            selectedStockId = e.target.dataset.stockId;
		            adjustForm.style.display = "block";
		        }
		    });

		    // 닫기 버튼
		    document.querySelectorAll(".closeBtn").forEach(btn => {
		        btn.addEventListener("click", (e) => {
		            e.target.closest(".popup-form").style.display = "none";
		        });
		    });


		    // 상세보기 클릭
		    document.querySelectorAll(".show-lot-btn").forEach(btn => {
		        btn.addEventListener("click", () => {
		            const itemCode = btn.dataset.itemCode;
		            selectedItemCode = itemCode;
		            document.getElementById("stockInItemCode").value = itemCode;

		            // 단가 조회
		            fetch(`/pharm/item/${itemCode}/price`)
		                .then(res => res.json())
		                .then(price => { unitPrice = Number(price); totalPriceInput.value = "0"; })
		                .catch(err => { console.error(err); unitPrice = 0; });

		            // LOT 조회
		            fetch(`/pharm/item/${itemCode}/lots`)
		                .then(res => res.json())
		                .then(data => {
		                    renderLotList(data);
							purchaseBtn.style.display = "inline-block";
							stockBtn.style.display = "inline-block";
		                })
		                .catch(err => { console.error(err); alert("LOT 데이터를 불러오지 못했습니다."); });
		        });
		    });


			// 입고등록 버튼 클릭 -> 폼 열기
			if (stockBtn) {
			    stockBtn.addEventListener("click", () => {
					if(!selectedItemCode) { alert("먼저 상세보기에서 항목을 선택하세요."); return; }
		
		            if(stockForm) stockForm.style.display = "block";
		            const stockInItemCode = document.getElementById("stockInItemCode");
		            if(stockInItemCode) stockInItemCode.value = selectedItemCode;
		
		            const qty = document.querySelector('input[name="quantity"]');
		            if(qty) qty.value = "";
		            if(totalPriceInput) totalPriceInput.value = "0";
		
			        // 입고요청 목록 불러오기
			        loadStockInRequests();
			    });
			}
		
			// 입고요청 목록 불러오기
		    function loadStockInRequests() {
		        if(!selectedItemCode) { console.warn("itemCode가 선택되지 않음"); return; }
		        const select = document.getElementById("stockMoveSelect");
		        if(!select) { console.error("stockMoveSelect 요소를 찾을 수 없음"); return; }
		        select.innerHTML = '<option value="">선택하세요</option>';
		
		        fetch(`/pharm/stock/in/requests?itemCode=${encodeURIComponent(selectedItemCode)}`)
		            .then(res => res.json())
		            .then(list => {
		                list.forEach(item => {
		                    const opt = document.createElement("option");
		                    opt.value = item.stockMoveId;
		                    opt.textContent = `${item.itemName} / ${item.requestQty} / ${item.movedAt}`;
							opt.dataset.qty = item.requestQty;
							select.appendChild(opt);
		                });
		            })
		            .catch(err => console.error(err));
		    }
			// 불출요청 등록
		    document.getElementById("submitRequestBtn").addEventListener("click", () => {
		        const qty = Number(document.getElementById("reqQtyInput").value);
		        const note = document.getElementById("reqReasonInput").value;
		
		        if (!selectedItemCode) { alert("항목을 선택하세요"); return; }
		        if (qty <= 0) { alert("수량을 입력하세요"); return; }
		
		        fetch("/pharm/issue-request", {
		            method: "POST",
		            headers: { "Content-Type": "application/json" },
		            body: JSON.stringify({ itemCode: selectedItemCode, qty, note })
		        })
		        .then(res => res.ok ? res.text() : Promise.reject("요청 실패"))
		        .then(msg => { alert("불출 요청이 등록되었습니다!"); document.getElementById("requestModal").style.display="none"; })
		        .catch(err => { console.error(err); alert("오류 발생"); });
		    });

		    // 폐기 등록
		    document.getElementById("discardFormElement").addEventListener("submit", (e) => {
		        e.preventDefault();
		        const reason = document.getElementById("discardReason").value;
		        const detail = document.getElementById("discardDetail").value;
		        if (!reason) return alert("폐기 사유를 선택하세요");
		        if (reason === "기타" && !detail) return alert("기타 사유를 입력하세요");

		        const params = new URLSearchParams();
		        params.append("reason", reason);
		        if (detail) params.append("detail", detail);

		        fetch(`/pharm/stock/${selectedStockId}/discard`, { method: "POST", body: params })
		            .then(res => { if(!res.ok) throw new Error(); return res.text(); })
		            .then(msg => {
		                alert(msg);
		                discardForm.style.display = "none";
		                if (selectedItemCode) fetch(`/pharm/item/${selectedItemCode}/lots`)
		                    .then(res => res.json())
		                    .then(data => renderLotList(data));
		            })
		            .catch(() => alert("폐기 중 오류 발생"));
		    });

		    // 수량 조정
		    document.getElementById("adjustFormElement").addEventListener("submit", (e) => {
		        e.preventDefault();
		        const type = document.getElementById("adjustType").value;
		        const qty = document.getElementById("adjustQty").value;
		        const reason = document.getElementById("adjustReason").value;
		        const detail = document.getElementById("adjustDetail").value;
		        if (!type || !qty || qty <= 0) return alert("유형과 수량을 입력하세요");

		        const params = new URLSearchParams();
		        params.append("type", type);
		        params.append("quantity", qty);
		        if (reason) params.append("reason", reason);
		        if (detail) params.append("detail", detail);

		        fetch(`/pharm/stock/${selectedStockId}/adjust`, { method: "POST", body: params })
		            .then(res => { if(!res.ok) throw new Error(); return res.text(); })
		            .then(msg => {
		                alert(msg);
		                adjustForm.style.display = "none";
		                if (selectedItemCode) fetch(`/pharm/item/${selectedItemCode}/lots`)
		                    .then(res => res.json())
		                    .then(data => renderLotList(data));
		            })
		            .catch(() => alert("수량 조정 중 오류 발생"));
		    });
			
			// 입고등록
		    document.getElementById("stockInFormElement").addEventListener("submit", function(e){
		        e.preventDefault();
				const selectedOption = stockMoveSelect.options[stockMoveSelect.selectedIndex];
			    const reqQty = Number(selectedOption?.dataset.qty);
			    const inputQty = Number(qtyInput.value);

			    if (reqQty !== inputQty) {
			        alert(`입고 수량은 요청 수량(${reqQty})과 동일해야 합니다.`);
			        return;
			    }
		        const data = new FormData(this);
		        fetch("/pharm/stock/in", { method:"POST", body:data })
		        .then(res => res.ok ? res.text() : Promise.reject("입고 실패"))
		        .then(msg => { alert(msg); this.reset(); stockForm.style.display="none"; loadLotList(document.getElementById("stockInItemCode").value); })
		        .catch(err => { console.error(err); alert("입고 중 오류 발생"); });
		    });
			
			// LOT 테이블 불러오기
		    function loadLotList(itemCode) {
		        fetch(`/pharm/item/${itemCode}/lots`)
		            .then(res => res.json())
		            .then(data => {
						if(!lotTableBody) return;
		                lotTableBody.innerHTML = "";
		                if(!lotListDiv) return;
		                lotListDiv.style.display = "block";
		
		                if (data.length === 0) {
		                    lotTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; height:200px;">재고가 없습니다.</td></tr>`;
		                    return;
		                }
		
		                data.forEach(lot => {
		                    const tr = document.createElement("tr");
		                    tr.innerHTML = `
		                        <td>${lot.lot_code}</td>
		                        <td>${lot.created_at ?? "-"}</td>
		                        <td>${lot.location}</td>
		                        <td>${lot.expiry_date ?? "-"}</td>
		                        <td>${lot.quantity}</td>
		                        <td>${lot.status}</td>
		                        <td><button class="discardBtn" data-stock-id="${lot.stock_id}">폐기</button></td>
		                        <td><button class="adjustBtn" data-stock-id="${lot.stock_id}">수량조정</button></td>
		                    `;
		                    lotTableBody.appendChild(tr);
		                });
		            })
		            .catch(err => { console.error(err); alert("LOT 데이터를 불러오지 못했습니다."); });
		    }
			
			lotSearchBtn.addEventListener("click", () => {
			    const keyword = lotSearchInput.value.toLowerCase();
			    const rows = lotTableBody.querySelectorAll("tr");

			    rows.forEach(row => {
			        const lotCode = row.querySelector("td:first-child")?.textContent.toLowerCase() || "";
			        row.style.display = lotCode.includes(keyword) ? "" : "none";
			    });
			});

		});
		</script>
</body>
</html>

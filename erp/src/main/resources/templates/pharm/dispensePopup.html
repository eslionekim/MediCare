<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>조제 상세 내역</title>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --point-color: #879BD5;
        --bg-main: #ffffff;
        --border-color: #eee;
        --text-dark: #333;
        --text-gray: #777;
    }

    body {
        font-family: 'Pretendard', sans-serif;
        background-color: var(--bg-main);
        margin: 0;
        padding: 40px;
        color: var(--text-dark);
    }

    /* --- 헤더 --- */
    h3 {
        font-size: 28px;
        color: var(--point-color);
        margin-bottom: 30px;
        font-weight: 700;
        border-left: 5px solid var(--point-color);
        padding-left: 15px;
    }

    /* --- 환자 정보 (박스 제거, 깔끔한 라인 형태) --- */
    .patient-info-area {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        padding-bottom: 30px;
        border-bottom: 2px solid #f4f4f4;
        margin-bottom: 30px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        min-width: 150px;
    }

    .info-item label {
        font-size: 13px;
        color: var(--text-gray);
        margin-bottom: 5px;
    }

    .info-item span {
        font-size: 17px;
        font-weight: 600;
    }

    /* --- 테이블 (테두리 및 그림자 제거) --- */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    th {
        text-align: left;
        padding: 15px 10px;
        border-bottom: 2px solid var(--point-color);
        color: var(--point-color);
        font-size: 14px;
        text-transform: uppercase;
    }

    td {
        padding: 20px 10px;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }

    /* 행 마우스 오버 시 가벼운 강조 */
    tbody tr:hover {
        background-color: #f9faff;
    }

    /* --- 입력창 & 버튼 (디자인 포인트 컬러 적용) --- */
    .input-flat {
        border: 1px solid #ddd;
        padding: 8px 12px;
        border-radius: 4px;
        outline-color: var(--point-color);
    }

    .btn {
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: 0.2s;
    }

    .btn-verify {
        background-color: #fff;
        border: 1px solid var(--point-color);
        color: var(--point-color);
    }

    .btn-verify:hover {
        background-color: var(--point-color);
        color: #fff;
    }

    .btn-complete {
        background-color: var(--point-color);
        color: #fff;
        padding: 15px 50px;
        font-size: 16px;
    }

    .btn-complete:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .btn-close {
        background-color: #f4f4f4;
        color: #666;
        padding: 15px 30px;
        font-size: 16px;
    }

    /* --- 상태 표시 --- */
    .status-badge {
        font-weight: 700;
        font-size: 13px;
    }
    .pending { color: #ff5f5f; }
    .completed { color: var(--point-color); }

    /* --- LOT 리스트 스타일 --- */
    .lot-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
        font-size: 13px;
    }

    .lot-input {
        width: 60px;
        text-align: right;
        margin-left: 10px;
    }

    .footer-bar {
        margin-top: 40px;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
    }
</style>
</head>
<body>

<h3>조제 관리 상세</h3>

<div class="patient-info-area">
    <div class="info-item">
        <label>환자명</label>
        <span th:text="${popup.patientName}">-</span>
    </div>
    <div class="info-item">
        <label>생년월일</label>
        <span th:text="${popup.birth}">-</span>
    </div>
    <div class="info-item">
        <label>진단명</label>
        <span th:text="${popup.diagnosis}">-</span>
    </div>
    <div class="info-item">
        <label>담당 의료진</label>
        <span th:text="${popup.name} + ' (' + ${popup.departmentName} + ')'">-</span>
    </div>
    <div class="info-item">
        <label>최근 내원</label>
        <span th:text="${popup.recentVisitAt}">-</span>
    </div>
</div>

<table>
    <thead>
        <tr>
            <th style="width: 20%;">약품명 / 코드</th>
            <th style="width: 15%;">처방용법</th>
            <th style="width: 20%;">약품 검증 스캔</th>
            <th style="width: 30%;">입고리스트</th>
            <th style="width: 15%; text-align: center;">상태</th>
        </tr>
    </thead>
    <tbody id="dispenseItems">
        <tr th:each="i : ${popup.items}">
            <input type="hidden" id="prescriptionId" th:value="${popup.prescriptionId}">
            
            <td>
                <b th:text="${i.itemName}" style="font-size: 16px;"></b><br>
                <small style="color: var(--text-gray);" th:text="${i.itemCode}"></small>
            </td>

            <td th:text="${i.dosage}"></td>

            <td>
                <input type="text" class="input-flat itemCodeInput" placeholder="코드 입력" style="width: 100px;">
                <button type="button" class="btn btn-verify" th:data-item-code="${i.itemCode}" onclick="checkItemCode(this)">검증</button>
            </td>

            <td>
                <div th:each="lot : ${i.lots}" class="lot-row">
                    <span>
                        <input type="hidden" name="stockId" th:value="${lot.stockId}">
                        <span th:text="${lot.lotCode}"></span>
                        <small style="color:#999;"> (기한: [[${lot.expiryDate}]])</small>
						재고 <span th:text="${lot.quantity.intValue()}"></span>
                    </span>
                    <input type="number" class="input-flat lot-input lotQtyInput" placeholder="0" th:max="${lot.quantity.intValue()}">
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button type="button" class="btn btn-verify" th:if="${i.lots.size() > 0}" 
                            th:data-required-qty="${i.requiredQty.intValue()}" onclick="checkLotQty(this)">수량 확인</button>
                </div>
            </td>

            <td style="text-align: center;">
                <span class="status-badge pending status">미완료</span>
            </td>
        </tr>
    </tbody>
</table>

<div class="footer-bar">
    <button type="button" class="btn btn-close" onclick="deleteAndClose()">취소</button>
    <button id="completeBtn" type="button" class="btn btn-complete" onclick="completeDispense()" disabled>조제 완료 및 저장</button>
</div>

<script>
    // 기능 로직은 동일하게 유지 (상태 텍스트만 맞춤 수정)
    function checkItemCode(btn){
        const inputValue = btn.previousElementSibling.value;
        const correctCode = btn.dataset.itemCode;

        if(inputValue === correctCode){
            btn.dataset.ok = "true";
            btn.disabled = true;
            btn.previousElementSibling.readOnly = true;
            btn.style.backgroundColor = "#879BD5";
            btn.style.color = "#fff";
            checkRowComplete(btn.closest("tr"));
        } else {
            alert("코드가 일치하지 않습니다.");
        }
    }

    function checkLotQty(btn){
        const required = Number(btn.dataset.requiredQty);
        const inputs = btn.closest('td').querySelectorAll(".lotQtyInput");
        let sum = 0;
        inputs.forEach(input => sum += Number(input.value || 0));

        if(sum === required){
            btn.dataset.ok = "true";
            btn.disabled = true;
            inputs.forEach(input=>input.readOnly=true);
            btn.style.backgroundColor = "#879BD5";
            btn.style.color = "#fff";
            checkRowComplete(btn.closest("tr"));
        } else {
            alert("수량이 일치하지 않습니다. (현재: " + sum + " / 필요: " + required + ")");
        }
    }

    function checkRowComplete(tr){
        const codeOk = tr.querySelector("button[onclick^='checkItemCode']")?.dataset.ok==="true";
        const qtyOk = tr.querySelector("button[onclick^='checkLotQty']")?.dataset.ok==="true";

        if(codeOk && qtyOk){
            const statusTd = tr.querySelector(".status");
            statusTd.textContent="완료";
            statusTd.className="status-badge completed status";
        }
        checkAllRowsComplete();
    }

    function checkAllRowsComplete(){
        const allDone = Array.from(document.querySelectorAll(".status")).every(td=>td.textContent==="완료");
        document.getElementById("completeBtn").disabled = !allDone;
    }

    // ... (deleteAndClose, completeDispense 함수는 기존과 동일)
    function deleteAndClose(){
        const prescriptionId = document.getElementById("prescriptionId").value;
        fetch(`/dispense/${prescriptionId}`, {method:"DELETE"}).then(() => window.close());
    }

    function completeDispense(){
        const prescriptionId = document.getElementById("prescriptionId").value;
        const rows = document.querySelectorAll("#dispenseItems tr");
        const items = [];

        rows.forEach(row=>{
            const itemCode = row.querySelector(".itemCodeInput").value;
            const stockIds = row.querySelectorAll("input[name='stockId']");
            const qtyInputs = row.querySelectorAll(".lotQtyInput");
            const lots = [];
            for(let i=0;i<stockIds.length;i++){
                const qty = qtyInputs[i].value;
                if(qty && Number(qty)>0) lots.push({stockId:stockIds[i].value, quantity:qty});
            }
            items.push({itemCode:itemCode, lots:lots});
        });

        fetch(`/pharm/dispense/complete`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({prescriptionId, items})
        })
        .then(res => {
            if(res.ok) {
                alert("조제가 완료되었습니다.");
                window.close();
                if(window.opener) window.opener.location.reload();
            }
        });
    }
</script>

</body>
</html>